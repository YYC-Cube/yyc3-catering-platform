# 客户生命周期管理功能模块需求分析与设计文档

## 一、模块概述

### 1.1 模块简介
客户生命周期管理是YYC³餐饮管理系统的核心客户关系管理（CRM）功能，通过科学的客户阶段划分、智能流转规则、价值评估模型和预警机制，实现客户全生命周期的精细化管理，提升客户满意度和忠诚度。

### 1.2 业务价值
- 提升客户留存率15-20%
- 提高客户生命周期价值（CLV）25-30%
- 降低客户流失率10-15%
- 优化营销资源投入效率
- 实现个性化客户服务

### 1.3 目标用户
- 店长/运营经理：查看客户生命周期数据，制定营销策略
- 客服人员：接收智能提醒，进行客户关怀
- 营销人员：基于客户分群进行精准营销
- 管理层：监控客户生命周期指标，决策支持

## 二、客户生命周期阶段划分标准

### 2.1 生命周期阶段定义

#### 2.1.1 潜在客户（Potential）
**定义**：尚未完成首次消费的客户
**进入条件**：
- 注册账号但未下单
- 留存联系方式但未消费
- 参与营销活动但未转化

**退出条件**：
- 完成首次消费 → 转为新客户
- 超过30天未转化 → 转为流失潜在客户

**关键指标**：
- 注册天数
- 营销活动参与次数
- 互动频率

**运营策略**：
- 新客优惠券发放
- 引导下单流程优化
- 产品推荐

#### 2.1.2 新客户（New Customer）
**定义**：首次消费后30天内的客户
**进入条件**：
- 完成首次消费
- 消费金额 > 0

**退出条件**：
- 消费次数 ≥ 3次 且 消费天数 ≥ 7天 → 转为活跃客户
- 超过30天未再次消费 → 转为休眠客户

**关键指标**：
- 首次消费金额
- 首次消费时间
- 首次消费品类
- 复购意向

**运营策略**：
- 首单感谢
- 二次消费激励
- 产品使用指导

#### 2.1.3 活跃客户（Active）
**定义**：近30天内有消费且消费频次较高的客户
**进入条件**：
- 消费次数 ≥ 3次
- 消费天数 ≥ 7天
- 最近30天内有消费

**退出条件**：
- 消费次数 ≥ 10次 且 累计消费金额 ≥ 2000元 → 转为忠诚客户
- 超过30天未消费 → 转为休眠客户
- RFM评分下降 → 转为价值下降客户

**关键指标**：
- 消费频次（Frequency）
- 消费金额（Monetary）
- 最近消费时间（Recency）
- 消费品类多样性

**运营策略**：
- 会员等级提升
- 专属优惠
- 新品优先体验

#### 2.1.4 忠诚客户（Loyal）
**定义**：消费频次高、金额大、关系稳定的客户
**进入条件**：
- 消费次数 ≥ 10次
- 累计消费金额 ≥ 2000元
- 最近90天内有消费
- 满意度评分 ≥ 4.5

**退出条件**：
- 超过60天未消费 → 转为流失风险客户
- 消费频次下降 → 转为活跃客户

**关键指标**：
- 累计消费金额
- 消费频次
- 客户满意度
- 推荐意愿

**运营策略**：
- VIP专属服务
- 生日关怀
- 定制化服务
- 积分奖励

#### 2.1.5 休眠客户（Dormant）
**定义**：曾经消费但近期未消费的客户
**进入条件**：
- 活跃客户超过30天未消费
- 新客户超过30天未再次消费
- 忠诚客户超过60天未消费

**退出条件**：
- 重新消费 → 转为活跃客户
- 超过90天未消费 → 转为流失客户

**关键指标**：
- 休眠天数
- 历史消费频次
- 历史消费金额
- 唤醒难度

**运营策略**：
- 唤醒优惠券
- 个性化推荐
- 主动关怀电话

#### 2.1.6 流失客户（Churned）
**定义**：超过90天未消费且无互动的客户
**进入条件**：
- 休眠客户超过90天未消费
- 多次唤醒尝试失败

**退出条件**：
- 重新消费 → 转为新客户（重新计算生命周期）

**关键指标**：
- 流失天数
- 流失原因
- 挽回成本

**运营策略**：
- 流失原因调研
- 重新获取策略
- 防止再次流失

### 2.2 客户价值等级划分

#### 2.2.1 普通客户（Regular）
- RFM评分：1-3分
- 消费频次：1-3次/月
- 消费金额：< 500元/月

#### 2.2.2 会员客户（Member）
- RFM评分：4-6分
- 消费频次：4-6次/月
- 消费金额：500-1000元/月

#### 2.2.3 VIP客户（VIP）
- RFM评分：7-9分
- 消费频次：≥ 7次/月
- 消费金额：≥ 1000元/月

### 2.3 客户分群维度

#### 2.3.1 高价值客户
- 累计消费金额前20%
- 消费频次前20%
- RFM评分 ≥ 7分

#### 2.3.2 高频客户
- 消费频次前30%
- 月均消费次数 ≥ 5次

#### 2.3.3 新客户
- 注册时间 ≤ 30天
- 消费次数 ≤ 3次

#### 2.3.4 流失风险客户
- 最近消费时间 > 30天
- 消费频次下降 > 50%
- 满意度评分 < 3.5

#### 2.3.5 忠诚客户
- 消费频次 ≥ 8次/月
- 客户时长 ≥ 6个月
- 满意度评分 ≥ 4.5

#### 2.3.6 休眠客户
- 最近消费时间 > 30天
- 历史消费次数 ≥ 3次

## 三、客户生命周期自动流转规则引擎

### 3.1 规则引擎架构

#### 3.1.1 规则定义
```typescript
interface LifecycleRule {
  id: string
  name: string
  description: string
  fromStage: string[]
  toStage: string
  conditions: RuleCondition[]
  priority: number
  enabled: boolean
  createdAt: Date
  updatedAt: Date
}

interface RuleCondition {
  field: string
  operator: 'eq' | 'ne' | 'gt' | 'lt' | 'gte' | 'lte' | 'in' | 'not_in'
  value: any
  logicalOperator?: 'AND' | 'OR'
}
```

#### 3.1.2 规则执行流程
1. **触发事件**：客户数据变更（消费、注册、互动等）
2. **规则匹配**：根据当前阶段筛选适用规则
3. **条件评估**：评估规则条件是否满足
4. **优先级排序**：按优先级排序匹配的规则
5. **规则执行**：执行最高优先级规则
6. **状态更新**：更新客户生命周期阶段
7. **事件通知**：发送通知给相关人员
8. **日志记录**：记录流转历史

### 3.2 预置流转规则

#### 3.2.1 潜在客户 → 新客户
```
规则ID: RULE_001
优先级: 1
条件:
  - 首次消费时间 不为空
  - 消费金额 > 0
动作:
  - 更新生命周期阶段为 'new_customer'
  - 发送欢迎消息
  - 发放新客优惠券
```

#### 3.2.2 新客户 → 活跃客户
```
规则ID: RULE_002
优先级: 2
条件:
  - 消费次数 >= 3
  - 消费天数 >= 7
  - 最近消费时间 <= 30天前
动作:
  - 更新生命周期阶段为 'active'
  - 发送会员升级提醒
  - 推荐热门商品
```

#### 3.2.3 活跃客户 → 忠诚客户
```
规则ID: RULE_003
优先级: 3
条件:
  - 消费次数 >= 10
  - 累计消费金额 >= 2000
  - 最近消费时间 <= 90天前
  - 满意度评分 >= 4.5
动作:
  - 更新生命周期阶段为 'loyal'
  - 升级为VIP客户
  - 发放VIP专属权益
  - 通知店长
```

#### 3.2.4 活跃客户 → 休眠客户
```
规则ID: RULE_004
优先级: 4
条件:
  - 最近消费时间 > 30天前
  - 当前阶段为 'active'
动作:
  - 更新生命周期阶段为 'dormant'
  - 发送唤醒优惠券
  - 设置流失预警
```

#### 3.2.5 忠诚客户 → 休眠客户
```
规则ID: RULE_005
优先级: 5
条件:
  - 最近消费时间 > 60天前
  - 当前阶段为 'loyal'
动作:
  - 更新生命周期阶段为 'dormant'
  - 发送专属唤醒优惠
  - 安排客服回访
```

#### 3.2.6 休眠客户 → 流失客户
```
规则ID: RULE_006
优先级: 6
条件:
  - 最近消费时间 > 90天前
  - 当前阶段为 'dormant'
  - 唤醒尝试次数 >= 3
动作:
  - 更新生命周期阶段为 'churned'
  - 标记为流失客户
  - 生成流失分析报告
```

#### 3.2.7 休眠客户 → 活跃客户
```
规则ID: RULE_007
优先级: 7
条件:
  - 当前阶段为 'dormant'
  - 产生新消费
动作:
  - 更新生命周期阶段为 'active'
  - 发送欢迎回归消息
  - 推荐新品
```

### 3.3 规则引擎实现

#### 3.3.1 规则引擎核心类
```typescript
class LifecycleRuleEngine {
  private rules: LifecycleRule[]
  private eventBus: EventBus

  constructor(rules: LifecycleRule[]) {
    this.rules = rules.sort((a, b) => b.priority - a.priority)
    this.eventBus = new EventBus()
  }

  async evaluate(customer: Customer, event: CustomerEvent): Promise<RuleResult[]> {
    const applicableRules = this.rules.filter(rule =>
      rule.fromStage.includes(customer.lifecycleStage) && rule.enabled
    )

    const results: RuleResult[] = []
    for (const rule of applicableRules) {
      if (await this.evaluateConditions(rule.conditions, customer, event)) {
        results.push({
          rule,
          matched: true,
          timestamp: new Date()
        })
      }
    }

    return results.sort((a, b) => b.rule.priority - a.rule.priority)
  }

  private async evaluateConditions(
    conditions: RuleCondition[],
    customer: Customer,
    event: CustomerEvent
  ): Promise<boolean> {
    let result = true
    let currentOperator: 'AND' | 'OR' = 'AND'

    for (const condition of conditions) {
      const conditionResult = this.evaluateCondition(condition, customer, event)
      currentOperator = condition.logicalOperator || 'AND'

      if (currentOperator === 'AND') {
        result = result && conditionResult
      } else {
        result = result || conditionResult
      }
    }

    return result
  }

  private evaluateCondition(
    condition: RuleCondition,
    customer: Customer,
    event: CustomerEvent
  ): boolean {
    const fieldValue = this.getFieldValue(condition.field, customer, event)

    switch (condition.operator) {
      case 'eq':
        return fieldValue === condition.value
      case 'ne':
        return fieldValue !== condition.value
      case 'gt':
        return fieldValue > condition.value
      case 'lt':
        return fieldValue < condition.value
      case 'gte':
        return fieldValue >= condition.value
      case 'lte':
        return fieldValue <= condition.value
      case 'in':
        return Array.isArray(condition.value) && condition.value.includes(fieldValue)
      case 'not_in':
        return Array.isArray(condition.value) && !condition.value.includes(fieldValue)
      default:
        return false
    }
  }

  private getFieldValue(field: string, customer: Customer, event: CustomerEvent): any {
    const fieldPath = field.split('.')
    let value: any = { ...customer, ...event }

    for (const key of fieldPath) {
      value = value?.[key]
    }

    return value
  }
}
```

## 四、客户价值评估模型（RFM）

### 4.1 RFM模型概述

RFM模型是客户价值评估的经典方法，通过三个维度对客户进行评分：
- **R（Recency）**：最近一次消费时间
- **F（Frequency）**：消费频次
- **M（Monetary）**：消费金额

### 4.2 RFM评分标准

#### 4.2.1 R评分（最近消费时间）
| 分数 | 最近消费时间 |
|------|-------------|
| 5分 | 0-7天 |
| 4分 | 8-14天 |
| 3分 | 15-30天 |
| 2分 | 31-60天 |
| 1分 | >60天 |

#### 4.2.2 F评分（消费频次）
| 分数 | 月均消费次数 |
|------|-------------|
| 5分 | ≥ 8次 |
| 4分 | 5-7次 |
| 3分 | 3-4次 |
| 2分 | 1-2次 |
| 1分 | 0次 |

#### 4.2.3 M评分（消费金额）
| 分数 | 月均消费金额 |
|------|-------------|
| 5分 | ≥ 1000元 |
| 4分 | 500-999元 |
| 3分 | 300-499元 |
| 2分 | 100-299元 |
| 1分 | < 100元 |

### 4.3 RFM总分计算

#### 4.3.1 计算公式
```
RFM总分 = R评分 × 0.3 + F评分 × 0.4 + M评分 × 0.3
```

#### 4.3.2 客户价值分级
| RFM总分 | 客户等级 | 占比 |
|---------|----------|------|
| 4.5-5.0 | 超级VIP | 5% |
| 3.5-4.4 | VIP | 15% |
| 2.5-3.4 | 会员 | 30% |
| 1.5-2.4 | 普通 | 40% |
| 0-1.4 | 低价值 | 10% |

### 4.4 RFM模型实现

```typescript
interface RFMScore {
  recencyScore: number
  frequencyScore: number
  monetaryScore: number
  totalScore: number
  customerLevel: string
}

class RFMModel {
  calculateRFMScore(customer: Customer): RFMScore {
    const recencyScore = this.calculateRecencyScore(customer.lastOrderDate)
    const frequencyScore = this.calculateFrequencyScore(customer.orderCount)
    const monetaryScore = this.calculateMonetaryScore(customer.totalSpent)

    const totalScore =
      recencyScore * 0.3 +
      frequencyScore * 0.4 +
      monetaryScore * 0.3

    return {
      recencyScore,
      frequencyScore,
      monetaryScore,
      totalScore: Math.round(totalScore * 10) / 10,
      customerLevel: this.getCustomerLevel(totalScore)
    }
  }

  private calculateRecencyScore(lastOrderDate: Date | null): number {
    if (!lastOrderDate) return 1

    const daysSinceLastOrder = Math.floor(
      (Date.now() - new Date(lastOrderDate).getTime()) / (1000 * 60 * 60 * 24)
    )

    if (daysSinceLastOrder <= 7) return 5
    if (daysSinceLastOrder <= 14) return 4
    if (daysSinceLastOrder <= 30) return 3
    if (daysSinceLastOrder <= 60) return 2
    return 1
  }

  private calculateFrequencyScore(orderCount: number): number {
    const monthlyOrders = orderCount / 12

    if (monthlyOrders >= 8) return 5
    if (monthlyOrders >= 5) return 4
    if (monthlyOrders >= 3) return 3
    if (monthlyOrders >= 1) return 2
    return 1
  }

  private calculateMonetaryScore(totalSpent: number): number {
    const monthlySpent = totalSpent / 12

    if (monthlySpent >= 1000) return 5
    if (monthlySpent >= 500) return 4
    if (monthlySpent >= 300) return 3
    if (monthlySpent >= 100) return 2
    return 1
  }

  private getCustomerLevel(totalScore: number): string {
    if (totalScore >= 4.5) return 'super_vip'
    if (totalScore >= 3.5) return 'vip'
    if (totalScore >= 2.5) return 'member'
    if (totalScore >= 1.5) return 'regular'
    return 'low_value'
  }
}
```

## 五、智能客户关怀提醒功能

### 5.1 关怀场景设计

#### 5.1.1 新客户关怀
**触发时机**：客户首次消费后24小时内
**关怀内容**：
- 感谢首次消费
- 介绍会员权益
- 发放新客优惠券
- 推荐热门商品

#### 5.1.2 生日关怀
**触发时机**：客户生日当天
**关怀内容**：
- 生日祝福
- 生日专属优惠券
- 免费赠送小礼品
- 邀请亲友同享优惠

#### 5.1.3 节日关怀
**触发时机**：重要节日（春节、中秋、国庆等）
**关怀内容**：
- 节日祝福
- 节日专属优惠
- 节日特色菜品推荐

#### 5.1.4 消费频次下降提醒
**触发时机**：客户消费频次下降超过50%
**关怀内容**：
- 询问是否有问题
- 提供专属优惠
- 推荐新品

#### 5.1.5 长期未消费提醒
**触发时机**：客户30天未消费
**关怀内容**：
- 表达关心
- 发放唤醒优惠券
- 推荐近期优惠活动

#### 5.1.6 VIP客户专属关怀
**触发时机**：VIP客户每月定期
**关怀内容**：
- 专属客服对接
- 新品优先体验
- 定制化服务
- 积分奖励

### 5.2 关怀提醒规则

```typescript
interface CareReminderRule {
  id: string
  name: string
  triggerType: 'event' | 'schedule' | 'condition'
  triggerCondition: any
  careType: string
  contentTemplate: string
  channels: string[]
  priority: number
  enabled: boolean
}

const careReminderRules: CareReminderRule[] = [
  {
    id: 'CARE_001',
    name: '新客户关怀',
    triggerType: 'event',
    triggerCondition: { eventType: 'first_order', hoursAfter: 24 },
    careType: 'welcome',
    contentTemplate: '感谢您首次光临！',
    channels: ['sms', 'push'],
    priority: 1,
    enabled: true
  },
  {
    id: 'CARE_002',
    name: '生日关怀',
    triggerType: 'schedule',
    triggerCondition: { schedule: 'birthday' },
    careType: 'birthday',
    contentTemplate: '生日快乐！',
    channels: ['sms', 'push', 'email'],
    priority: 2,
    enabled: true
  },
  {
    id: 'CARE_003',
    name: '消费频次下降提醒',
    triggerType: 'condition',
    triggerCondition: {
      field: 'orderFrequencyChange',
      operator: 'lt',
      value: -0.5
    },
    careType: 'frequency_drop',
    contentTemplate: '最近很少见到您',
    channels: ['sms', 'push'],
    priority: 3,
    enabled: true
  },
  {
    id: 'CARE_004',
    name: '长期未消费提醒',
    triggerType: 'condition',
    triggerCondition: {
      field: 'daysSinceLastOrder',
      operator: 'gte',
      value: 30
    },
    careType: 'inactive',
    contentTemplate: '好久不见',
    channels: ['sms', 'push', 'email'],
    priority: 4,
    enabled: true
  }
]
```

### 5.3 关怀提醒引擎

```typescript
class CareReminderEngine {
  private rules: CareReminderRule[]
  private notificationService: NotificationService

  constructor(rules: CareReminderRule[]) {
    this.rules = rules
    this.notificationService = new NotificationService()
  }

  async processCustomerEvent(customer: Customer, event: CustomerEvent): Promise<void> {
    for (const rule of this.rules) {
      if (!rule.enabled) continue

      const shouldTrigger = await this.evaluateTrigger(rule, customer, event)
      if (shouldTrigger) {
        await this.sendCareReminder(customer, rule)
      }
    }
  }

  private async evaluateTrigger(
    rule: CareReminderRule,
    customer: Customer,
    event: CustomerEvent
  ): Promise<boolean> {
    switch (rule.triggerType) {
      case 'event':
        return this.evaluateEventTrigger(rule.triggerCondition, event)
      case 'schedule':
        return this.evaluateScheduleTrigger(rule.triggerCondition, customer)
      case 'condition':
        return this.evaluateConditionTrigger(rule.triggerCondition, customer)
      default:
        return false
    }
  }

  private async sendCareReminder(
    customer: Customer,
    rule: CareReminderRule
  ): Promise<void> {
    const content = this.generateContent(rule.contentTemplate, customer)

    for (const channel of rule.channels) {
      await this.notificationService.send({
        channel,
        recipient: customer,
        content,
        type: rule.careType
      })
    }

    await this.logCareReminder(customer.id, rule.id, content)
  }

  private generateContent(template: string, customer: Customer): string {
    return template
      .replace('{name}', customer.name)
      .replace('{level}', customer.level)
      .replace('{lastOrderDate}', formatDate(customer.lastOrderDate))
  }
}
```

## 六、客户流失预警机制

### 6.1 流失预警指标

#### 6.1.1 行为指标
- 最近消费时间 > 30天
- 消费频次下降 > 50%
- 消费金额下降 > 50%
- 互动频率下降 > 60%
- 满意度评分 < 3.5

#### 6.1.2 预警等级

| 等级 | 颜色 | 条件 | 处理时效 |
|------|------|------|----------|
| 高危 | 红色 | 最近消费 > 60天 且 消费频次下降 > 70% | 24小时内 |
| 中危 | 橙色 | 最近消费 > 45天 或 消费频次下降 > 50% | 48小时内 |
| 低危 | 黄色 | 最近消费 > 30天 或 消费频次下降 > 30% | 72小时内 |

### 6.2 流失预测模型

```typescript
interface ChurnPrediction {
  customerId: string
  churnProbability: number
  riskLevel: 'high' | 'medium' | 'low'
  riskFactors: string[]
  predictedChurnDate: Date
  recommendations: string[]
}

class ChurnPredictionModel {
  predictChurn(customer: Customer): ChurnPrediction {
    const riskFactors: string[] = []
    let churnProbability = 0

    if (this.isInactive(customer, 30)) {
      churnProbability += 0.2
      riskFactors.push('30天未消费')
    }

    if (this.isInactive(customer, 60)) {
      churnProbability += 0.3
      riskFactors.push('60天未消费')
    }

    if (this.hasFrequencyDrop(customer, 0.5)) {
      churnProbability += 0.25
      riskFactors.push('消费频次下降50%')
    }

    if (this.hasSpendingDrop(customer, 0.5)) {
      churnProbability += 0.15
      riskFactors.push('消费金额下降50%')
    }

    if (customer.satisfactionScore < 3.5) {
      churnProbability += 0.1
      riskFactors.push('满意度低')
    }

    churnProbability = Math.min(churnProbability, 1.0)

    return {
      customerId: customer.id,
      churnProbability,
      riskLevel: this.getRiskLevel(churnProbability),
      riskFactors,
      predictedChurnDate: this.predictChurnDate(churnProbability),
      recommendations: this.generateRecommendations(riskFactors)
    }
  }

  private isInactive(customer: Customer, days: number): boolean {
    if (!customer.lastOrderDate) return true
    const daysSinceLastOrder = Math.floor(
      (Date.now() - new Date(customer.lastOrderDate).getTime()) / (1000 * 60 * 60 * 24)
    )
    return daysSinceLastOrder > days
  }

  private hasFrequencyDrop(customer: Customer, threshold: number): boolean {
    const currentFrequency = this.calculateMonthlyFrequency(customer, 30)
    const previousFrequency = this.calculateMonthlyFrequency(customer, 90)
    return currentFrequency < previousFrequency * (1 - threshold)
  }

  private hasSpendingDrop(customer: Customer, threshold: number): boolean {
    const currentSpending = this.calculateMonthlySpending(customer, 30)
    const previousSpending = this.calculateMonthlySpending(customer, 90)
    return currentSpending < previousSpending * (1 - threshold)
  }

  private getRiskLevel(probability: number): 'high' | 'medium' | 'low' {
    if (probability >= 0.7) return 'high'
    if (probability >= 0.4) return 'medium'
    return 'low'
  }

  private predictChurnDate(probability: number): Date {
    const daysToChurn = Math.floor(90 * (1 - probability))
    return new Date(Date.now() + daysToChurn * 24 * 60 * 60 * 1000)
  }

  private generateRecommendations(riskFactors: string[]): string[] {
    const recommendations: string[] = []

    if (riskFactors.includes('30天未消费')) {
      recommendations.push('发送唤醒优惠券')
      recommendations.push('安排客服回访')
    }

    if (riskFactors.includes('消费频次下降50%')) {
      recommendations.push('了解消费下降原因')
      recommendations.push('提供专属优惠')
    }

    if (riskFactors.includes('满意度低')) {
      recommendations.push('安排满意度调研')
      recommendations.push('改进服务质量')
    }

    return recommendations
  }
}
```

### 6.3 流失预警处理流程

1. **预警触发**：系统自动检测到流失风险
2. **预警评估**：计算流失概率和风险等级
3. **预警通知**：发送通知给店长和客服
4. **任务分配**：自动分配给相应客服人员
5. **客户回访**：客服人员主动联系客户
6. **问题解决**：了解问题并提供解决方案
7. **效果跟踪**：记录处理结果和客户反馈
8. **持续监控**：持续监控客户状态

## 七、生命周期数据分析看板

### 7.1 看板布局设计

#### 7.1.1 顶部指标卡片
- 总客户数
- 活跃客户数
- 流失客户数
- 客户留存率
- 平均生命周期价值（CLV）
- 客户满意度

#### 7.1.2 生命周期阶段分布图
- 饼图展示各阶段客户占比
- 环比变化趋势
- 阶段流转统计

#### 7.1.3 客户价值分布图
- 柱状图展示RFM评分分布
- 客户等级占比
- 价值变化趋势

#### 7.1.4 流失预警列表
- 高危流失客户
- 中危流失客户
- 低危流失客户
- 处理状态跟踪

#### 7.1.5 关怀提醒列表
- 待处理关怀提醒
- 已完成关怀记录
- 关怀效果统计

#### 7.1.6 客户流转趋势图
- 折线图展示阶段流转趋势
- 流入流出统计
- 转化率分析

### 7.2 数据可视化组件

```typescript
interface LifecycleDashboardData {
  overview: {
    totalCustomers: number
    activeCustomers: number
    churnedCustomers: number
    retentionRate: number
    averageCLV: number
    satisfactionScore: number
  }
  stageDistribution: {
    stage: string
    count: number
    percentage: number
    change: number
  }[]
  valueDistribution: {
    level: string
    count: number
    avgRFMScore: number
  }[]
  churnAlerts: ChurnPrediction[]
  careReminders: CareReminder[]
  flowTrends: {
    date: string
    fromStage: string
    toStage: string
    count: number
  }[]
}
```

## 八、数据模型设计

### 8.1 客户生命周期表（customer_lifecycle）

```sql
CREATE TABLE customer_lifecycle (
  id VARCHAR(36) PRIMARY KEY,
  customer_id VARCHAR(36) NOT NULL,
  current_stage VARCHAR(50) NOT NULL,
  previous_stage VARCHAR(50),
  stage_entered_at TIMESTAMP NOT NULL,
  stage_duration_days INT,
  total_days_in_stage INT,
  rfm_score DECIMAL(3,1),
  customer_level VARCHAR(50),
  churn_probability DECIMAL(5,2),
  risk_level VARCHAR(20),
  last_order_date TIMESTAMP,
  order_count INT,
  total_spent DECIMAL(10,2),
  satisfaction_score DECIMAL(3,1),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_customer_id (customer_id),
  INDEX idx_current_stage (current_stage),
  INDEX idx_churn_probability (churn_probability),
  FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE
);
```

### 8.2 生命周期流转记录表（lifecycle_transitions）

```sql
CREATE TABLE lifecycle_transitions (
  id VARCHAR(36) PRIMARY KEY,
  customer_id VARCHAR(36) NOT NULL,
  from_stage VARCHAR(50),
  to_stage VARCHAR(50) NOT NULL,
  transition_date TIMESTAMP NOT NULL,
  rule_id VARCHAR(50),
  reason TEXT,
  metadata JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_customer_id (customer_id),
  INDEX idx_transition_date (transition_date),
  INDEX idx_to_stage (to_stage),
  FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE
);
```

### 8.3 关怀提醒记录表（care_reminders）

```sql
CREATE TABLE care_reminders (
  id VARCHAR(36) PRIMARY KEY,
  customer_id VARCHAR(36) NOT NULL,
  rule_id VARCHAR(50) NOT NULL,
  care_type VARCHAR(50) NOT NULL,
  content TEXT NOT NULL,
  channels JSON NOT NULL,
  scheduled_at TIMESTAMP NOT NULL,
  sent_at TIMESTAMP,
  status ENUM('pending', 'sent', 'failed') DEFAULT 'pending',
  response TEXT,
  effectiveness_score INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_customer_id (customer_id),
  INDEX idx_scheduled_at (scheduled_at),
  INDEX idx_status (status),
  FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE
);
```

### 8.4 流失预警记录表（churn_alerts）

```sql
CREATE TABLE churn_alerts (
  id VARCHAR(36) PRIMARY KEY,
  customer_id VARCHAR(36) NOT NULL,
  churn_probability DECIMAL(5,2) NOT NULL,
  risk_level VARCHAR(20) NOT NULL,
  risk_factors JSON NOT NULL,
  predicted_churn_date TIMESTAMP,
  assigned_to VARCHAR(36),
  status ENUM('pending', 'in_progress', 'resolved', 'closed') DEFAULT 'pending',
  resolution_notes TEXT,
  resolved_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_customer_id (customer_id),
  INDEX idx_risk_level (risk_level),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
  FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL
);
```

## 九、API接口设计

### 9.1 客户生命周期接口

#### 9.1.1 获取客户生命周期信息
```
GET /api/v1/customers/{customerId}/lifecycle

Response:
{
  "success": true,
  "data": {
    "id": "xxx",
    "customerId": "xxx",
    "currentStage": "active",
    "previousStage": "new_customer",
    "stageEnteredAt": "2024-01-01T00:00:00Z",
    "stageDurationDays": 15,
    "rfmScore": {
      "recencyScore": 4,
      "frequencyScore": 3,
      "monetaryScore": 4,
      "totalScore": 3.7,
      "customerLevel": "member"
    },
    "churnProbability": 0.15,
    "riskLevel": "low"
  }
}
```

#### 9.1.2 更新客户生命周期阶段
```
POST /api/v1/customers/{customerId}/lifecycle/stage

Request:
{
  "stage": "loyal",
  "reason": "达到忠诚客户标准",
  "ruleId": "RULE_003"
}

Response:
{
  "success": true,
  "data": {
    "id": "xxx",
    "customerId": "xxx",
    "currentStage": "loyal",
    "previousStage": "active",
    "transitionDate": "2024-01-15T00:00:00Z"
  }
}
```

#### 9.1.3 获取生命周期流转历史
```
GET /api/v1/customers/{customerId}/lifecycle/transitions?page=1&limit=10

Response:
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "xxx",
        "fromStage": "new_customer",
        "toStage": "active",
        "transitionDate": "2024-01-10T00:00:00Z",
        "ruleId": "RULE_002",
        "reason": "达到活跃客户标准"
      }
    ],
    "pagination": {
      "total": 10,
      "page": 1,
      "limit": 10,
      "totalPages": 1
    }
  }
}
```

### 9.2 RFM评分接口

#### 9.2.1 计算客户RFM评分
```
POST /api/v1/customers/rfm/calculate

Request:
{
  "customerIds": ["id1", "id2", "id3"]
}

Response:
{
  "success": true,
  "data": [
    {
      "customerId": "id1",
      "recencyScore": 4,
      "frequencyScore": 3,
      "monetaryScore": 4,
      "totalScore": 3.7,
      "customerLevel": "member"
    }
  ]
}
```

### 9.3 关怀提醒接口

#### 9.3.1 获取待处理关怀提醒
```
GET /api/v1/care-reminders/pending?page=1&limit=20

Response:
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "xxx",
        "customerId": "xxx",
        "customerName": "张三",
        "careType": "birthday",
        "content": "生日快乐！",
        "scheduledAt": "2024-01-15T00:00:00Z",
        "status": "pending"
      }
    ],
    "pagination": {
      "total": 50,
      "page": 1,
      "limit": 20,
      "totalPages": 3
    }
  }
}
```

#### 9.3.2 标记关怀提醒为已发送
```
PUT /api/v1/care-reminders/{reminderId}/send

Request:
{
  "response": "客户表示感谢",
  "effectivenessScore": 5
}

Response:
{
  "success": true,
  "data": {
    "id": "xxx",
    "status": "sent",
    "sentAt": "2024-01-15T10:00:00Z",
    "response": "客户表示感谢",
    "effectivenessScore": 5
  }
}
```

### 9.4 流失预警接口

#### 9.4.1 获取流失预警列表
```
GET /api/v1/churn-alerts?riskLevel=high&status=pending&page=1&limit=20

Response:
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "xxx",
        "customerId": "xxx",
        "customerName": "李四",
        "churnProbability": 0.85,
        "riskLevel": "high",
        "riskFactors": ["60天未消费", "消费频次下降70%"],
        "predictedChurnDate": "2024-02-15T00:00:00Z",
        "status": "pending",
        "createdAt": "2024-01-10T00:00:00Z"
      }
    ],
    "pagination": {
      "total": 25,
      "page": 1,
      "limit": 20,
      "totalPages": 2
    }
  }
}
```

#### 9.4.2 分配流失预警处理人
```
PUT /api/v1/churn-alerts/{alertId}/assign

Request:
{
  "assignedTo": "userId123"
}

Response:
{
  "success": true,
  "data": {
    "id": "xxx",
    "assignedTo": "userId123",
    "status": "in_progress",
    "assignedAt": "2024-01-15T10:00:00Z"
  }
}
```

#### 9.4.3 更新流失预警状态
```
PUT /api/v1/churn-alerts/{alertId}/resolve

Request:
{
  "status": "resolved",
  "resolutionNotes": "已联系客户，问题已解决"
}

Response:
{
  "success": true,
  "data": {
    "id": "xxx",
    "status": "resolved",
    "resolutionNotes": "已联系客户，问题已解决",
    "resolvedAt": "2024-01-15T15:00:00Z"
  }
}
```

### 9.5 生命周期数据看板接口

#### 9.5.1 获取生命周期概览数据
```
GET /api/v1/analytics/lifecycle/overview?startDate=2024-01-01&endDate=2024-01-31

Response:
{
  "success": true,
  "data": {
    "overview": {
      "totalCustomers": 10000,
      "activeCustomers": 6500,
      "churnedCustomers": 500,
      "retentionRate": 0.95,
      "averageCLV": 2500,
      "satisfactionScore": 4.3
    },
    "stageDistribution": [
      {
        "stage": "potential",
        "count": 2000,
        "percentage": 0.2,
        "change": 0.05
      },
      {
        "stage": "new_customer",
        "count": 1500,
        "percentage": 0.15,
        "change": 0.03
      }
    ],
    "valueDistribution": [
      {
        "level": "vip",
        "count": 1500,
        "avgRFMScore": 4.2
      }
    ],
    "churnAlerts": {
      "high": 25,
      "medium": 50,
      "low": 75
    }
  }
}
```

## 十、技术实现要点

### 10.1 前端技术栈
- Vue 3 + TypeScript
- Element Plus UI组件库
- ECharts数据可视化
- Pinia状态管理
- Vue Router路由管理

### 10.2 后端技术栈
- Node.js + Express
- TypeScript
- PostgreSQL数据库
- Redis缓存
- 定时任务（node-cron）

### 10.3 性能优化
- RFM评分计算缓存（Redis）
- 规则引擎结果缓存
- 数据预加载
- 虚拟滚动优化列表
- 分页加载

### 10.4 安全性
- 数据加密传输（HTTPS）
- 敏感信息脱敏
- 访问权限控制
- 操作日志记录
- 数据备份

## 十一、测试计划

### 11.1 单元测试
- 生命周期流转规则测试
- RFM模型计算测试
- 流失预测模型测试
- 关怀提醒引擎测试

### 11.2 集成测试
- 客户生命周期流转端到端测试
- 关怀提醒发送测试
- 流失预警处理测试

### 11.3 性能测试
- 大规模客户数据处理测试
- 规则引擎性能测试
- 并发访问测试

## 十二、上线计划

### 12.1 阶段一：基础功能（1-2周）
- 客户生命周期阶段划分
- RFM模型实现
- 基础数据看板

### 12.2 阶段二：智能功能（2-3周）
- 自动流转规则引擎
- 关怀提醒功能
- 流失预警机制

### 12.3 阶段三：优化完善（1-2周）
- 数据可视化优化
- 性能优化
- 用户反馈收集与改进

### 12.4 阶段四：全面推广（持续）
- 全员培训
- 数据监控
- 持续优化迭代

---

**文档版本**: v1.0.0
**创建日期**: 2025-01-20
**最后更新**: 2025-01-20
**文档状态**: 已完成
