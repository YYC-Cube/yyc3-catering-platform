# 订单管理功能模块开发文档

## 模块概述

订单管理模块是YYC³餐饮行业智能化平台的核心业务模块，提供订单创建、查询、更新、批量操作等全方位的订单管理功能。该模块采用Vue 3 + TypeScript + Element Plus技术栈，使用Pinia进行状态管理。

## 技术架构

### 1. 技术栈
- **前端框架**: Vue 3.4+ (Composition API)
- **UI组件库**: Element Plus 2.4+
- **状态管理**: Pinia 2.1+
- **路由管理**: Vue Router 4.2+
- **HTTP客户端**: Fetch API
- **类型检查**: TypeScript 5.3+
- **构建工具**: Vite 5.4+

### 2. 目录结构
```
src/
├── views/
│   └── OrderManagement.vue          # 订单管理主页面
├── components/
│   └── Order/
│       ├── OrderDetail.vue           # 订单详情组件
│       ├── OrderFlowVisualization.vue # 订单流程可视化组件
│       ├── CreateOrderForm.vue       # 创建订单表单组件
│       ├── OrderStatusTracker.vue    # 订单状态跟踪组件
│       ├── OrderBatchOperations.vue  # 订单批量操作组件
│       └── __tests__/
│           ├── OrderManagement.test.ts
│           ├── OrderDetail.test.ts
│           ├── OrderStatusTracker.test.ts
│           └── OrderBatchOperations.test.ts
├── api/
│   └── order-management.ts          # 订单管理API接口
├── stores/
│   └── order.ts                    # 订单状态管理
└── types/
    └── order.ts                    # 订单类型定义
```

## 核心组件

### 1. OrderManagement主页面

#### 1.1 组件说明
订单管理主页面，提供订单列表、看板、时间线三种视图模式，支持筛选、搜索、批量操作等功能。

#### 1.2 核心功能
- 订单统计概览
- 多条件筛选
- 三种视图模式（列表、看板、时间线）
- 批量操作
- 订单创建
- 订单详情查看
- 订单流程可视化

#### 1.3 状态管理
```typescript
const loading = ref(false)
const orders = ref<Order[]>([])
const selectedOrders = ref<Order[]>([])
const selectedOrder = ref<Order | null>(null)
const viewMode = ref<'list' | 'kanban' | 'timeline'>('list')
const showDetailDialog = ref(false)
const showFlowDialog = ref(false)
const showCreateDialog = ref(false)
```

### 2. OrderStatusTracker组件

#### 2.1 组件说明
订单状态跟踪组件，提供订单状态流转的可视化展示，包括状态步骤、时间线、操作按钮等。

#### 2.2 核心功能
- 状态步骤展示
- 状态历史时间线
- 实时指标统计
- 自动刷新
- 状态更新操作
- 阻塞状态提示

#### 2.3 状态步骤
```typescript
const statusSteps = [
  {
    status: OrderStatus.PENDING,
    label: '待确认',
    description: '订单已创建，等待确认',
    icon: ShoppingCart
  },
  {
    status: OrderStatus.CONFIRMED,
    label: '已确认',
    description: '订单已确认，开始准备',
    icon: Check
  },
  {
    status: OrderStatus.PREPARING,
    label: '制作中',
    description: '正在制作订单',
    icon: Loading
  },
  {
    status: OrderStatus.READY,
    label: '已完成',
    description: '订单制作完成',
    icon: CircleCheck
  },
  {
    status: OrderStatus.SERVED,
    label: '已上餐',
    description: '订单已送达客户',
    icon: CircleCheck
  }
]
```

### 3. OrderBatchOperations组件

#### 3.1 组件说明
订单批量操作组件，提供批量状态更新、打印、导出、分配员工等功能。

#### 3.2 核心功能
- 批量状态更新
- 批量打印（厨房单、客户单、配送单）
- 批量导出（Excel、PDF、CSV）
- 批量分配员工
- 批量添加标签
- 批量添加备注
- 选择统计信息

#### 3.3 操作类型
```typescript
interface BatchOperation {
  type: 'status' | 'print' | 'export' | 'assign' | 'tags' | 'notes'
  label: string
  icon: any
  action: () => Promise<void>
}
```

## API接口

### 1. 订单查询接口

#### 1.1 获取订单列表
```typescript
interface GetOrdersParams {
  status?: OrderStatus[]
  type?: OrderType[]
  search?: string
  dateRange?: [string, string]
  page: number
  pageSize: number
}

interface GetOrdersResponse {
  success: boolean
  data: {
    orders: Order[]
    total: number
  }
}

export function getOrders(params: GetOrdersParams): Promise<GetOrdersResponse>
```

#### 1.2 获取订单详情
```typescript
export function getOrderDetail(orderId: number): Promise<{
  success: boolean
  data: Order
}>
```

#### 1.3 获取订单状态历史
```typescript
interface StatusEvent {
  id: number
  status: OrderStatus
  timestamp: string
  operator?: string
  note?: string
  duration?: number
}

export function getOrderStatusHistory(orderId: number): Promise<{
  success: boolean
  data: StatusEvent[]
}>
```

### 2. 订单创建接口

#### 2.1 创建订单
```typescript
interface CreateOrderRequest {
  customerId?: number
  type: OrderType
  items: Array<{
    menuItemId: number
    quantity: number
    variations?: Record<string, any>
    additions?: number[]
    notes?: string
  }>
  tableNumber?: string
  deliveryAddress?: {
    address: string
    latitude?: number
    longitude?: number
  }
  notes?: string
  discountCode?: string
  tags?: string[]
}

export function createOrder(data: CreateOrderRequest): Promise<{
  success: boolean
  data: Order
}>
```

### 3. 订单更新接口

#### 3.1 更新订单状态
```typescript
export function updateOrderStatus(orderId: number, status: OrderStatus): Promise<{
  success: boolean
  data: Order
}>
```

#### 3.2 更新订单信息
```typescript
interface UpdateOrderRequest {
  status?: OrderStatus
  paymentStatus?: PaymentStatus
  notes?: string
  items?: Array<{
    id: number
    quantity: number
    status: OrderItem['status']
  }>
  tags?: string[]
}

export function updateOrder(orderId: number, data: UpdateOrderRequest): Promise<{
  success: boolean
  data: Order
}>
```

### 4. 批量操作接口

#### 4.1 批量更新订单
```typescript
export function batchUpdateOrders(orderIds: number[], data: {
  status?: OrderStatus
  staffId?: string
  tags?: string[]
  notes?: string
}): Promise<{
  success: boolean
  updated: number
}>
```

#### 4.2 批量打印订单
```typescript
export function batchPrintOrders(orderIds: number[], type: 'kitchen' | 'customer' | 'delivery'): Promise<{
  success: boolean
  message: string
}>
```

#### 4.3 导出订单
```typescript
export function exportOrders(params: {
  orderIds?: number[]
  filters?: GetOrdersParams
  format: 'excel' | 'pdf' | 'csv'
}): Promise<Blob>
```

### 5. 其他操作接口

#### 5.1 打印订单
```typescript
export function printOrder(orderId: number): Promise<{
  success: boolean
  message: string
}>
```

#### 5.2 退款订单
```typescript
export function refundOrder(orderId: number): Promise<{
  success: boolean
  data: Order
}>
```

#### 5.3 取消订单
```typescript
export function cancelOrder(orderId: number): Promise<{
  success: boolean
  data: Order
}>
```

## 类型定义

### 1. 订单类型
```typescript
export enum OrderStatus {
  PENDING = 'pending',
  CONFIRMED = 'confirmed',
  PREPARING = 'preparing',
  READY = 'ready',
  SERVED = 'served',
  COMPLETED = 'completed',
  CANCELLED = 'cancelled',
  REFUNDED = 'refunded'
}

export enum OrderType {
  DINE_IN = 'dine_in',
  TAKEAWAY = 'takeaway',
  DELIVERY = 'delivery'
}

export enum PaymentStatus {
  PENDING = 'pending',
  PAID = 'paid',
  REFUNDED = 'refunded',
  FAILED = 'failed'
}
```

### 2. 订单接口
```typescript
export interface Order {
  id: number
  orderNumber: string
  customerId?: number
  customerName?: string
  customerPhone?: string
  type: OrderType
  status: OrderStatus
  paymentStatus: PaymentStatus
  totalAmount: number
  discountAmount: number
  taxAmount: number
  finalAmount: number
  items: OrderItem[]
  notes?: string
  tableNumber?: string
  deliveryAddress?: {
    address: string
    latitude?: number
    longitude?: number
    estimatedTime?: string
  }
  timestamps: {
    createdAt: string
    confirmedAt?: string
    preparedAt?: string
    readyAt?: string
    servedAt?: string
    completedAt?: string
    cancelledAt?: string
  }
  staff: {
    createdBy: string
    confirmedBy?: string
    preparedBy?: string
    servedBy?: string
  }
  source: 'pos' | 'web' | 'mobile' | 'third_party'
  channel?: string
  tags?: string[]
  rating?: {
    score: number
    comment?: string
    createdAt: string
  }
  metadata?: Record<string, any>
}

export interface OrderItem {
  id: number
  orderId: number
  menuItemId: number
  name: string
  price: number
  quantity: number
  variations?: Record<string, any>
  additions?: Array<{
    name: string
    price: number
  }>
  notes?: string
  status: 'pending' | 'confirmed' | 'preparing' | 'ready' | 'served'
}
```

## 状态管理

### 1. Order Store

```typescript
export const useOrderStore = defineStore('order', () => {
  const loading = ref(false)
  const error = ref<string | null>(null)
  const orders = ref<Order[]>([])
  const selectedOrders = ref<Order[]>([])
  const currentOrder = ref<Order | null>(null)

  async function fetchOrders(params: GetOrdersParams) {
    loading.value = true
    try {
      const response = await getOrders(params)
      if (response.success) {
        orders.value = response.data.orders
      }
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
    } finally {
      loading.value = false
    }
  }

  async function fetchOrderDetail(orderId: number) {
    loading.value = true
    try {
      const response = await getOrderDetail(orderId)
      if (response.success) {
        currentOrder.value = response.data
      }
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
    } finally {
      loading.value = false
    }
  }

  async function createOrder(data: CreateOrderRequest) {
    loading.value = true
    try {
      const response = await createOrder(data)
      if (response.success) {
        orders.value.unshift(response.data)
      }
      return response
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
      throw err
    } finally {
      loading.value = false
    }
  }

  async function updateOrderStatus(orderId: number, status: OrderStatus) {
    loading.value = true
    try {
      const response = await updateOrderStatus(orderId, status)
      if (response.success) {
        const index = orders.value.findIndex(o => o.id === orderId)
        if (index !== -1) {
          orders.value[index] = response.data
        }
      }
      return response
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
      throw err
    } finally {
      loading.value = false
    }
  }

  return {
    loading,
    error,
    orders,
    selectedOrders,
    currentOrder,
    fetchOrders,
    fetchOrderDetail,
    createOrder,
    updateOrderStatus
  }
})
```

## 测试

### 1. 单元测试

#### 1.1 OrderManagement组件测试
```typescript
describe('OrderManagement组件', () => {
  it('应该正确渲染订单统计卡片', () => {
    const wrapper = mount(OrderManagement)
    expect(wrapper.find('.order-overview').exists()).toBe(true)
  })

  it('应该能够切换视图模式', async () => {
    const wrapper = mount(OrderManagement)
    await wrapper.vm.setViewMode('kanban')
    expect(wrapper.vm.viewMode).toBe('kanban')
  })

  it('应该能够筛选订单', async () => {
    const wrapper = mount(OrderManagement)
    await wrapper.setData({
      filters: { status: ['pending'], type: [], search: '' }
    })
    await wrapper.vm.handleFilterChange()
    expect(wrapper.vm.pagination.page).toBe(1)
  })
})
```

#### 1.2 OrderStatusTracker组件测试
```typescript
describe('OrderStatusTracker组件', () => {
  it('应该正确显示状态步骤', () => {
    const order = {
      id: 1,
      orderNumber: 'ORD-001',
      status: OrderStatus.CONFIRMED,
      type: OrderType.DINE_IN,
      paymentStatus: PaymentStatus.PAID,
      totalAmount: 100,
      discountAmount: 0,
      taxAmount: 10,
      finalAmount: 110,
      items: [],
      timestamps: {
        createdAt: '2025-01-20T10:00:00Z'
      },
      staff: {
        createdBy: 'admin'
      },
      source: 'pos'
    }
    const wrapper = mount(OrderStatusTracker, {
      props: { order }
    })
    expect(wrapper.find('.el-steps').exists()).toBe(true)
  })

  it('应该能够更新订单状态', async () => {
    const order = {
      id: 1,
      orderNumber: 'ORD-001',
      status: OrderStatus.PENDING,
      type: OrderType.DINE_IN,
      paymentStatus: PaymentStatus.PAID,
      totalAmount: 100,
      discountAmount: 0,
      taxAmount: 10,
      finalAmount: 110,
      items: [],
      timestamps: {
        createdAt: '2025-01-20T10:00:00Z'
      },
      staff: {
        createdBy: 'admin'
      },
      source: 'pos'
    }
    const wrapper = mount(OrderStatusTracker, {
      props: { order }
    })
    await wrapper.vm.handleAction({
      status: OrderStatus.CONFIRMED,
      label: '确认订单',
      icon: Check,
      type: 'success'
    })
    expect(wrapper.emitted('statusChanged')).toBeTruthy()
  })
})
```

## 性能优化

### 1. 组件优化
- 使用Vue 3 Composition API减少不必要的重渲染
- 使用computed缓存计算结果
- 使用v-memo优化列表渲染
- 使用虚拟滚动优化大数据量列表

### 2. 数据优化
- 使用请求缓存减少重复请求
- 使用分页加载减少数据传输量
- 使用数据预加载提升用户体验
- 使用WebSocket实现实时数据更新

### 3. 用户体验优化
- 添加加载状态提示
- 添加错误处理和重试机制
- 添加操作确认对话框
- 添加操作成功/失败提示

## 部署说明

### 1. 环境要求
- Node.js >= 18.0.0
- npm >= 9.0.0

### 2. 安装依赖
```bash
npm install
```

### 3. 开发环境
```bash
npm run dev
```

### 4. 生产构建
```bash
npm run build
```

### 5. 运行测试
```bash
npm run test
```

### 6. 代码检查
```bash
npm run lint
npm run type-check
```

## 开发规范

### 1. 代码风格
- 使用TypeScript进行类型检查
- 遵循ESLint代码规范
- 使用Prettier进行代码格式化
- 遵循Vue 3 Composition API最佳实践

### 2. 命名规范
- 组件名使用PascalCase
- 文件名使用PascalCase
- 变量名使用camelCase
- 常量名使用UPPER_SNAKE_CASE

### 3. 注释规范
- 使用JSDoc注释函数和类
- 使用单行注释解释复杂逻辑
- 使用TODO标记待完成功能

### 4. Git提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建/工具相关
```

## 版本历史

### v1.0.0 (2025-01-20)
- 初始版本发布
- 实现订单列表、看板、时间线三种视图
- 实现订单创建、查询、更新功能
- 实现批量操作功能
- 实现订单状态跟踪功能
- 实现订单流程可视化
- 实现订单导出功能
- 完成单元测试覆盖
- 完成用户手册和开发文档

## 联系方式

如有任何问题或建议，请联系开发团队：
- 邮箱: dev@yyc3.com
- 项目地址: https://github.com/yyc3/catering-platform
