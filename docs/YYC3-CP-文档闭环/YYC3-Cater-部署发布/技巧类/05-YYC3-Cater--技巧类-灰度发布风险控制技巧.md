---

**@file**ï¼šYYCÂ³-ç°åº¦å‘å¸ƒé£é™©æ§åˆ¶æŠ€å·§
**@description**ï¼šYYCÂ³é¤é¥®è¡Œä¸šæ™ºèƒ½åŒ–å¹³å°çš„ç°åº¦å‘å¸ƒé£é™©æ§åˆ¶æŠ€å·§
**@author**ï¼šYYCÂ³
**@version**ï¼šv1.0.0
**@created**ï¼š2025-01-30
**@updated**ï¼š2025-01-30
**@status**ï¼špublished
**@tags**ï¼šYYCÂ³,æ–‡æ¡£

---
# ğŸ”– YYCÂ³ ç°åº¦å‘å¸ƒé£é™©æ§åˆ¶æŠ€å·§

> ***YanYuCloudCube***
> **æ ‡è¯­**ï¼šè¨€å¯è±¡é™ | è¯­æ¢æœªæ¥
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **æ ‡è¯­**ï¼šä¸‡è±¡å½’å…ƒäºäº‘æ¢ | æ·±æ ˆæ™ºå¯æ–°çºªå…ƒ
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| å±æ€§ | å†…å®¹ |
|------|------|
| **æ–‡æ¡£æ ‡é¢˜** | YYCÂ³ ç°åº¦å‘å¸ƒé£é™©æ§åˆ¶æŠ€å·§ |
| **æ–‡æ¡£ç±»å‹** | æŠ€å·§ç±»æ–‡æ¡£ |
| **æ‰€å±é˜¶æ®µ** | éƒ¨ç½²å‘å¸ƒ |
| **éµå¾ªè§„èŒƒ** | YYCÂ³ å›¢é˜Ÿæ ‡å‡†åŒ–è§„èŒƒ v1.0.0 |
| **ç‰ˆæœ¬å·** | v1.0.0 |
| **åˆ›å»ºæ—¥æœŸ** | 2025-01-30 |
| **ä½œè€…** | YYCÂ³ Team |
| **æ›´æ–°æ—¥æœŸ** | 2025-01-30 |

---

## ğŸ“‘ ç›®å½•

1. [ç°åº¦å‘å¸ƒæ¦‚è¿°](#1-ç°åº¦å‘å¸ƒæ¦‚è¿°)
2. [ç°åº¦å‘å¸ƒç­–ç•¥](#2-ç°åº¦å‘å¸ƒç­–ç•¥)
3. [æµé‡æ§åˆ¶](#3-æµé‡æ§åˆ¶)
4. [ç›‘æ§ä¸è§‚å¯Ÿ](#4-ç›‘æ§ä¸è§‚å¯Ÿ)
5. [å›æ»šæœºåˆ¶](#5-å›æ»šæœºåˆ¶)
6. [é£é™©æ§åˆ¶](#6-é£é™©æ§åˆ¶)
7. [è‡ªåŠ¨åŒ–å·¥å…·](#7-è‡ªåŠ¨åŒ–å·¥å…·)
8. [æœ€ä½³å®è·µ](#8-æœ€ä½³å®è·µ)
9. [å¸¸è§é—®é¢˜](#9-å¸¸è§é—®é¢˜)
10. [æ¡ˆä¾‹åˆ†æ](#10-æ¡ˆä¾‹åˆ†æ)

---

## 1. æ¦‚è¿°

### 1.1 åŠŸèƒ½è¯´æ˜

### 1.2 æŠ€æœ¯æ ˆ

### 1.3 å¼€å‘ç¯å¢ƒ

## 2. å®ç°æ–¹æ¡ˆ

### 2.1 ä»£ç ç»“æ„

### 2.2 æ ¸å¿ƒé€»è¾‘

### 2.3 æ•°æ®å¤„ç†

## 3. æ¥å£æ–‡æ¡£

### 3.1 APIæ¥å£

### 3.2 è¯·æ±‚å‚æ•°

### 3.3 å“åº”æ ¼å¼

## 4. æµ‹è¯•æ–¹æ¡ˆ

### 4.1 å•å…ƒæµ‹è¯•

### 4.2 é›†æˆæµ‹è¯•

### 4.3 æµ‹è¯•ç”¨ä¾‹

## 5. éƒ¨ç½²æŒ‡å—

### 5.1 ç¯å¢ƒå‡†å¤‡

### 5.2 éƒ¨ç½²æ­¥éª¤

### 5.3 éªŒè¯æ–¹æ³•

## 6. å¸¸è§é—®é¢˜

### 6.1 é—®é¢˜æ’æŸ¥

### 6.2 è§£å†³æ–¹æ¡ˆ

## 1. ç°åº¦å‘å¸ƒæ¦‚è¿°

### 1.1 ç°åº¦å‘å¸ƒå®šä¹‰

**ç°åº¦å‘å¸ƒ**ï¼ˆåˆç§°é‡‘ä¸é›€å‘å¸ƒï¼‰æ˜¯ä¸€ç§è½¯ä»¶å‘å¸ƒç­–ç•¥ï¼Œé€šè¿‡å°†æ–°ç‰ˆæœ¬é€æ­¥å‘å¸ƒç»™ä¸€å°éƒ¨åˆ†ç”¨æˆ·ï¼Œåœ¨éªŒè¯æ–°ç‰ˆæœ¬ç¨³å®šæ€§å’Œæ€§èƒ½åï¼Œå†é€æ­¥æ‰©å¤§å‘å¸ƒèŒƒå›´ï¼Œæœ€ç»ˆå…¨é‡å‘å¸ƒã€‚

**æ ¸å¿ƒä»·å€¼**
- é™ä½å‘å¸ƒé£é™©
- å¿«é€Ÿå‘ç°é—®é¢˜
- æœ€å°åŒ–å½±å“èŒƒå›´
- æé«˜å‘å¸ƒä¿¡å¿ƒ
- ä¿éšœç”¨æˆ·ä½“éªŒ

### 1.2 ç°åº¦å‘å¸ƒæµç¨‹

```mermaid
graph TD
    A[å¼€å§‹ç°åº¦å‘å¸ƒ] --> B[å‡†å¤‡é˜¶æ®µ]
    B --> C[å‘å¸ƒå‡†å¤‡]
    C --> D[å°èŒƒå›´å‘å¸ƒ]
    D --> E[ç›‘æ§è§‚å¯Ÿ]
    E --> F{éªŒè¯é€šè¿‡?}
    F -->|å¦| G[å›æ»š]
    G --> H[åˆ†æé—®é¢˜]
    H --> I[ä¿®å¤é—®é¢˜]
    I --> D
    F -->|æ˜¯| J[æ‰©å¤§èŒƒå›´]
    J --> K{å…¨é‡å‘å¸ƒ?}
    K -->|å¦| E
    K -->|æ˜¯| L[å…¨é‡å‘å¸ƒ]
    L --> M[æ¸…ç†æ—§ç‰ˆæœ¬]
    M --> N[å‘å¸ƒå®Œæˆ]
```

### 1.3 é€‚ç”¨åœºæ™¯

**é€‚åˆç°åº¦å‘å¸ƒçš„åœºæ™¯**
- æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½æ›´æ–°
- æ¶æ„é‡å¤§è°ƒæ•´
- æ€§èƒ½ä¼˜åŒ–å‘å¸ƒ
- å®‰å…¨è¡¥ä¸å‘å¸ƒ
- æ–°åŠŸèƒ½è¯•ç‚¹

**ä¸é€‚åˆç°åº¦å‘å¸ƒçš„åœºæ™¯**
- æ•°æ®åº“ç»“æ„å˜æ›´
- é…ç½®ä¸­å¿ƒå˜æ›´
- ä¾èµ–æœåŠ¡å‡çº§
- ç´§æ€¥å®‰å…¨ä¿®å¤
- ç®€å•bugä¿®å¤

---

## 2. ç°åº¦å‘å¸ƒç­–ç•¥

### 2.1 æµé‡æ¯”ä¾‹ç­–ç•¥

**ç­–ç•¥ç±»å‹**

| ç­–ç•¥ | æè¿° | é€‚ç”¨åœºæ™¯ | é£é™©ç­‰çº§ |
|------|------|----------|----------|
| å›ºå®šæ¯”ä¾‹ | æŒ‰å›ºå®šç™¾åˆ†æ¯”åˆ†é…æµé‡ | ç¨³å®šç‰ˆæœ¬æ›´æ–° | ä½ |
| é€æ­¥é€’å¢ | ä»å°æ¯”ä¾‹é€æ­¥å¢åŠ åˆ°å…¨é‡ | é‡è¦åŠŸèƒ½å‘å¸ƒ | ä¸­ |
| é˜¶æ¢¯å¼ | æŒ‰é˜¶æ®µé€’å¢æµé‡ | å¤æ‚ç³»ç»Ÿå‡çº§ | ä¸­ |
| æ™ºèƒ½è°ƒæ•´ | æ ¹æ®ç›‘æ§æŒ‡æ ‡åŠ¨æ€è°ƒæ•´ | æ€§èƒ½æ•æ„Ÿåœºæ™¯ | é«˜ |

**å›ºå®šæ¯”ä¾‹ç­–ç•¥**

```yaml
# Istioæµé‡è§„åˆ™
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: yyc3-web
spec:
  hosts:
  - yyc3-web
  http:
  - route:
    - destination:
        host: yyc3-web
        subset: v1
      weight: 90  # æ—§ç‰ˆæœ¬90%
    - destination:
        host: yyc3-web
        subset: v2
      weight: 10  # æ–°ç‰ˆæœ¬10%
```

**é€æ­¥é€’å¢ç­–ç•¥**

```typescript
// ç°åº¦å‘å¸ƒæ§åˆ¶å™¨
interface CanaryConfig {
  initialWeight: number;    // åˆå§‹æµé‡ç™¾åˆ†æ¯”
  increment: number;        // æ¯æ¬¡é€’å¢é‡
  interval: number;         // é€’å¢é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
  maxWeight: number;        // æœ€å¤§æµé‡ç™¾åˆ†æ¯”
  successThreshold: number; // æˆåŠŸé˜ˆå€¼
}

class CanaryController {
  async executeCanary(config: CanaryConfig) {
    let currentWeight = config.initialWeight;
    
    while (currentWeight <= config.maxWeight) {
      // æ›´æ–°æµé‡æƒé‡
      await this.updateTrafficWeight(currentWeight);
      
      // ç­‰å¾…è§‚å¯ŸæœŸ
      await this.sleep(config.interval * 60 * 1000);
      
      // æ£€æŸ¥ç›‘æ§æŒ‡æ ‡
      const metrics = await this.getMetrics();
      
      if (metrics.errorRate > config.successThreshold) {
        throw new Error('ç°åº¦å‘å¸ƒå¤±è´¥ï¼Œè§¦å‘å›æ»š');
      }
      
      // é€’å¢æµé‡
      currentWeight += config.increment;
    }
    
    // å…¨é‡å‘å¸ƒ
    await this.fullRelease();
  }
  
  private async updateTrafficWeight(weight: number) {
    // æ›´æ–°Istio/Nginxæµé‡é…ç½®
    console.log(`æµé‡æƒé‡æ›´æ–°ä¸º: ${weight}%`);
  }
  
  private async getMetrics() {
    // è·å–ç›‘æ§æŒ‡æ ‡
    return {
      errorRate: 0.01,
      responseTime: 100,
      throughput: 1000
    };
  }
  
  private async fullRelease() {
    // å…¨é‡å‘å¸ƒæ–°ç‰ˆæœ¬
    console.log('å…¨é‡å‘å¸ƒå®Œæˆ');
  }
  
  private sleep(ms: number) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### 2.2 ç”¨æˆ·ç‰¹å¾ç­–ç•¥

**åŸºäºç”¨æˆ·æ ‡ç­¾**

```typescript
// ç”¨æˆ·ç‰¹å¾è·¯ç”±
interface UserFeature {
  userId: string;
  userType: 'internal' | 'vip' | 'normal';
  region: string;
  device: 'mobile' | 'desktop';
  version: string;
}

class FeatureRouter {
  private canaryUsers: Set<string> = new Set();
  
  // æ·»åŠ ç°åº¦ç”¨æˆ·
  addCanaryUser(userId: string) {
    this.canaryUsers.add(userId);
  }
  
  // åˆ¤æ–­æ˜¯å¦è·¯ç”±åˆ°æ–°ç‰ˆæœ¬
  shouldRouteToCanary(user: UserFeature): boolean {
    // 1. å†…éƒ¨ç”¨æˆ·ä¼˜å…ˆ
    if (user.userType === 'internal') {
      return true;
    }
    
    // 2. VIPç”¨æˆ·
    if (user.userType === 'vip' && this.canaryUsers.has(user.userId)) {
      return true;
    }
    
    // 3. ç‰¹å®šåœ°åŒº
    if (user.region === 'test-region') {
      return true;
    }
    
    // 4. ç‰¹å®šè®¾å¤‡
    if (user.device === 'mobile') {
      return true;
    }
    
    return false;
  }
  
  // è·¯ç”±è¯·æ±‚
  routeRequest(user: UserFeature): string {
    return this.shouldRouteToCanary(user) ? 'v2' : 'v1';
  }
}
```

**åŸºäºç”¨æˆ·åˆ†ç¾¤**

```typescript
// ç”¨æˆ·åˆ†ç¾¤ç­–ç•¥
interface UserSegment {
  name: string;
  criteria: (user: UserFeature) => boolean;
  canaryPercentage: number;
}

class SegmentCanary {
  private segments: UserSegment[] = [
    {
      name: 'internal',
      criteria: (user) => user.userType === 'internal',
      canaryPercentage: 100
    },
    {
      name: 'vip',
      criteria: (user) => user.userType === 'vip',
      canaryPercentage: 20
    },
    {
      name: 'mobile',
      criteria: (user) => user.device === 'mobile',
      canaryPercentage: 10
    },
    {
      name: 'normal',
      criteria: (user) => user.userType === 'normal',
      canaryPercentage: 5
    }
  ];
  
  // æ ¹æ®åˆ†ç¾¤è·¯ç”±
  routeBySegment(user: UserFeature): string {
    const segment = this.segments.find(seg => seg.criteria(user));
    
    if (!segment) {
      return 'v1';
    }
    
    // ä½¿ç”¨ç”¨æˆ·IDå“ˆå¸Œç¡®ä¿ä¸€è‡´æ€§
    const hash = this.hashUserId(user.userId);
    const shouldRoute = hash < segment.canaryPercentage;
    
    return shouldRoute ? 'v2' : 'v1';
  }
  
  private hashUserId(userId: string): number {
    // ç®€å•å“ˆå¸Œå‡½æ•°
    let hash = 0;
    for (let i = 0; i < userId.length; i++) {
      hash = ((hash << 5) - hash) + userId.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash) % 100;
  }
}
```

### 2.3 Headerè·¯ç”±ç­–ç•¥

**åŸºäºHTTP Header**

```yaml
# Istio Headerè·¯ç”±
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: yyc3-web
spec:
  hosts:
  - yyc3-web
  http:
  # ç°åº¦æµé‡
  - match:
    - headers:
        x-canary:
          exact: "true"
    route:
    - destination:
        host: yyc3-web
        subset: v2
  # æ­£å¸¸æµé‡
  - route:
    - destination:
        host: yyc3-web
        subset: v1
```

**Nginx Headerè·¯ç”±**

```nginx
# Nginxç°åº¦å‘å¸ƒé…ç½®
upstream yyc3_v1 {
    server yyc3-web-v1:3200;
}

upstream yyc3_v2 {
    server yyc3-web-v2:3200;
}

server {
    listen 80;
    server_name yyc3.example.com;
    
    location / {
        # æ£€æŸ¥ç°åº¦Header
        if ($http_x_canary = "true") {
            proxy_pass http://yyc3_v2;
            break;
        }
        
        # é»˜è®¤è·¯ç”±åˆ°v1
        proxy_pass http://yyc3_v1;
        
        # ä»£ç†å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

---

## 3. æµé‡æ§åˆ¶

### 3.1 Kubernetesæµé‡æ§åˆ¶

**Serviceæµé‡æ§åˆ¶**

```yaml
# å¤šç‰ˆæœ¬Service
apiVersion: v1
kind: Service
metadata:
  name: yyc3-web
spec:
  selector:
    app: yyc3-web
  ports:
  - port: 3200
    targetPort: 3200
---
apiVersion: v1
kind: Service
metadata:
  name: yyc3-web-canary
spec:
  selector:
    app: yyc3-web
    version: v2
  ports:
  - port: 3200
    targetPort: 3200
```

**Ingressæµé‡æ§åˆ¶**

```yaml
# Ingressç°åº¦é…ç½®
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: yyc3-web
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "10"
spec:
  rules:
  - host: yyc3.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: yyc3-web-canary
            port:
              number: 3200
```

### 3.2 åº”ç”¨å±‚æµé‡æ§åˆ¶

**Next.jsåº”ç”¨å±‚è·¯ç”±**

```typescript
// app/api/feature-flag/route.ts
import { NextRequest, NextResponse } from 'next/server';

interface FeatureFlag {
  name: string;
  enabled: boolean;
  percentage: number;
  whitelistedUsers: string[];
}

class FeatureFlagService {
  private flags: Map<string, FeatureFlag> = new Map();
  
  constructor() {
    // åˆå§‹åŒ–åŠŸèƒ½å¼€å…³
    this.flags.set('new-ui', {
      name: 'new-ui',
      enabled: true,
      percentage: 10,
      whitelistedUsers: ['user1', 'user2']
    });
  }
  
  // æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
  isFeatureEnabled(featureName: string, userId: string): boolean {
    const flag = this.flags.get(featureName);
    
    if (!flag || !flag.enabled) {
      return false;
    }
    
    // ç™½åå•ç”¨æˆ·
    if (flag.whitelistedUsers.includes(userId)) {
      return true;
    }
    
    // åŸºäºç™¾åˆ†æ¯”
    const hash = this.hashUserId(userId);
    return hash < flag.percentage;
  }
  
  private hashUserId(userId: string): number {
    let hash = 0;
    for (let i = 0; i < userId.length; i++) {
      hash = ((hash << 5) - hash) + userId.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash) % 100;
  }
}

export async function GET(request: NextRequest) {
  const featureFlagService = new FeatureFlagService();
  const userId = request.headers.get('x-user-id') || 'anonymous';
  const featureName = request.nextUrl.searchParams.get('feature');
  
  if (!featureName) {
    return NextResponse.json({ error: 'Feature name required' }, { status: 400 });
  }
  
  const enabled = featureFlagService.isFeatureEnabled(featureName, userId);
  
  return NextResponse.json({
    feature: featureName,
    enabled,
    userId
  });
}
```

**ä¸­é—´ä»¶æµé‡æ§åˆ¶**

```typescript
// middleware.ts
import { NextRequest, NextResponse } from 'next/server';

class CanaryMiddleware {
  private canaryPercentage = 10;
  private canaryUsers = new Set(['user1', 'user2', 'user3']);
  
  // åˆ¤æ–­æ˜¯å¦è·¯ç”±åˆ°ç°åº¦ç‰ˆæœ¬
  shouldRouteToCanary(userId: string): boolean {
    // ç™½åå•ç”¨æˆ·
    if (this.canaryUsers.has(userId)) {
      return true;
    }
    
    // åŸºäºç™¾åˆ†æ¯”
    const hash = this.hashUserId(userId);
    return hash < this.canaryPercentage;
  }
  
  private hashUserId(userId: string): number {
    let hash = 0;
    for (let i = 0; i < userId.length; i++) {
      hash = ((hash << 5) - hash) + userId.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash) % 100;
  }
}

export function middleware(request: NextRequest) {
  const canaryMiddleware = new CanaryMiddleware();
  const userId = request.headers.get('x-user-id') || 'anonymous';
  
  // æ·»åŠ ç°åº¦æ ‡è®°
  const response = NextResponse.next();
  
  if (canaryMiddleware.shouldRouteToCanary(userId)) {
    response.headers.set('x-canary', 'true');
  }
  
  return response;
}
```

### 3.3 æ•°æ®åº“æµé‡æ§åˆ¶

**è¯»å†™åˆ†ç¦»**

```yaml
# æ•°æ®åº“è¯»å†™åˆ†ç¦»é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: database-config
data:
  config.yaml: |
    databases:
      primary:
        host: postgres-primary.yyc3.svc.cluster.local
        port: 5432
        database: yyc3
        mode: read-write
      replica:
        host: postgres-replica.yyc3.svc.cluster.local
        port: 5432
        database: yyc3
        mode: read-only
      canary:
        host: postgres-canary.yyc3.svc.cluster.local
        port: 5432
        database: yyc3
        mode: read-write
```

**æ•°æ®åº“è·¯ç”±**

```typescript
// lib/database-router.ts
interface DatabaseConfig {
  host: string;
  port: number;
  database: string;
  mode: 'read-write' | 'read-only';
}

class DatabaseRouter {
  private primary: DatabaseConfig;
  private replica: DatabaseConfig;
  private canary: DatabaseConfig;
  
  constructor(primary: DatabaseConfig, replica: DatabaseConfig, canary: DatabaseConfig) {
    this.primary = primary;
    this.replica = replica;
    this.canary = canary;
  }
  
  // è·å–æ•°æ®åº“è¿æ¥
  getConnection(isCanary: boolean, isReadOnly: boolean): DatabaseConfig {
    if (isCanary) {
      return this.canary;
    }
    
    if (isReadOnly) {
      return this.replica;
    }
    
    return this.primary;
  }
  
  // æ‰§è¡ŒæŸ¥è¯¢
  async query(sql: string, isCanary: boolean, isReadOnly: boolean) {
    const db = this.getConnection(isCanary, isReadOnly);
    // æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
    console.log(`Executing query on ${db.host}:${db.port}`);
    return {};
  }
}
```

---

## 4. ç›‘æ§ä¸è§‚å¯Ÿ

### 4.1 ç›‘æ§æŒ‡æ ‡

**æ ¸å¿ƒæŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | æŒ‡æ ‡åç§° | é˜ˆå€¼ | è¯´æ˜ |
|---------|---------|------|------|
| å¯ç”¨æ€§ | é”™è¯¯ç‡ | < 0.1% | HTTP 5xxé”™è¯¯æ¯”ä¾‹ |
| æ€§èƒ½ | å“åº”æ—¶é—´ | < 200ms | P95å“åº”æ—¶é—´ |
| æ€§èƒ½ | ååé‡ | > 1000 RPS | æ¯ç§’è¯·æ±‚æ•° |
| èµ„æº | CPUä½¿ç”¨ç‡ | < 80% | å®¹å™¨CPUä½¿ç”¨ç‡ |
| èµ„æº | å†…å­˜ä½¿ç”¨ç‡ | < 80% | å®¹å™¨å†…å­˜ä½¿ç”¨ç‡ |
| ä¸šåŠ¡ | è½¬åŒ–ç‡ | æ— æ˜æ˜¾ä¸‹é™ | ä¸šåŠ¡è½¬åŒ–ç‡ |
| ä¸šåŠ¡ | ç”¨æˆ·ç•™å­˜ | æ— æ˜æ˜¾ä¸‹é™ | ç”¨æˆ·ç•™å­˜ç‡ |

**Prometheusç›‘æ§è§„åˆ™**

```yaml
# prometheus-rules.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: canary-monitoring
  namespace: monitoring
spec:
  groups:
  - name: canary.rules
    rules:
    # é”™è¯¯ç‡ç›‘æ§
    - alert: HighErrorRate
      expr: |
        (
          sum(rate(http_requests_total{status=~"5..", version="v2"}[5m])) /
          sum(rate(http_requests_total{version="v2"}[5m]))
        ) > 0.01
      for: 5m
      labels:
        severity: critical
        canary: "true"
      annotations:
        summary: "ç°åº¦ç‰ˆæœ¬é”™è¯¯ç‡è¿‡é«˜"
        description: "ç°åº¦ç‰ˆæœ¬é”™è¯¯ç‡è¶…è¿‡1%: {{ $value | humanizePercentage }}"
    
    # å“åº”æ—¶é—´ç›‘æ§
    - alert: HighResponseTime
      expr: |
        histogram_quantile(0.95,
          sum(rate(http_request_duration_seconds_bucket{version="v2"}[5m])) by (le)
        ) > 0.2
      for: 5m
      labels:
        severity: warning
        canary: "true"
      annotations:
        summary: "ç°åº¦ç‰ˆæœ¬å“åº”æ—¶é—´è¿‡é•¿"
        description: "ç°åº¦ç‰ˆæœ¬P95å“åº”æ—¶é—´è¶…è¿‡200ms: {{ $value }}s"
    
    # èµ„æºä½¿ç”¨ç›‘æ§
    - alert: HighResourceUsage
      expr: |
        container_memory_usage_bytes{version="v2"} /
        container_spec_memory_limit_bytes{version="v2"} > 0.8
      for: 5m
      labels:
        severity: warning
        canary: "true"
      annotations:
        summary: "ç°åº¦ç‰ˆæœ¬èµ„æºä½¿ç”¨è¿‡é«˜"
        description: "ç°åº¦ç‰ˆæœ¬å†…å­˜ä½¿ç”¨è¶…è¿‡80%: {{ $value | humanizePercentage }}"
```

### 4.2 å‘Šè­¦è§„åˆ™

**å‘Šè­¦é…ç½®**

```yaml
# alertmanager-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m
    
    route:
      group_by: ['alertname', 'canary']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 5m
      receiver: 'default'
      
      routes:
      - match:
          canary: "true"
        receiver: 'canary-alerts'
      
    receivers:
    - name: 'default'
      slack_configs:
      - api_url: 'https://hooks.slack.com/services/XXX/YYY/ZZZ'
        channel: '#alerts'
    
    - name: 'canary-alerts'
      slack_configs:
      - api_url: 'https://hooks.slack.com/services/XXX/YYY/ZZZ'
        channel: '#canary-alerts'
        title: 'ğŸš¨ ç°åº¦å‘å¸ƒå‘Šè­¦: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          **å‘Šè­¦**: {{ .Annotations.summary }}
          **æè¿°**: {{ .Annotations.description }}
          **ä¸¥é‡æ€§**: {{ .Labels.severity }}
          **æ—¶é—´**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
      
      email_configs:
      - to: 'admin@0379.email'
        from: 'alertmanager@yyc3.com'
        headers:
          Subject: 'ğŸš¨ ç°åº¦å‘å¸ƒå‘Šè­¦: {{ .GroupLabels.alertname }}'
```

### 4.3 æ—¥å¿—åˆ†æ

**æ—¥å¿—æ”¶é›†**

```yaml
# fluentd-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: logging
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head true
      <parse>
        @type json
      </parse>
    </source>
    
    <filter kubernetes.**>
      @type kubernetes_metadata
    </filter>
    
    <filter kubernetes.**>
      @type grep
      <regexp>
        key $.kubernetes.labels.version
        pattern /^v2$/
      </regexp>
    </filter>
    
    <match kubernetes.**>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      logstash_format true
      logstash_prefix canary-logs
      <buffer>
        @type file
        path /var/log/fluentd-buffers/kubernetes.system.buffer
        flush_mode interval
        flush_interval 5s
      </buffer>
    </match>
```

**æ—¥å¿—åˆ†æè„šæœ¬**

```bash
#!/bin/bash

# ç°åº¦å‘å¸ƒæ—¥å¿—åˆ†æè„šæœ¬

NAMESPACE=${1:-"yyc3-production"}
VERSION=${2:-"v2"}

echo "=== ç°åº¦å‘å¸ƒæ—¥å¿—åˆ†æ ==="
echo "å‘½åç©ºé—´: $NAMESPACE"
echo "ç‰ˆæœ¬: $VERSION"
echo ""

# 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
echo "1. é”™è¯¯æ—¥å¿—..."
kubectl logs -n $NAMESPACE -l version=$VERSION --tail=100 | grep -i "error\|exception" || echo "æ²¡æœ‰å‘ç°é”™è¯¯"

# 2. æŸ¥çœ‹è­¦å‘Šæ—¥å¿—
echo ""
echo "2. è­¦å‘Šæ—¥å¿—..."
kubectl logs -n $NAMESPACE -l version=$VERSION --tail=100 | grep -i "warning" || echo "æ²¡æœ‰å‘ç°è­¦å‘Š"

# 3. ç»Ÿè®¡é”™è¯¯æ•°é‡
echo ""
echo "3. é”™è¯¯ç»Ÿè®¡..."
ERROR_COUNT=$(kubectl logs -n $NAMESPACE -l version=$VERSION | grep -i "error" | wc -l)
echo "é”™è¯¯æ€»æ•°: $ERROR_COUNT"

# 4. ç»Ÿè®¡å“åº”æ—¶é—´
echo ""
echo "4. å“åº”æ—¶é—´ç»Ÿè®¡..."
kubectl logs -n $NAMESPACE -l version=$VERSION | grep "duration" | awk -F'duration=' '{print $2}' | awk '{sum+=$1; count++} END {print "å¹³å‡å“åº”æ—¶é—´:", sum/count, "ms"}'

# 5. ç»Ÿè®¡è¯·æ±‚é‡
echo ""
echo "5. è¯·æ±‚é‡ç»Ÿè®¡..."
REQUEST_COUNT=$(kubectl logs -n $NAMESPACE -l version=$VERSION | grep "request" | wc -l)
echo "æ€»è¯·æ±‚æ•°: $REQUEST_COUNT"

# 6. ç”Ÿæˆæ—¥å¿—æŠ¥å‘Š
echo ""
echo "6. ç”Ÿæˆæ—¥å¿—æŠ¥å‘Š..."
cat > canary-log-report.md << EOF
# ç°åº¦å‘å¸ƒæ—¥å¿—æŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯
- å‘½åç©ºé—´: $NAMESPACE
- ç‰ˆæœ¬: $VERSION
- åˆ†ææ—¶é—´: $(date)

## ç»Ÿè®¡æ•°æ®
- é”™è¯¯æ€»æ•°: $ERROR_COUNT
- æ€»è¯·æ±‚æ•°: $REQUEST_COUNT
- é”™è¯¯ç‡: $(echo "scale=2; $ERROR_COUNT * 100 / $REQUEST_COUNT" | bc)%

## è¯¦ç»†æ—¥å¿—
EOF

echo "æ—¥å¿—æŠ¥å‘Šå·²ç”Ÿæˆ: canary-log-report.md"
```

---

## 5. å›æ»šæœºåˆ¶

### 5.1 è‡ªåŠ¨å›æ»š

**Prometheusè‡ªåŠ¨å›æ»š**

```yaml
# è‡ªåŠ¨å›æ»šè§„åˆ™
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: auto-rollback
  namespace: monitoring
spec:
  groups:
  - name: rollback.rules
    rules:
    # é”™è¯¯ç‡è§¦å‘å›æ»š
    - alert: AutoRollbackOnError
      expr: |
        (
          sum(rate(http_requests_total{status=~"5..", version="v2"}[5m])) /
          sum(rate(http_requests_total{version="v2"}[5m]))
        ) > 0.05
      for: 10m
      labels:
        severity: critical
        action: rollback
      annotations:
        summary: "è§¦å‘è‡ªåŠ¨å›æ»š"
        description: "ç°åº¦ç‰ˆæœ¬é”™è¯¯ç‡è¶…è¿‡5%ï¼Œè§¦å‘è‡ªåŠ¨å›æ»š"
```

**è‡ªåŠ¨å›æ»šè„šæœ¬**

```bash
#!/bin/bash

# è‡ªåŠ¨å›æ»šè„šæœ¬

NAMESPACE=${1:-"yyc3-production"}
DEPLOYMENT=${2:-"yyc3-web"}

echo "=== è‡ªåŠ¨å›æ»š ==="
echo "å‘½åç©ºé—´: $NAMESPACE"
echo "éƒ¨ç½²: $DEPLOYMENT"
echo ""

# 1. æ£€æŸ¥å½“å‰ç‰ˆæœ¬
echo "1. æ£€æŸ¥å½“å‰ç‰ˆæœ¬..."
kubectl get deployment $DEPLOYMENT -n $NAMESPACE -o jsonpath='{.spec.template.metadata.labels.version}'

# 2. è·å–å›æ»šå†å²
echo ""
echo "2. è·å–å›æ»šå†å²..."
kubectl rollout history deployment/$DEPLOYMENT -n $NAMESPACE

# 3. æ‰§è¡Œå›æ»š
echo ""
echo "3. æ‰§è¡Œå›æ»š..."
kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE

# 4. ç­‰å¾…å›æ»šå®Œæˆ
echo ""
echo "4. ç­‰å¾…å›æ»šå®Œæˆ..."
kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=5m

# 5. éªŒè¯å›æ»š
echo ""
echo "5. éªŒè¯å›æ»š..."
kubectl get pods -n $NAMESPACE -l app=$DEPLOYMENT

echo ""
echo "=== å›æ»šå®Œæˆ ==="
```

### 5.2 æ‰‹åŠ¨å›æ»š

**å›æ»šå‘½ä»¤**

```bash
#!/bin/bash

# æ‰‹åŠ¨å›æ»šè„šæœ¬

NAMESPACE=${1:-"yyc3-production"}
DEPLOYMENT=${2:-"yyc3-web"}
REVISION=${3:-""}

echo "=== æ‰‹åŠ¨å›æ»š ==="
echo "å‘½åç©ºé—´: $NAMESPACE"
echo "éƒ¨ç½²: $DEPLOYMENT"
echo "ç‰ˆæœ¬: $REVISION"
echo ""

# 1. ç¡®è®¤å›æ»š
read -p "ç¡®è®¤è¦å›æ»šå—? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "å–æ¶ˆå›æ»š"
  exit 1
fi

# 2. æŸ¥çœ‹å›æ»šå†å²
echo "å›æ»šå†å²:"
kubectl rollout history deployment/$DEPLOYMENT -n $NAMESPACE

# 3. æ‰§è¡Œå›æ»š
if [ -z "$REVISION" ]; then
  echo "å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬..."
  kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE
else
  echo "å›æ»šåˆ°ç‰ˆæœ¬ $REVISION..."
  kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE --to-revision=$REVISION
fi

# 4. ç­‰å¾…å›æ»šå®Œæˆ
echo "ç­‰å¾…å›æ»šå®Œæˆ..."
kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=5m

# 5. éªŒè¯å›æ»š
echo "éªŒè¯å›æ»š..."
kubectl get pods -n $NAMESPACE -l app=$DEPLOYMENT

echo ""
echo "=== å›æ»šå®Œæˆ ==="
```

### 5.3 æ•°æ®åº“å›æ»š

**æ•°æ®åº“è¿ç§»å›æ»š**

```typescript
// lib/database-migration.ts
interface Migration {
  version: string;
  name: string;
  up: () => Promise<void>;
  down: () => Promise<void>;
}

class DatabaseMigration {
  private migrations: Migration[] = [];
  private currentVersion: string = 'v1';
  
  // æ³¨å†Œè¿ç§»
  registerMigration(migration: Migration) {
    this.migrations.push(migration);
  }
  
  // æ‰§è¡Œè¿ç§»
  async migrate(targetVersion: string) {
    const currentIndex = this.migrations.findIndex(m => m.version === this.currentVersion);
    const targetIndex = this.migrations.findIndex(m => m.version === targetVersion);
    
    if (currentIndex === -1 || targetIndex === -1) {
      throw new Error('Invalid version');
    }
    
    if (targetIndex > currentIndex) {
      // å‘å‰è¿ç§»
      for (let i = currentIndex + 1; i <= targetIndex; i++) {
        await this.migrations[i].up();
        console.log(`Migration ${this.migrations[i].version} completed`);
      }
    } else if (targetIndex < currentIndex) {
      // å‘åå›æ»š
      for (let i = currentIndex; i > targetIndex; i--) {
        await this.migrations[i].down();
        console.log(`Rollback ${this.migrations[i].version} completed`);
      }
    }
    
    this.currentVersion = targetVersion;
  }
  
  // å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
  async rollback(targetVersion: string) {
    console.log(`Rolling back from ${this.currentVersion} to ${targetVersion}`);
    await this.migrate(targetVersion);
    console.log('Rollback completed');
  }
}
```

---

## 6. é£é™©æ§åˆ¶

### 6.1 é£é™©è¯„ä¼°

**é£é™©çŸ©é˜µ**

| å½±å“ç¨‹åº¦ | æ¦‚ç‡ | é£é™©ç­‰çº§ | åº”å¯¹æªæ–½ |
|---------|------|---------|---------|
| é«˜ | é«˜ | ä¸¥é‡ | ç«‹å³å›æ»šï¼Œè¯¦ç»†åˆ†æ |
| é«˜ | ä¸­ | é«˜ | å‡†å¤‡å›æ»šï¼Œå¯†åˆ‡ç›‘æ§ |
| é«˜ | ä½ | ä¸­ | å¢åŠ ç›‘æ§ï¼Œå‡†å¤‡é¢„æ¡ˆ |
| ä¸­ | é«˜ | é«˜ | å‡†å¤‡å›æ»šï¼Œå¢åŠ è§‚å¯Ÿ |
| ä¸­ | ä¸­ | ä¸­ | æ­£å¸¸ç›‘æ§ï¼Œå®šæœŸæ£€æŸ¥ |
| ä¸­ | ä½ | ä½ | å¸¸è§„ç›‘æ§ |
| ä½ | é«˜ | ä¸­ | å¢åŠ ç›‘æ§ |
| ä½ | ä¸­ | ä½ | å¸¸è§„ç›‘æ§ |
| ä½ | ä½ | ä½ | æ— éœ€ç‰¹æ®Šå¤„ç† |

**é£é™©è¯„ä¼°è„šæœ¬**

```typescript
// lib/risk-assessment.ts
interface RiskFactor {
  name: string;
  impact: 'high' | 'medium' | 'low';
  probability: 'high' | 'medium' | 'low';
  mitigation: string;
}

class RiskAssessment {
  private riskFactors: RiskFactor[] = [
    {
      name: 'æ€§èƒ½ä¸‹é™',
      impact: 'high',
      probability: 'medium',
      mitigation: 'å‡†å¤‡å›æ»šï¼Œç›‘æ§æ€§èƒ½æŒ‡æ ‡'
    },
    {
      name: 'é”™è¯¯ç‡ä¸Šå‡',
      impact: 'high',
      probability: 'low',
      mitigation: 'è®¾ç½®å‘Šè­¦ï¼Œå‡†å¤‡å›æ»š'
    },
    {
      name: 'æ•°æ®ä¸ä¸€è‡´',
      impact: 'high',
      probability: 'low',
      mitigation: 'æ•°æ®å¤‡ä»½ï¼Œå‡†å¤‡å›æ»š'
    },
    {
      name: 'å…¼å®¹æ€§é—®é¢˜',
      impact: 'medium',
      probability: 'medium',
      mitigation: 'å…¼å®¹æ€§æµ‹è¯•ï¼Œç°åº¦éªŒè¯'
    }
  ];
  
  // è¯„ä¼°é£é™©ç­‰çº§
  assessRiskLevel(factor: RiskFactor): string {
    const impactScore = this.getScore(factor.impact);
    const probabilityScore = this.getScore(factor.probability);
    const totalScore = impactScore * probabilityScore;
    
    if (totalScore >= 9) {
      return 'ä¸¥é‡';
    } else if (totalScore >= 6) {
      return 'é«˜';
    } else if (totalScore >= 3) {
      return 'ä¸­';
    } else {
      return 'ä½';
    }
  }
  
  private getScore(level: string): number {
    switch (level) {
      case 'high': return 3;
      case 'medium': return 2;
      case 'low': return 1;
      default: return 0;
    }
  }
  
  // ç”Ÿæˆé£é™©è¯„ä¼°æŠ¥å‘Š
  generateReport(): string {
    let report = '# ç°åº¦å‘å¸ƒé£é™©è¯„ä¼°æŠ¥å‘Š\n\n';
    report += `è¯„ä¼°æ—¶é—´: ${new Date().toISOString()}\n\n`;
    report += '## é£é™©å› ç´ \n\n';
    
    this.riskFactors.forEach(factor => {
      const level = this.assessRiskLevel(factor);
      report += `### ${factor.name}\n`;
      report += `- å½±å“ç¨‹åº¦: ${factor.impact}\n`;
      report += `- å‘ç”Ÿæ¦‚ç‡: ${factor.probability}\n`;
      report += `- é£é™©ç­‰çº§: ${level}\n`;
      report += `- åº”å¯¹æªæ–½: ${factor.mitigation}\n\n`;
    });
    
    return report;
  }
}
```

### 6.2 ç†”æ–­æœºåˆ¶

**ç†”æ–­é…ç½®**

```yaml
# Hystrixç†”æ–­é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: circuit-breaker-config
data:
  config.yaml: |
    circuitBreakers:
      yyc3-web:
        enabled: true
        requestVolumeThreshold: 20
        errorThresholdPercentage: 50
        sleepWindowInMilliseconds: 5000
        timeoutInMilliseconds: 3000
```

**ç†”æ–­å®ç°**

```typescript
// lib/circuit-breaker.ts
interface CircuitBreakerConfig {
  failureThreshold: number;
  successThreshold: number;
  timeout: number;
  resetTimeout: number;
}

enum CircuitState {
  CLOSED = 'CLOSED',
  OPEN = 'OPEN',
  HALF_OPEN = 'HALF_OPEN'
}

class CircuitBreaker {
  private state: CircuitState = CircuitState.CLOSED;
  private failureCount = 0;
  private successCount = 0;
  private lastFailureTime = 0;
  private config: CircuitBreakerConfig;
  
  constructor(config: CircuitBreakerConfig) {
    this.config = config;
  }
  
  // æ‰§è¡Œè¯·æ±‚
  async execute<T>(fn: () => Promise<T>): Promise<T> {
    if (this.state === CircuitState.OPEN) {
      if (this.shouldAttemptReset()) {
        this.state = CircuitState.HALF_OPEN;
      } else {
        throw new Error('Circuit breaker is OPEN');
      }
    }
    
    try {
      const result = await fn();
      this.onSuccess();
      return result;
    } catch (error) {
      this.onFailure();
      throw error;
    }
  }
  
  private onSuccess() {
    if (this.state === CircuitState.HALF_OPEN) {
      this.successCount++;
      if (this.successCount >= this.config.successThreshold) {
        this.state = CircuitState.CLOSED;
        this.failureCount = 0;
        this.successCount = 0;
      }
    } else {
      this.failureCount = 0;
    }
  }
  
  private onFailure() {
    this.failureCount++;
    this.lastFailureTime = Date.now();
    
    if (this.failureCount >= this.config.failureThreshold) {
      this.state = CircuitState.OPEN;
    }
  }
  
  private shouldAttemptReset(): boolean {
    return Date.now() - this.lastFailureTime >= this.config.resetTimeout;
  }
  
  getState(): CircuitState {
    return this.state;
  }
}
```

### 6.3 é™æµæ§åˆ¶

**é™æµé…ç½®**

```yaml
# é™æµé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: rate-limit-config
data:
  config.yaml: |
    rateLimits:
      yyc3-web:
        requestsPerSecond: 1000
        burst: 100
        windowSize: 1
```

**é™æµå®ç°**

```typescript
// lib/rate-limiter.ts
interface RateLimitConfig {
  requestsPerSecond: number;
  burst: number;
  windowSize: number;
}

class RateLimiter {
  private tokens: number;
  private lastRefillTime: number;
  private config: RateLimitConfig;
  
  constructor(config: RateLimitConfig) {
    this.config = config;
    this.tokens = config.burst;
    this.lastRefillTime = Date.now();
  }
  
  // å°è¯•è·å–ä»¤ç‰Œ
  tryAcquire(): boolean {
    this.refill();
    
    if (this.tokens >= 1) {
      this.tokens--;
      return true;
    }
    
    return false;
  }
  
  // ç­‰å¾…è·å–ä»¤ç‰Œ
  async acquire(): Promise<void> {
    while (!this.tryAcquire()) {
      await this.sleep(10);
    }
  }
  
  private refill() {
    const now = Date.now();
    const elapsed = (now - this.lastRefillTime) / 1000;
    const tokensToAdd = elapsed * this.config.requestsPerSecond;
    
    this.tokens = Math.min(
      this.tokens + tokensToAdd,
      this.config.burst
    );
    
    this.lastRefillTime = now;
  }
  
  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

---

## 7. è‡ªåŠ¨åŒ–å·¥å…·

### 7.1 Argo Rollouts

**Argo Rolloutsé…ç½®**

```yaml
# rollout.yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: yyc3-web
spec:
  replicas: 5
  strategy:
    canary:
      steps:
      - setWeight: 10
      - pause: {duration: 10m}
      - setWeight: 30
      - pause: {duration: 10m}
      - setWeight: 50
      - pause: {duration: 10m}
      - setWeight: 100
      analysis:
        templates:
        - templateName: success-rate
        args:
        - name: service-name
          value: yyc3-web
  selector:
    matchLabels:
      app: yyc3-web
  template:
    metadata:
      labels:
        app: yyc3-web
    spec:
      containers:
      - name: web
        image: yyc3-web:v2
        ports:
        - containerPort: 3200
```

**åˆ†ææ¨¡æ¿**

```yaml
# analysis-template.yaml
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    interval: 5m
    count: 10
    successCondition: result[0] >= 0.95
    failureLimit: 3
    provider:
      prometheus:
        address: http://prometheus.monitoring.svc.cluster.local:9090
        query: |
          sum(rate(http_requests_total{service="{{args.service-name}}",status!~"5.."}[5m])) /
          sum(rate(http_requests_total{service="{{args.service-name}}"}[5m]))
```

### 7.2 Flagger

**Flaggeré…ç½®**

```yaml
# canary.yaml
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: yyc3-web
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: yyc3-web
  service:
    port: 3200
    targetPort: 3200
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 10
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m
    webhooks:
    - name: load-test
      url: http://flagger-loadtester/
      timeout: 5s
      metadata:
        cmd: "hey -z 1m -q 10 -c 2 http://yyc3-web-canary:3200/"
```

### 7.3 è‡ªå®šä¹‰è‡ªåŠ¨åŒ–å·¥å…·

**ç°åº¦å‘å¸ƒæ§åˆ¶å™¨**

```typescript
// lib/canary-controller.ts
interface CanaryConfig {
  deployment: string;
  namespace: string;
  initialWeight: number;
  increment: number;
  interval: number;
  maxWeight: number;
  successThreshold: {
    errorRate: number;
    responseTime: number;
  };
}

class CanaryController {
  private config: CanaryConfig;
  private currentWeight = 0;
  
  constructor(config: CanaryConfig) {
    this.config = config;
  }
  
  // æ‰§è¡Œç°åº¦å‘å¸ƒ
  async execute() {
    this.currentWeight = this.config.initialWeight;
    
    while (this.currentWeight <= this.config.maxWeight) {
      // æ›´æ–°æµé‡æƒé‡
      await this.updateWeight(this.currentWeight);
      
      // ç­‰å¾…è§‚å¯ŸæœŸ
      await this.sleep(this.config.interval * 60 * 1000);
      
      // æ£€æŸ¥æŒ‡æ ‡
      const metrics = await this.checkMetrics();
      
      if (!this.validateMetrics(metrics)) {
        // å›æ»š
        await this.rollback();
        throw new Error('ç°åº¦å‘å¸ƒå¤±è´¥');
      }
      
      // é€’å¢æƒé‡
      this.currentWeight += this.config.increment;
    }
    
    // å…¨é‡å‘å¸ƒ
    await this.fullRelease();
  }
  
  private async updateWeight(weight: number) {
    // æ›´æ–°Istio/Nginxæµé‡é…ç½®
    console.log(`æµé‡æƒé‡æ›´æ–°ä¸º: ${weight}%`);
  }
  
  private async checkMetrics() {
    // è·å–PrometheusæŒ‡æ ‡
    return {
      errorRate: 0.01,
      responseTime: 100
    };
  }
  
  private validateMetrics(metrics: any): boolean {
    return metrics.errorRate < this.config.successThreshold.errorRate &&
           metrics.responseTime < this.config.successThreshold.responseTime;
  }
  
  private async rollback() {
    console.log('æ‰§è¡Œå›æ»š...');
    // å›æ»šåˆ°æ—§ç‰ˆæœ¬
  }
  
  private async fullRelease() {
    console.log('å…¨é‡å‘å¸ƒ...');
    // å…¨é‡å‘å¸ƒæ–°ç‰ˆæœ¬
  }
  
  private sleep(ms: number) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

---

## 8. æœ€ä½³å®è·µ

### 8.1 å‘å¸ƒå‰æ£€æŸ¥

**æ£€æŸ¥æ¸…å•**

```bash
#!/bin/bash

# å‘å¸ƒå‰æ£€æŸ¥è„šæœ¬

echo "=== ç°åº¦å‘å¸ƒå‰æ£€æŸ¥ ==="

# 1. æ£€æŸ¥ä»£ç è´¨é‡
echo "1. æ£€æŸ¥ä»£ç è´¨é‡..."
npm run lint
npm run test

# 2. æ£€æŸ¥é•œåƒ
echo ""
echo "2. æ£€æŸ¥é•œåƒ..."
docker images yyc3-web:v2

# 3. æ£€æŸ¥é…ç½®
echo ""
echo "3. æ£€æŸ¥é…ç½®..."
kubectl get configmap -n yyc3-production
kubectl get secret -n yyc3-production

# 4. æ£€æŸ¥ä¾èµ–
echo ""
echo "4. æ£€æŸ¥ä¾èµ–..."
kubectl get pods -n yyc3-production

# 5. æ£€æŸ¥ç›‘æ§
echo ""
echo "5. æ£€æŸ¥ç›‘æ§..."
kubectl get pods -n monitoring

# 6. æ£€æŸ¥å‘Šè­¦
echo ""
echo "6. æ£€æŸ¥å‘Šè­¦..."
kubectl get prometheusrule -n monitoring

echo ""
echo "=== æ£€æŸ¥å®Œæˆ ==="
```

### 8.2 å‘å¸ƒæµç¨‹

**æ ‡å‡†æµç¨‹**

```mermaid
graph TD
    A[å¼€å§‹] --> B[å‘å¸ƒå‰æ£€æŸ¥]
    B --> C{æ£€æŸ¥é€šè¿‡?}
    C -->|å¦| D[ä¿®å¤é—®é¢˜]
    D --> B
    C -->|æ˜¯| E[å‡†å¤‡ç°åº¦å‘å¸ƒ]
    E --> F[å°èŒƒå›´å‘å¸ƒ]
    F --> G[ç›‘æ§è§‚å¯Ÿ]
    G --> H{éªŒè¯é€šè¿‡?}
    H -->|å¦| I[å›æ»š]
    I --> J[åˆ†æé—®é¢˜]
    J --> K[ä¿®å¤é—®é¢˜]
    K --> F
    H -->|æ˜¯| L[æ‰©å¤§èŒƒå›´]
    L --> M{å…¨é‡å‘å¸ƒ?}
    M -->|å¦| G
    M -->|æ˜¯| N[å…¨é‡å‘å¸ƒ]
    N --> O[æ¸…ç†æ—§ç‰ˆæœ¬]
    O --> P[å‘å¸ƒå®Œæˆ]
```

**å‘å¸ƒè„šæœ¬**

```bash
#!/bin/bash

# ç°åº¦å‘å¸ƒè„šæœ¬

NAMESPACE=${1:-"yyc3-production"}
DEPLOYMENT=${2:-"yyc3-web"}
IMAGE=${3:-"yyc3-web:v2"}

echo "=== ç°åº¦å‘å¸ƒ ==="
echo "å‘½åç©ºé—´: $NAMESPACE"
echo "éƒ¨ç½²: $DEPLOYMENT"
echo "é•œåƒ: $IMAGE"
echo ""

# 1. å‘å¸ƒå‰æ£€æŸ¥
echo "1. å‘å¸ƒå‰æ£€æŸ¥..."
./pre-release-check.sh

# 2. åˆ›å»ºç°åº¦éƒ¨ç½²
echo ""
echo "2. åˆ›å»ºç°åº¦éƒ¨ç½²..."
kubectl apply -f canary-deployment.yaml

# 3. é…ç½®æµé‡
echo ""
echo "3. é…ç½®æµé‡..."
kubectl apply -f canary-traffic.yaml

# 4. ç›‘æ§è§‚å¯Ÿ
echo ""
echo "4. ç›‘æ§è§‚å¯Ÿ..."
./monitor-canary.sh

# 5. æ‰©å¤§èŒƒå›´
echo ""
echo "5. æ‰©å¤§èŒƒå›´..."
kubectl patch virtualservice yyc3-web -p '{"spec":{"http":[{"route":[{"destination":{"host":"yyc3-web","subset":"v2"},"weight":30},{"destination":{"host":"yyc3-web","subset":"v1"},"weight":70}]}]}}'

# 6. å…¨é‡å‘å¸ƒ
echo ""
echo "6. å…¨é‡å‘å¸ƒ..."
kubectl set image deployment/$DEPLOYMENT web=$IMAGE -n $NAMESPACE

# 7. æ¸…ç†ç°åº¦
echo ""
echo "7. æ¸…ç†ç°åº¦..."
kubectl delete -f canary-deployment.yaml

echo ""
echo "=== å‘å¸ƒå®Œæˆ ==="
```

### 8.3 éªŒè¯è„šæœ¬

**éªŒè¯è„šæœ¬**

```bash
#!/bin/bash

# ç°åº¦å‘å¸ƒéªŒè¯è„šæœ¬

NAMESPACE=${1:-"yyc3-production"}
DEPLOYMENT=${2:-"yyc3-web"}

echo "=== ç°åº¦å‘å¸ƒéªŒè¯ ==="
echo "å‘½åç©ºé—´: $NAMESPACE"
echo "éƒ¨ç½²: $DEPLOYMENT"
echo ""

# 1. æ£€æŸ¥PodçŠ¶æ€
echo "1. æ£€æŸ¥PodçŠ¶æ€..."
kubectl get pods -n $NAMESPACE -l app=$DEPLOYMENT

# 2. æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo ""
echo "2. æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
kubectl get svc -n $NAMESPACE

# 3. æ£€æŸ¥æµé‡
echo ""
echo "3. æ£€æŸ¥æµé‡..."
kubectl get virtualservice -n $NAMESPACE

# 4. æ£€æŸ¥æŒ‡æ ‡
echo ""
echo "4. æ£€æŸ¥æŒ‡æ ‡..."
kubectl top pods -n $NAMESPACE

# 5. æµ‹è¯•æœåŠ¡
echo ""
echo "5. æµ‹è¯•æœåŠ¡..."
curl -I http://yyc3.example.com/health

# 6. æ£€æŸ¥æ—¥å¿—
echo ""
echo "6. æ£€æŸ¥æ—¥å¿—..."
kubectl logs -n $NAMESPACE -l app=$DEPLOYMENT --tail=50

echo ""
echo "=== éªŒè¯å®Œæˆ ==="
```

---

## 9. å¸¸è§é—®é¢˜

### 9.1 æµé‡åˆ†é…ä¸å‡

**é—®é¢˜æè¿°**
- ç°åº¦æµé‡æ¯”ä¾‹ä¸å‡†ç¡®
- æŸäº›ç”¨æˆ·æ€»æ˜¯è®¿é—®æ–°ç‰ˆæœ¬
- æµé‡åˆ†é…ä¸ç¬¦åˆé¢„æœŸ

**è§£å†³æ–¹æ¡ˆ**

```typescript
// ä¸€è‡´æ€§å“ˆå¸Œæµé‡åˆ†é…
class ConsistentHashRouter {
  private ring: Map<number, string> = new Map();
  private virtualNodes = 150;
  
  // æ·»åŠ èŠ‚ç‚¹
  addNode(node: string) {
    for (let i = 0; i < this.virtualNodes; i++) {
      const hash = this.hash(`${node}:${i}`);
      this.ring.set(hash, node);
    }
  }
  
  // è·å–èŠ‚ç‚¹
  getNode(key: string): string {
    if (this.ring.size === 0) {
      throw new Error('No nodes available');
    }
    
    const hash = this.hash(key);
    const sortedHashes = Array.from(this.ring.keys()).sort((a, b) => a - b);
    
    for (const ringHash of sortedHashes) {
      if (ringHash >= hash) {
        return this.ring.get(ringHash)!;
      }
    }
    
    return this.ring.get(sortedHashes[0])!;
  }
  
  private hash(str: string): number {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash);
  }
}
```

### 9.2 ç›‘æ§æŒ‡æ ‡ä¸å‡†ç¡®

**é—®é¢˜æè¿°**
- ç›‘æ§æŒ‡æ ‡å»¶è¿Ÿ
- æŒ‡æ ‡æ•°æ®ä¸å‡†ç¡®
- å‘Šè­¦è¯¯æŠ¥

**è§£å†³æ–¹æ¡ˆ**

```typescript
// æŒ‡æ ‡é‡‡é›†ä¼˜åŒ–
class MetricsCollector {
  private metrics: Map<string, number[]> = new Map();
  private windowSize = 60; // 60ç§’çª—å£
  
  // è®°å½•æŒ‡æ ‡
  recordMetric(name: string, value: number) {
    if (!this.metrics.has(name)) {
      this.metrics.set(name, []);
    }
    
    const values = this.metrics.get(name)!;
    values.push({ value, timestamp: Date.now() });
    
    // æ¸…ç†è¿‡æœŸæ•°æ®
    const now = Date.now();
    while (values.length > 0 && now - values[0].timestamp > this.windowSize * 1000) {
      values.shift();
    }
  }
  
  // è®¡ç®—å¹³å‡å€¼
  getAverage(name: string): number {
    const values = this.metrics.get(name);
    if (!values || values.length === 0) {
      return 0;
    }
    
    const sum = values.reduce((acc, curr) => acc + curr.value, 0);
    return sum / values.length;
  }
  
  // è®¡ç®—P95
  getP95(name: string): number {
    const values = this.metrics.get(name);
    if (!values || values.length === 0) {
      return 0;
    }
    
    const sorted = values.map(v => v.value).sort((a, b) => a - b);
    const index = Math.floor(sorted.length * 0.95);
    return sorted[index];
  }
}
```

### 9.3 å›æ»šå¤±è´¥

**é—®é¢˜æè¿°**
- å›æ»šå‘½ä»¤æ‰§è¡Œå¤±è´¥
- å›æ»šåé—®é¢˜ä¾ç„¶å­˜åœ¨
- æ— æ³•å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬

**è§£å†³æ–¹æ¡ˆ**

```bash
#!/bin/bash

# å¼ºåˆ¶å›æ»šè„šæœ¬

NAMESPACE=${1:-"yyc3-production"}
DEPLOYMENT=${2:-"yyc3-web"}
REVISION=${3:-""}

echo "=== å¼ºåˆ¶å›æ»š ==="

# 1. æ£€æŸ¥å›æ»šå†å²
echo "1. æ£€æŸ¥å›æ»šå†å²..."
kubectl rollout history deployment/$DEPLOYMENT -n $NAMESPACE

# 2. åˆ é™¤å½“å‰Pod
echo ""
echo "2. åˆ é™¤å½“å‰Pod..."
kubectl delete pods -n $NAMESPACE -l app=$DEPLOYMENT

# 3. ä¿®æ”¹é•œåƒ
echo ""
echo "3. ä¿®æ”¹é•œåƒ..."
kubectl set image deployment/$DEPLOYMENT web=yyc3-web:v1 -n $NAMESPACE

# 4. ç­‰å¾…å°±ç»ª
echo ""
echo "4. ç­‰å¾…å°±ç»ª..."
kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=5m

# 5. éªŒè¯
echo ""
echo "5. éªŒè¯..."
kubectl get pods -n $NAMESPACE -l app=$DEPLOYMENT

echo ""
echo "=== å›æ»šå®Œæˆ ==="
```

---

## 10. æ¡ˆä¾‹åˆ†æ

### 10.1 æˆåŠŸæ¡ˆä¾‹

**æ¡ˆä¾‹1: UIå‡çº§ç°åº¦å‘å¸ƒ**

**èƒŒæ™¯**
- å‡çº§ç”¨æˆ·ç•Œé¢
- æ–°å¢å¤šä¸ªäº¤äº’åŠŸèƒ½
- æ¶‰åŠå‰ç«¯æ¡†æ¶å‡çº§

**ç­–ç•¥**
- åˆå§‹æµé‡: 5%
- é€’å¢æ­¥é•¿: 5%
- è§‚å¯Ÿé—´éš”: 30åˆ†é’Ÿ
- ç›‘æ§æŒ‡æ ‡: é”™è¯¯ç‡ã€å“åº”æ—¶é—´ã€ç”¨æˆ·åé¦ˆ

**ç»“æœ**
- ç°åº¦å‘å¸ƒæˆåŠŸ
- æ— é‡å¤§é—®é¢˜
- å…¨é‡å‘å¸ƒå®Œæˆ
- ç”¨æˆ·åé¦ˆè‰¯å¥½

**ç»éªŒæ€»ç»“**
- å°æ­¥å¿«è·‘ï¼Œé€æ­¥éªŒè¯
- å¯†åˆ‡ç›‘æ§ï¼ŒåŠæ—¶å“åº”
- æ”¶é›†åé¦ˆï¼ŒæŒç»­ä¼˜åŒ–

### 10.2 å¤±è´¥æ¡ˆä¾‹

**æ¡ˆä¾‹2: APIæ€§èƒ½é—®é¢˜**

**èƒŒæ™¯**
- ä¼˜åŒ–APIæ€§èƒ½
- å¼•å…¥æ–°çš„ç¼“å­˜æœºåˆ¶
- è°ƒæ•´æ•°æ®åº“æŸ¥è¯¢

**ç­–ç•¥**
- åˆå§‹æµé‡: 10%
- é€’å¢æ­¥é•¿: 10%
- è§‚å¯Ÿé—´éš”: 10åˆ†é’Ÿ
- ç›‘æ§æŒ‡æ ‡: å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€èµ„æºä½¿ç”¨

**é—®é¢˜**
- å“åº”æ—¶é—´å¢åŠ 300%
- é”™è¯¯ç‡ä¸Šå‡åˆ°5%
- å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%

**å¤„ç†**
- ç«‹å³è§¦å‘å›æ»š
- åˆ†æé—®é¢˜åŸå› 
- ä¿®å¤æ€§èƒ½é—®é¢˜
- é‡æ–°ç°åº¦å‘å¸ƒ

**ç»éªŒæ€»ç»“**
- å……åˆ†çš„æ€§èƒ½æµ‹è¯•
- åˆç†çš„ç›‘æ§é˜ˆå€¼
- å¿«é€Ÿçš„å›æ»šæœºåˆ¶

---

## ğŸ“„ æ–‡æ¡£æ ‡å°¾

> ã€Œ***YanYuCloudCube***ã€
> ã€Œ***<admin@0379.email>***ã€
> ã€Œ***Words Initiate Quadrants, Language Serves as Core for Future***ã€
> ã€Œ***All things converge in cloud pivot; Deep stacks ignite a new era of intelligence***ã€




## æ¦‚è¿°

### æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†å®ç”¨çš„æŠ€å·§å’Œæ–¹æ³•ï¼Œå¸®åŠ©å¼€å‘è€…æé«˜å·¥ä½œæ•ˆç‡å’Œä»£ç è´¨é‡ã€‚

#### é€‚ç”¨åœºæ™¯

- æ—¥å¸¸å¼€å‘å·¥ä½œ
- ä»£ç ä¼˜åŒ–å’Œé‡æ„
- é—®é¢˜æ’æŸ¥å’Œè°ƒè¯•
- æ€§èƒ½ä¼˜åŒ–å’Œè°ƒä¼˜

#### é¢„æœŸæ”¶ç›Š

- æé«˜å¼€å‘æ•ˆç‡
- å‡å°‘ä»£ç é”™è¯¯
- ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
- æå‡ä»£ç å¯ç»´æŠ¤æ€§



## æ ¸å¿ƒæ¦‚å¿µ

### æ ¸å¿ƒæ¦‚å¿µ

#### å…³é”®æœ¯è¯­

- **æŠ€å·§**ï¼šç»è¿‡å®è·µéªŒè¯çš„æœ‰æ•ˆæ–¹æ³•
- **æœ€ä½³å®è·µ**ï¼šä¸šç•Œå…¬è®¤çš„ä¼˜ç§€åšæ³•
- **æ¨¡å¼**ï¼šå¯é‡å¤ä½¿ç”¨çš„è§£å†³æ–¹æ¡ˆ
- **åŸåˆ™**ï¼šæŒ‡å¯¼è®¾è®¡çš„åŸºæœ¬å‡†åˆ™

#### æ ¸å¿ƒåŸç†

1. **DRYåŸåˆ™**ï¼ˆDon't Repeat Yourselfï¼‰
   - é¿å…ä»£ç é‡å¤
   - æå–å…¬å…±é€»è¾‘
   - ä½¿ç”¨å‡½æ•°å’Œç±»å°è£…

2. **KISSåŸåˆ™**ï¼ˆKeep It Simple, Stupidï¼‰
   - ä¿æŒç®€å•
   - é¿å…è¿‡åº¦è®¾è®¡
   - ä¼˜å…ˆå¯è¯»æ€§

3. **YAGNIåŸåˆ™**ï¼ˆYou Aren't Gonna Need Itï¼‰
   - åªå®ç°å½“å‰éœ€è¦çš„åŠŸèƒ½
   - é¿å…è¿‡åº¦å·¥ç¨‹
   - ä¿æŒä»£ç ç²¾ç®€



## å®æ–½æ­¥éª¤

### å®æ–½æ­¥éª¤

#### æ­¥éª¤1ï¼šå‡†å¤‡å·¥ä½œ

```bash
# å®‰è£…å¿…è¦å·¥å…·
npm install -g typescript eslint prettier

# åˆå§‹åŒ–é¡¹ç›®
npm init -y
npm install --save-dev typescript @types/node
```

#### æ­¥éª¤2ï¼šé…ç½®ç¯å¢ƒ

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

#### æ­¥éª¤3ï¼šç¼–å†™ä»£ç 

```typescript
// åˆ›å»ºä¸»æ–‡ä»¶
// src/index.ts
function main() {
  console.log('Hello, YYCÂ³!');
}

main();
```

#### æ­¥éª¤4ï¼šæµ‹è¯•éªŒè¯

```bash
# è¿è¡Œä»£ç 
npm run dev

# è¿è¡Œæµ‹è¯•
npm test
```



## ä»£ç ç¤ºä¾‹

### ä»£ç ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šåŸºç¡€ç”¨æ³•

```typescript
// ç®€å•ç¤ºä¾‹
function greet(name: string): string {
  return `Hello, ${name}!`;
}

const message = greet('YYCÂ³');
console.log(message); // è¾“å‡º: Hello, YYCÂ³!
```

#### ç¤ºä¾‹2ï¼šé«˜çº§ç”¨æ³•

```typescript
// å¼‚æ­¥æ“ä½œ
async function fetchData(url: string): Promise<any> {
  const response = await fetch(url);
  const data = await response.json();
  return data;
}

// ä½¿ç”¨ç¤ºä¾‹
fetchData('https://api.example.com/data')
  .then(data => console.log(data))
  .catch(error => console.error('Error:', error));
```

#### ç¤ºä¾‹3ï¼šé”™è¯¯å¤„ç†

```typescript
// è‡ªå®šä¹‰é”™è¯¯ç±»
class ValidationError extends Error {
  constructor(public field: string, message: string) {
    super(message);
    this.name = 'ValidationError';
  }
}

// ä½¿ç”¨ç¤ºä¾‹
function validateEmail(email: string): void {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    throw new ValidationError('email', 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
  }
}

try {
  validateEmail('invalid-email');
} catch (error) {
  if (error instanceof ValidationError) {
    console.error(`éªŒè¯å¤±è´¥: ${error.field} - ${error.message}`);
  }
}
```



## æ³¨æ„äº‹é¡¹

### æ³¨æ„äº‹é¡¹

#### å¸¸è§é™·é˜±

1. **å¼‚æ­¥æ“ä½œé”™è¯¯**
```typescript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰ç­‰å¾…å¼‚æ­¥æ“ä½œ
async function processData() {
  const data = fetchData(); // å¿˜è®°await
  console.log(data); // è¾“å‡ºPromiseå¯¹è±¡
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨await
async function processData() {
  const data = await fetchData();
  console.log(data); // è¾“å‡ºå®é™…æ•°æ®
}
```

2. **å†…å­˜æ³„æ¼**
```typescript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
useEffect(() => {
  window.addEventListener('resize', handleResize);
}, []); // ç¼ºå°‘æ¸…ç†å‡½æ•°

// âœ… æ­£ç¡®ï¼šæ¸…ç†äº‹ä»¶ç›‘å¬å™¨
useEffect(() => {
  window.addEventListener('resize', handleResize);
  return () => {
    window.removeEventListener('resize', handleResize);
  };
}, []);
```

#### æ€§èƒ½æ³¨æ„äº‹é¡¹

1. **é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“**
```typescript
// âŒ é”™è¯¯ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°å¯¹è±¡
<Component data={{ value: 1 }} />

// âœ… æ­£ç¡®ï¼šä½¿ç”¨useMemoç¼“å­˜
const memoizedData = useMemo(() => ({ value: 1 }), []);
<Component data={memoizedData} />
```

2. **é¿å…å¤§å¯¹è±¡ä¼ é€’**
```typescript
// âŒ é”™è¯¯ï¼šä¼ é€’æ•´ä¸ªå¤§å¯¹è±¡
<Component user={user} />

// âœ… æ­£ç¡®ï¼šåªä¼ é€’éœ€è¦çš„å±æ€§
<Component userName={user.name} userId={user.id} />
```



## æœ€ä½³å®è·µ

### æœ€ä½³å®è·µ

#### ä»£ç è§„èŒƒ

1. **å‘½åè§„èŒƒ**
```typescript
// å˜é‡ï¼šcamelCase
const userName = 'John';

// å¸¸é‡ï¼šUPPER_SNAKE_CASE
const MAX_RETRY_COUNT = 3;

// ç±»ï¼šPascalCase
class UserService { }

// æ¥å£ï¼šPascalCaseï¼Œå‰ç¼€Iï¼ˆå¯é€‰ï¼‰
interface IUserService { }
```

2. **æ³¨é‡Šè§„èŒƒ**
```typescript
/**
 * åˆ›å»ºç”¨æˆ·
 * @param email - ç”¨æˆ·é‚®ç®±
 * @param password - ç”¨æˆ·å¯†ç 
 * @returns åˆ›å»ºçš„ç”¨æˆ·å¯¹è±¡
 * @throws {Error} å½“é‚®ç®±å·²å­˜åœ¨æ—¶æŠ›å‡ºé”™è¯¯
 */
async function createUser(
  email: string, 
  password: string
): Promise<User> {
  // å®ç°
}
```

#### é”™è¯¯å¤„ç†

```typescript
// ç»Ÿä¸€é”™è¯¯å¤„ç†
class AppError extends Error {
  constructor(
    public statusCode: number,
    public message: string,
    public isOperational = true
  ) {
    super(message);
    this.name = this.constructor.name;
    Error.captureStackTrace(this, this.constructor);
  }
}

// ä½¿ç”¨é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
  if (err instanceof AppError) {
    return res.status(err.statusCode).json({
      success: false,
      error: err.message
    });
  }
  
  // è®°å½•æœªé¢„æœŸçš„é”™è¯¯
  logger.error('Unexpected error:', err);
  
  return res.status(500).json({
    success: false,
    error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
  });
});
```

#### æ—¥å¿—è®°å½•

```typescript
// ç»“æ„åŒ–æ—¥å¿—
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

// ä½¿ç”¨æ—¥å¿—
logger.info('User created', { userId: user.id, email: user.email });
logger.error('Database connection failed', { error: error.message });
```



## å¸¸è§é—®é¢˜

### å¸¸è§é—®é¢˜

#### Q1: å¦‚ä½•å¤„ç†å¼‚æ­¥é”™è¯¯ï¼Ÿ

**A**: ä½¿ç”¨try-catchæ•è·å¼‚æ­¥é”™è¯¯ï¼š

```typescript
async function handleRequest() {
  try {
    const result = await fetchData();
    return result;
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    throw error;
  }
}
```

#### Q2: å¦‚ä½•ä¼˜åŒ–Reactç»„ä»¶æ€§èƒ½ï¼Ÿ

**A**: ä½¿ç”¨ä»¥ä¸‹ä¼˜åŒ–æŠ€æœ¯ï¼š

1. **React.memo**ï¼šé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
2. **useMemo**ï¼šç¼“å­˜è®¡ç®—ç»“æœ
3. **useCallback**ï¼šç¼“å­˜å‡½æ•°å¼•ç”¨
4. **ä»£ç åˆ†å‰²**ï¼šæ‡’åŠ è½½ç»„ä»¶

```typescript
const MemoizedComponent = React.memo(({ data }) => {
  const processedData = useMemo(() => processData(data), [data]);
  return <div>{processedData}</div>;
});
```

#### Q3: å¦‚ä½•ç®¡ç†åº”ç”¨çŠ¶æ€ï¼Ÿ

**A**: æ ¹æ®åº”ç”¨å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼š

1. **ç®€å•åº”ç”¨**ï¼šä½¿ç”¨React Context API
2. **ä¸­ç­‰åº”ç”¨**ï¼šä½¿ç”¨Zustandæˆ–Redux Toolkit
3. **å¤æ‚åº”ç”¨**ï¼šä½¿ç”¨Redux + ä¸­é—´ä»¶

```typescript
// Zustandç¤ºä¾‹
const useStore = create((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
  decrement: () => set((state) => ({ count: state.count - 1 }))
}));
```



## æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹åˆ†æ

#### æ¡ˆä¾‹1ï¼šæ€§èƒ½ä¼˜åŒ–

**é—®é¢˜**ï¼šé¡µé¢åŠ è½½æ—¶é—´è¿‡é•¿ï¼Œç”¨æˆ·ä½“éªŒå·®ã€‚

**åˆ†æ**ï¼š
- é¦–æ¬¡å†…å®¹ç»˜åˆ¶(FCP)ï¼š3.2ç§’
- æœ€å¤§å†…å®¹ç»˜åˆ¶(LCP)ï¼š5.8ç§’
- ç´¯ç§¯å¸ƒå±€åç§»(CLS)ï¼š0.25

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å®ç°ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½
2. ä¼˜åŒ–å›¾ç‰‡åŠ è½½ï¼ˆä½¿ç”¨WebPæ ¼å¼ï¼Œæ·»åŠ loading="lazy"ï¼‰
3. å¯ç”¨Gzipå‹ç¼©
4. ä½¿ç”¨CDNåŠ é€Ÿé™æ€èµ„æº

**ç»“æœ**ï¼š
- FCPï¼š1.2ç§’ï¼ˆâ†“62.5%ï¼‰
- LCPï¼š2.1ç§’ï¼ˆâ†“63.8%ï¼‰
- CLSï¼š0.08ï¼ˆâ†“68%ï¼‰

#### æ¡ˆä¾‹2ï¼šé”™è¯¯å¤„ç†æ”¹è¿›

**é—®é¢˜**ï¼šé”™è¯¯ä¿¡æ¯ä¸æ¸…æ™°ï¼Œéš¾ä»¥å®šä½é—®é¢˜ã€‚

**åˆ†æ**ï¼š
- é”™è¯¯ä¿¡æ¯è¿‡äºç®€å•
- ç¼ºå°‘é”™è¯¯ä¸Šä¸‹æ–‡
- æ²¡æœ‰é”™è¯¯è¿½è¸ª

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å®ç°è‡ªå®šä¹‰é”™è¯¯ç±»
2. æ·»åŠ é”™è¯¯å †æ ˆè¿½è¸ª
3. é›†æˆé”™è¯¯ç›‘æ§å·¥å…·ï¼ˆSentryï¼‰
4. å®ç°é”™è¯¯æ—¥å¿—è®°å½•

**ç»“æœ**ï¼š
- é”™è¯¯å®šä½æ—¶é—´å‡å°‘70%
- é”™è¯¯è§£å†³ç‡æé«˜40%
- ç”¨æˆ·æŠ•è¯‰å‡å°‘60%

#### æ¡ˆä¾‹3ï¼šä»£ç é‡æ„

**é—®é¢˜**ï¼šä»£ç é‡å¤ç‡é«˜ï¼Œç»´æŠ¤å›°éš¾ã€‚

**åˆ†æ**ï¼š
- ä»£ç é‡å¤ç‡ï¼š35%
- å‡½æ•°å¹³å‡é•¿åº¦ï¼š120è¡Œ
- åœˆå¤æ‚åº¦ï¼š15

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æå–å…¬å…±é€»è¾‘åˆ°å·¥å…·å‡½æ•°
2. ä½¿ç”¨è®¾è®¡æ¨¡å¼é‡æ„
3. æ‹†åˆ†å¤§å‡½æ•°
4. æ·»åŠ å•å…ƒæµ‹è¯•

**ç»“æœ**ï¼š
- ä»£ç é‡å¤ç‡ï¼š8%ï¼ˆâ†“77%ï¼‰
- å‡½æ•°å¹³å‡é•¿åº¦ï¼š35è¡Œï¼ˆâ†“71%ï¼‰
- åœˆå¤æ‚åº¦ï¼š5ï¼ˆâ†“67%ï¼‰


## ç›¸å…³æ–‡æ¡£

- [ğŸ”– YYCÂ³ K8séƒ¨ç½²è¿ç»´æŠ€å·§](YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æŠ€å·§ç±»/02-YYC3-Cater--æŠ€å·§ç±»-K8séƒ¨ç½²è¿ç»´æŠ€å·§.md) - YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æŠ€å·§ç±»
- [ğŸ”– YYCÂ³ Dockerå®¹å™¨åŒ–éƒ¨ç½²æŠ€å·§](YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æŠ€å·§ç±»/01-YYC3-Cater--æŠ€å·§ç±»-Dockerå®¹å™¨åŒ–éƒ¨ç½²æŠ€å·§.md) - YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æŠ€å·§ç±»
- [ğŸ”– YYCÂ³ éƒ¨ç½²é—®é¢˜æ’æŸ¥æŒ‡å—](YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æŠ€å·§ç±»/04-YYC3-Cater--æŠ€å·§ç±»-éƒ¨ç½²é—®é¢˜æ’æŸ¥æŒ‡å—.md) - YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æŠ€å·§ç±»
- [ğŸ”– YYCÂ³ CI/CDæµæ°´çº¿æ­å»ºä¸ä¼˜åŒ–æŠ€å·§](YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æŠ€å·§ç±»/03-YYC3-Cater--æŠ€å·§ç±»-CI_CDæµæ°´çº¿æ­å»ºä¸ä¼˜åŒ–æŠ€å·§.md) - YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æŠ€å·§ç±»
- [ğŸ”– YYCÂ³ ç°åº¦å‘å¸ƒæ¶æ„è®¾è®¡æ–‡æ¡£](YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æ¶æ„ç±»/04-YYC3-Cater--æ¶æ„ç±»-ç°åº¦å‘å¸ƒæ¶æ„è®¾è®¡æ–‡æ¡£.md) - YYC3-Cater-éƒ¨ç½²å‘å¸ƒ/æ¶æ„ç±»
