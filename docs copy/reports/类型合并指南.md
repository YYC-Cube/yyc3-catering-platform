/**
 * @file 重复类型合并指南
 * @description 说明如何将项目中的重复类型定义合并到统一的 types/ 目录
 * @author YYC
 * @version 1.0.0
 * @created 2026-01-03
 */

## 一、重复类型定义清单

### 1. User 接口（13 处重复）

| 文件路径 | 类型名 | 字段差异 |
|---------|--------|---------|
| `backend/shared/types/Auth.ts:8` | `User` | `id: string, email, roles[], permissions[], iat?, exp?` |
| `frontend/apps/admin-dashboard/src/types/auth.ts:5` | `User` | `id: number, email, name, role, avatar?, phone?, status` |
| `frontend/apps/customer-app/src/types/auth.ts:7` | `User` | `id: number, email, name, avatar?, phone?` |
| `frontend/apps/staff-app/src/types/auth.ts:6` | `User` | `id: number, email, name, role, avatar?` |
| `backend/services/user-service/src/models/User.model.ts` | `User` | 完整的用户模型 |
| `backend/services/ai-assistant/src/middleware/auth.ts:25` | `UserInfo` | `id, email, name, roles[]` |
| ... | ... | ... |

**统一类型位置**: `types/entities/user.d.ts`

### 2. Order 接口（12 处重复）

| 文件路径 | 类型名 | 字段差异 |
|---------|--------|---------|
| `frontend/apps/admin-dashboard/src/types/dashboard.ts:33` | `Order` | `id, tableNumber, customerName, status, total, items, createdAt` |
| `backend/services/api-service/src/models/order.ts:80` | `Order` | 包含 `OrderItem` 定义 |
| `backend/services/order-service/src/models/Order.model.ts` | `Order` | 订单模型定义 |
| `frontend/apps/admin-dashboard/src/api/order.ts:104` | `Order` | 包含 `OrderItem` |
| `frontend/apps/customer-app/src/types/order.ts:12` | `Order` | 简化版订单类型 |
| ... | ... | ... |

**统一类型位置**: `types/entities/order.d.ts`

### 3. Config 接口（多处重复）

| 接口 | 文件路径 |
|------|---------|
| `Config` | `backend/services/smart-ops-service/src/config/config.ts:12` |
| `ServiceConfig` | 多个服务中（gateway, api-gateway, etc.） |
| `UserServiceConfig` | `backend/services/user-service/src/config/config.ts:20` |

**统一类型位置**: `types/config/service.d.ts`

### 4. LogLevel 枚举（多处重复）

| 文件路径 |
|---------|
| `backend/libs/logger/logger.service.ts` |
| `backend/services/*/src/config/logger.ts` |
| `frontend/apps/*/src/utils/logger.ts` |

**统一类型位置**: 待创建 `types/common/logger.d.ts`

### 5. ApiResponse<T>（多处重复）

| 文件路径 |
|---------|
| `backend/services/api-service/src/types/api.ts` |
| `backend/services/*/src/types/response.ts` |
| `frontend/apps/*/src/api/types.ts` |

**统一类型位置**: `types/services/api.d.ts`

## 二、合并策略

### 步骤 1: 创建类型映射文件

在每个微服务和前端应用的根目录创建 `types.ts` 文件：

```typescript
// backend/services/user-service/src/types.ts
export * from '@yyc3/types/entities/user';
export * from '@yyc3/types/config/service';
export * from '@yyc3/types/services/cache';

// 保持向后兼容
export { BaseUser as User } from '@yyc3/types/entities/user';
export type { ServiceConfig as UserServiceConfig } from '@yyc3/types/config/service';
```

### 步骤 2: 更新导入语句

**修复前**:
```typescript
import { User } from './types/user';
import { Order } from './models/Order';
```

**修复后**:
```typescript
import { BaseUser } from '@yyc3/types/entities/user';
import type { Order } from '@yyc3/types/entities/order';
```

### 步骤 3: 使用类型转换器

对于前后端类型不一致的地方（如 `id` 类型）：

```typescript
import { TypeConverter } from '@yyc3/types/utils/type-converter';

// 前端转后端
const authUser = TypeConverter.frontendUserToAuthUser(frontendUser);

// 后端转前端
const frontendUser = TypeConverter.authUserToFrontendUser(authUser);
```

### 步骤 4: 批量替换脚本

```bash
# 查找所有使用旧类型定义的文件
grep -r "from.*types/auth" backend/
grep -r "from.*types/order" backend/
grep -r "from.*types/user" frontend/
```

## 三、迁移检查清单

### User 类型迁移

- [ ] `backend/shared/types/Auth.ts` - 使用 `BaseUser` 和 `AuthUser`
- [ ] `backend/services/user-service/src/models/User.model.ts` - 扩展 `AuthUser`
- [ ] `backend/services/ai-assistant/src/middleware/auth.ts` - 使用 `AuthUser`
- [ ] `frontend/apps/admin-dashboard/src/types/auth.ts` - 使用 `FrontendUser`
- [ ] `frontend/apps/customer-app/src/types/auth.ts` - 使用 `FrontendUser`
- [ ] `frontend/apps/staff-app/src/types/auth.ts` - 使用 `FrontendUser`

### Order 类型迁移

- [ ] `backend/services/order-service/src/models/Order.model.ts` - 使用 `Order`
- [ ] `backend/services/api-service/src/models/order.ts` - 使用 `Order`
- [ ] `frontend/apps/admin-dashboard/src/types/dashboard.ts` - 使用 `Order`
- [ ] `frontend/apps/customer-app/src/types/order.ts` - 使用 `Order`
- [ ] `frontend/apps/staff-app/src/types/order.ts` - 使用 `Order`

### Config 类型迁移

- [ ] `backend/services/smart-ops-service/src/config/config.ts` - 使用 `ServiceConfig`
- [ ] `backend/services/user-service/src/config/config.ts` - 使用 `ServiceConfig`
- [ ] `backend/gateway/src/config/config.ts` - 使用 `GatewayConfig`
- [ ] `backend/api-gateway/src/config/config.ts` - 使用 `GatewayConfig`

### API Response 类型迁移

- [ ] `backend/services/api-service/src/types/api.ts` - 使用 `ApiResponse`
- [ ] `backend/services/*/src/types/response.ts` - 使用 `ApiResponse`
- [ ] `frontend/apps/*/src/api/types.ts` - 使用 `ApiResponse`

## 四、回退计划

如果在迁移过程中遇到问题，可以使用以下方法回退：

1. **保留兼容层**: 在旧类型定义文件中导入新类型并导出：

```typescript
// backend/shared/types/Auth.ts
export { BaseUser as User } from '@yyc3/types/entities/user';
export type { AuthUser, FrontendUser } from '@yyc3/types/entities/user';
```

2. **逐步迁移**: 先迁移新功能，旧功能保持不变

3. **测试验证**: 每个模块迁移后运行完整的测试套件

## 五、自动化工具

可以使用以下工具自动化类型迁移：

1. **TypeScript Language Service API**: 查找所有类型引用
2. **AST 转换**: 使用 Babel 或 TypeScript Compiler API 自动替换导入
3. **Codemods**: 使用 jscodeshift 编写转换脚本

示例 Codemod:

```javascript
// codemods/fix-user-imports.js
module.exports = function(file, api) {
  const j = api.jscodeshift;
  const root = j(file.source);

  return root
    .find(j.ImportDeclaration, {
      source: { value: (val) => val.includes('types/user') }
    })
    .forEach(path => {
      // 替换为新的导入路径
      path.node.source.value = '@yyc3/types/entities/user';
    })
    .toSource();
};
```

## 六、后续维护

1. **添加 ESLint 规则**: 禁止从旧的类型路径导入
2. **Pre-commit Hook**: 检查是否有未迁移的类型定义
3. **文档更新**: 更新开发者指南，说明如何使用统一类型
