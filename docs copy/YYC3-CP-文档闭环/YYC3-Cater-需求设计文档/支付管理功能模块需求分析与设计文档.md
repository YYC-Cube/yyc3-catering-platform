# YYC³餐饮管理系统 - 支付管理功能模块需求分析与设计文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 支付管理功能模块需求分析与设计文档 |
| 文档版本 | V1.0.0 |
| 创建日期 | 2025-01-20 |
| 作者 | YYC³团队 |
| 文档状态 | 正式发布 |

## 1. 概述

### 1.1 模块简介

支付管理模块是YYC³餐饮管理系统的核心财务模块，负责管理系统的支付方式配置、交易记录查询、退款处理等功能。该模块为管理员提供完整的支付管理能力，确保支付流程的安全、可靠和高效。

### 1.2 模块目标

- 提供完整的支付方式配置管理
- 实现灵活的支付方式选择
- 支持多种支付渠道（支付宝、微信支付、银联等）
- 提供交易记录查询和统计
- 实现退款申请和处理流程
- 确保支付安全和数据完整性
- 提供支付数据分析和报表

### 1.3 适用范围

本模块适用于YYC³餐饮管理系统的所有版本，包括单店版和连锁版。

## 2. 功能需求

### 2.1 支付配置管理

#### 2.1.1 支付配置列表

**功能描述**：展示系统中所有支付方式的配置信息，支持搜索、筛选和分页。

**输入参数**：
- 关键词：支付方式名称、配置名称
- 支付方式：按支付方式筛选
- 状态：已启用、已禁用
- 页码：当前页码
- 每页数量：每页显示数量

**输出结果**：
- 支付配置列表：包含支付配置基本信息
- 总数：符合条件的支付配置总数

**字段说明**：
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | number | 是 | 配置ID |
| method | string | 是 | 支付方式：alipay/wechat/unionpay/cash/credit_card/debit_card/digital_wallet/member_balance |
| name | string | 是 | 配置名称 |
| displayName | string | 是 | 显示名称 |
| description | string | 否 | 描述 |
| enabled | boolean | 是 | 是否启用 |
| config | object | 是 | 配置详情 |
| createdAt | string | 是 | 创建时间 |
| updatedAt | string | 否 | 更新时间 |

**配置详情字段**：
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| appId | string | 否 | 应用ID |
| merchantId | string | 否 | 商户ID |
| apiKey | string | 否 | API密钥 |
| apiSecret | string | 否 | API密钥 |
| publicKey | string | 否 | 公钥 |
| privateKey | string | 否 | 私钥 |
| notifyUrl | string | 否 | 异步通知URL |
| returnUrl | string | 否 | 同步返回URL |
| supportedCurrencies | array | 是 | 支持的货币 |
| minAmount | number | 是 | 最小金额 |
| maxAmount | number | 是 | 最大金额 |
| feeRate | number | 是 | 手续费率 |
| fixedFee | number | 是 | 固定手续费 |

#### 2.1.2 新增支付配置

**功能描述**：创建新的支付方式配置。

**输入参数**：
- 支付方式：选择支付方式
- 配置名称：配置显示名称
- 显示名称：支付方式显示名称
- 描述：配置说明
- 是否启用：是否启用该支付方式
- 配置详情：支付方式的具体配置

**验证规则**：
- 配置名称：2-50位字符
- 显示名称：2-20位中文字符
- 支付方式：必须选择
- 配置详情：根据支付方式不同而不同

**业务规则**：
- 同一种支付方式只能有一个启用的配置
- 新配置默认状态为启用
- 自动记录创建时间和创建人
- 敏感信息加密存储

#### 2.1.3 编辑支付配置

**功能描述**：修改支付方式的配置信息。

**输入参数**：
- 配置ID：要编辑的配置ID
- 配置名称：可修改
- 显示名称：可修改
- 描述：可修改
- 是否启用：可修改
- 配置详情：可修改

**验证规则**：
- 配置名称：2-50位字符
- 显示名称：2-20位中文字符
- 配置详情：根据支付方式不同而不同

**业务规则**：
- 记录修改时间和修改人
- 敏感信息加密存储
- 修改后立即生效

#### 2.1.4 删除支付配置

**功能描述**：删除指定的支付配置。

**输入参数**：
- 配置ID：要删除的配置ID

**业务规则**：
- 删除前需要二次确认
- 不能删除系统默认配置
- 不能删除仍有交易记录的配置
- 记录删除操作到审计日志

#### 2.1.5 启用/禁用支付配置

**功能描述**：启用或禁用支付配置。

**输入参数**：
- 配置ID：要操作的配置ID

**业务规则**：
- 禁用后该支付方式不可用
- 启用后该支付方式立即可用
- 记录启用/禁用操作

#### 2.1.6 测试支付配置

**功能描述**：测试支付配置是否正确。

**输入参数**：
- 配置ID：要测试的配置ID

**业务规则**：
- 测试使用小额金额（0.01元）
- 测试成功后显示成功提示
- 测试失败后显示错误信息

### 2.2 交易记录管理

#### 2.2.1 交易记录列表

**功能描述**：展示系统中所有交易记录，支持搜索、筛选和分页。

**输入参数**：
- 关键词：订单号、交易号
- 支付方式：按支付方式筛选
- 状态：待支付、处理中、成功、失败、已取消、已退款、部分退款
- 开始时间：交易开始时间
- 结束时间：交易结束时间
- 最小金额：最小交易金额
- 最大金额：最大交易金额
- 订单号：按订单号筛选
- 交易号：按交易号筛选
- 排序字段：创建时间、金额、支付时间
- 排序方式：升序、降序
- 页码：当前页码
- 每页数量：每页显示数量

**输出结果**：
- 交易记录列表：包含交易详细信息
- 分页信息：总数、总页数等

**字段说明**：
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | number | 是 | 交易ID |
| transactionId | string | 是 | 交易号 |
| orderId | string | 是 | 订单号 |
| paymentMethod | string | 是 | 支付方式 |
| amount | number | 是 | 交易金额 |
| currency | string | 是 | 货币类型 |
| status | string | 是 | 交易状态 |
| paymentTime | string | 否 | 支付时间 |
| failureReason | string | 否 | 失败原因 |
| externalTransactionId | string | 否 | 外部交易号 |
| gatewayResponse | object | 否 | 网关响应 |
| refundAmount | number | 否 | 退款金额 |
| refundedAt | string | 否 | 退款时间 |
| createdAt | string | 是 | 创建时间 |
| updatedAt | string | 否 | 更新时间 |

#### 2.2.2 交易详情

**功能描述**：查看交易的详细信息。

**输入参数**：
- 交易ID：要查看的交易ID

**输出结果**：
- 交易详情：包含交易的完整信息

**业务规则**：
- 显示交易的完整信息
- 显示支付网关的响应信息
- 显示退款信息（如果有）

#### 2.2.3 导出交易记录

**功能描述**：导出交易记录到Excel文件。

**输入参数**：
- 开始时间：导出开始时间
- 结束时间：导出结束时间
- 支付方式：按支付方式筛选
- 状态：按状态筛选
- 最小金额：最小交易金额
- 最大金额：最大交易金额

**业务规则**：
- 导出需要管理员权限
- 导出文件命名包含时间戳
- 记录导出操作到审计日志

### 2.3 退款管理

#### 2.3.1 退款记录列表

**功能描述**：展示系统中所有退款记录，支持搜索、筛选和分页。

**输入参数**：
- 关键词：退款号、订单号、交易号
- 状态：待处理、处理中、成功、失败、已取消
- 开始时间：退款开始时间
- 结束时间：退款结束时间
- 页码：当前页码
- 每页数量：每页显示数量

**输出结果**：
- 退款记录列表：包含退款详细信息
- 分页信息：总数、总页数等

**字段说明**：
| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | number | 是 | 退款ID |
| refundId | string | 是 | 退款号 |
| transactionId | string | 是 | 交易号 |
| orderId | string | 是 | 订单号 |
| amount | number | 是 | 退款金额 |
| reason | string | 是 | 退款原因 |
| status | string | 是 | 退款状态 |
| processedAt | string | 否 | 处理时间 |
| failureReason | string | 否 | 失败原因 |
| externalRefundId | string | 否 | 外部退款号 |
| gatewayResponse | object | 否 | 网关响应 |
| createdAt | string | 是 | 创建时间 |
| updatedAt | string | 否 | 更新时间 |

#### 2.3.2 创建退款

**功能描述**：为成功的交易创建退款。

**输入参数**：
- 交易号：要退款的交易号
- 退款金额：退款金额
- 退款原因：退款原因说明

**验证规则**：
- 交易号必须存在
- 交易状态必须为成功
- 退款金额必须小于等于交易金额
- 退款原因：必填，1-200字符

**业务规则**：
- 退款金额不能超过交易金额
- 部分退款后交易状态变为部分退款
- 全额退款后交易状态变为已退款
- 退款申请后立即提交到支付网关
- 记录退款操作到审计日志

#### 2.3.3 导出退款记录

**功能描述**：导出退款记录到Excel文件。

**输入参数**：
- 开始时间：导出开始时间
- 结束时间：导出结束时间
- 状态：按状态筛选

**业务规则**：
- 导出需要管理员权限
- 导出文件命名包含时间戳
- 记录导出操作到审计日志

### 2.4 支付统计

#### 2.4.1 支付统计概览

**功能描述**：展示支付相关的统计数据。

**输出结果**：
- 总交易笔数
- 总收入（按货币）
- 总退款（按货币）
- 净收入（按货币）
- 成功率
- 平均订单价值（按货币）
- 按支付方式统计
- 每日统计
- 每月统计

**字段说明**：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| totalTransactions | number | 总交易笔数 |
| totalRevenue | object | 总收入（按货币） |
| totalRefunds | object | 总退款（按货币） |
| netRevenue | object | 净收入（按货币） |
| successRate | number | 成功率（0-1） |
| averageOrderValue | object | 平均订单价值（按货币） |
| transactionsByMethod | object | 按支付方式统计 |
| dailyStats | array | 每日统计 |
| monthlyStats | array | 每月统计 |

**业务规则**：
- 统计数据实时更新
- 支持按时间范围查询
- 支持按支付方式筛选

## 3. 非功能需求

### 3.1 性能需求

- 支付配置列表加载时间 < 1秒
- 交易记录列表加载时间 < 2秒
- 退款记录列表加载时间 < 2秒
- 支付统计加载时间 < 3秒
- 支持至少100,000条交易记录
- 支持至少10,000条退款记录
- 支付成功率 ≥ 99%
- 支付响应时间 < 3秒

### 3.2 安全需求

- 所有支付操作需要身份认证
- 敏感信息加密存储
- 支付数据传输使用HTTPS
- 支持支付密码验证
- 支持操作权限控制
- 支持数据访问权限控制
- 定期备份支付数据
- 支持支付风控规则

### 3.3 可用性需求

- 系统可用性 ≥ 99.9%
- 支持多浏览器访问
- 支持移动端访问
- 提供友好的错误提示
- 提供操作帮助文档
- 支持多种支付方式

### 3.4 可维护性需求

- 代码结构清晰
- 模块化设计
- 完善的日志记录
- 完善的错误处理
- 支持热更新
- 支持配置管理
- 支持支付网关扩展

## 4. 技术设计

### 4.1 技术栈

- 前端框架：Vue 3 + TypeScript
- UI组件库：Element Plus
- 状态管理：Pinia
- 路由管理：Vue Router
- HTTP客户端：Axios
- 表单验证：Zod
- 图表库：ECharts
- 构建工具：Vite

### 4.2 数据库设计

#### 支付配置表（payment_configs）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|--------|------|
| id | int | PRIMARY KEY | 配置ID |
| method | varchar(50) | NOT NULL | 支付方式 |
| name | varchar(100) | NOT NULL | 配置名称 |
| display_name | varchar(50) | NOT NULL | 显示名称 |
| description | text | NULL | 描述 |
| enabled | boolean | NOT NULL | 是否启用 |
| config | json | NOT NULL | 配置详情 |
| created_at | timestamp | NOT NULL | 创建时间 |
| updated_at | timestamp | NULL | 更新时间 |

#### 交易记录表（payment_transactions）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|--------|------|
| id | int | PRIMARY KEY | 交易ID |
| transaction_id | varchar(100) | UNIQUE | 交易号 |
| order_id | varchar(100) | NOT NULL | 订单号 |
| payment_method | varchar(50) | NOT NULL | 支付方式 |
| amount | decimal(10,2) | NOT NULL | 交易金额 |
| currency | varchar(10) | NOT NULL | 货币类型 |
| status | varchar(20) | NOT NULL | 交易状态 |
| payment_time | timestamp | NULL | 支付时间 |
| failure_reason | text | NULL | 失败原因 |
| external_transaction_id | varchar(100) | NULL | 外部交易号 |
| gateway_response | json | NULL | 网关响应 |
| refund_amount | decimal(10,2) | NULL | 退款金额 |
| refunded_at | timestamp | NULL | 退款时间 |
| created_at | timestamp | NOT NULL | 创建时间 |
| updated_at | timestamp | NULL | 更新时间 |

#### 退款记录表（refund_records）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|--------|------|
| id | int | PRIMARY KEY | 退款ID |
| refund_id | varchar(100) | UNIQUE | 退款号 |
| transaction_id | varchar(100) | NOT NULL | 交易号 |
| order_id | varchar(100) | NOT NULL | 订单号 |
| amount | decimal(10,2) | NOT NULL | 退款金额 |
| reason | text | NOT NULL | 退款原因 |
| status | varchar(20) | NOT NULL | 退款状态 |
| processed_at | timestamp | NULL | 处理时间 |
| failure_reason | text | NULL | 失败原因 |
| external_refund_id | varchar(100) | NULL | 外部退款号 |
| gateway_response | json | NULL | 网关响应 |
| created_at | timestamp | NOT NULL | 创建时间 |
| updated_at | timestamp | NULL | 更新时间 |

### 4.3 API设计

#### 支付配置API

```
GET    /api/payment/configs          # 获取支付配置列表
GET    /api/payment/configs/:id      # 获取支付配置详情
POST   /api/payment/configs          # 创建支付配置
PUT    /api/payment/configs/:id      # 更新支付配置
DELETE /api/payment/configs/:id      # 删除支付配置
PATCH  /api/payment/configs/:id/toggle  # 启用/禁用支付配置
POST   /api/payment/configs/:id/test  # 测试支付配置
```

#### 交易记录API

```
GET    /api/payment/transactions          # 获取交易记录列表
GET    /api/payment/transactions/:id      # 获取交易详情
GET    /api/payment/transactions/export   # 导出交易记录
```

#### 退款记录API

```
GET    /api/payment/refunds          # 获取退款记录列表
GET    /api/payment/refunds/:id      # 获取退款详情
POST   /api/payment/refunds          # 创建退款
GET    /api/payment/refunds/export   # 导出退款记录
```

#### 支付统计API

```
GET    /api/payment/stats          # 获取支付统计
```

### 4.4 支付方式设计

#### 支付方式列表

| 支付方式 | 编码 | 说明 |
|---------|------|------|
| 支付宝 | alipay | 支持扫码支付、APP支付、网页支付 |
| 微信支付 | wechat | 支持扫码支付、APP支付、网页支付 |
| 银联支付 | unionpay | 支持银行卡支付 |
| 现金 | cash | 线下现金支付 |
| 银行卡 | credit_card | 支持信用卡支付 |
| 借记卡 | debit_card | 支持借记卡支付 |
| 数字钱包 | digital_wallet | 支持Apple Pay、Google Pay等 |
| 会员余额 | member_balance | 支持会员余额支付 |

#### 支付状态列表

| 支付状态 | 编码 | 说明 |
|---------|------|------|
| 待支付 | pending | 订单已创建，等待支付 |
| 处理中 | processing | 支付处理中 |
| 成功 | success | 支付成功 |
| 失败 | failed | 支付失败 |
| 已取消 | cancelled | 支付已取消 |
| 已退款 | refunded | 已全额退款 |
| 部分退款 | partially_refunded | 已部分退款 |

#### 退款状态列表

| 退款状态 | 编码 | 说明 |
|---------|------|------|
| 待处理 | pending | 退款申请已提交，等待处理 |
| 处理中 | processing | 退款处理中 |
| 成功 | success | 退款成功 |
| 失败 | failed | 退款失败 |
| 已取消 | cancelled | 退款已取消 |

## 5. 界面设计

### 5.1 支付管理主界面

- 页面标题和描述
- 统计卡片（总收入、交易笔数、成功率、退款金额）
- 功能标签页（支付配置、交易记录、退款记录）
- 添加支付方式按钮

### 5.2 支付配置界面

- 支付配置列表表格
- 搜索和筛选工具栏
- 新增支付配置按钮
- 操作按钮（测试、编辑、启用/禁用、删除）
- 支付配置对话框
- 分页组件

### 5.3 交易记录界面

- 交易记录列表表格
- 搜索和筛选工具栏
- 导出记录按钮
- 交易详情对话框
- 退款对话框
- 分页组件

### 5.4 退款记录界面

- 退款记录列表表格
- 搜索和筛选工具栏
- 导出记录按钮
- 退款详情对话框
- 分页组件

## 6. 测试计划

### 6.1 单元测试

- 支付配置管理功能测试
- 交易记录管理功能测试
- 退款管理功能测试
- 支付统计功能测试
- 数据格式化功能测试

### 6.2 集成测试

- 支付配置CRUD操作测试
- 交易记录查询测试
- 退款流程测试
- 支付统计测试
- 数据导出测试

### 6.3 性能测试

- 大数据量加载测试
- 并发操作测试
- 响应时间测试
- 支付成功率测试

### 6.4 安全测试

- 权限控制测试
- SQL注入测试
- XSS攻击测试
- CSRF攻击测试
- 支付安全测试

## 7. 部署计划

### 7.1 开发环境

- 部署时间：2025-01-20
- 部署方式：本地开发环境
- 测试范围：功能测试

### 7.2 测试环境

- 部署时间：2025-01-25
- 部署方式：CI/CD自动部署
- 测试范围：集成测试、性能测试、安全测试

### 7.3 生产环境

- 部署时间：2025-02-01
- 部署方式：蓝绿部署
- 测试范围：冒烟测试

## 8. 附录

### 8.1 术语表

| 术语 | 说明 |
|------|------|
| 支付方式 | 用户支付订单的方式，如支付宝、微信支付等 |
| 支付配置 | 支付方式的具体配置信息 |
| 交易记录 | 每一笔支付交易的详细记录 |
| 退款记录 | 每一笔退款操作的详细记录 |
| 支付统计 | 支付相关的统计数据 |
| 支付网关 | 处理支付的第三方服务 |

### 8.2 参考文档

- YYC³餐饮管理系统总体设计文档
- YYC³餐饮管理系统数据库设计文档
- YYC³餐饮管理系统API文档
- YYC³餐饮管理系统安全规范

### 8.3 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| V1.0.0 | 2025-01-20 | 初始版本 | YYC³团队 |

---

**文档结束**
