# 菜单管理功能模块开发文档

## 模块概述

菜单管理模块是YYC³餐饮行业智能化平台的核心功能模块，提供菜品管理、分类管理、权限控制、批量操作等功能。该模块采用Vue 3 + TypeScript + Element Plus技术栈，使用Pinia进行状态管理。

## 技术架构

### 1. 技术栈
- **前端框架**: Vue 3.4+ (Composition API)
- **UI组件库**: Element Plus 2.4+
- **状态管理**: Pinia 2.1+
- **路由管理**: Vue Router 4.2+
- **HTTP客户端**: Fetch API
- **类型检查**: TypeScript 5.3+
- **构建工具**: Vite 5.4+

### 2. 目录结构
```
src/
├── views/
│   └── MenuManagement.vue          # 菜单管理主页面
├── components/
│   └── Menu/
│       ├── MenuCategoryManager.vue  # 菜单分类管理组件
│       ├── MenuPermissionManager.vue # 菜单权限管理组件
│       ├── MenuBatchOperations.vue   # 菜单批量操作组件
│       ├── MenuItemDetail.vue       # 菜品详情组件
│       ├── MenuPreview.vue         # 菜单预览组件
│       ├── MenuStatistics.vue      # 菜单统计组件
│       └── __tests__/
│           ├── MenuCategoryManager.test.ts
│           ├── MenuPermissionManager.test.ts
│           ├── MenuBatchOperations.test.ts
│           ├── MenuItemDetail.test.ts
│           ├── MenuPreview.test.ts
│           └── MenuStatistics.test.ts
├── api/
│   └── menu.ts                   # 菜单管理API接口
├── stores/
│   └── menu.ts                   # 菜单状态管理
└── types/
    └── menu.ts                   # 菜单类型定义
```

## 核心组件

### 1. MenuCategoryManager组件

#### 1.1 组件说明
菜单分类管理组件，提供菜单分类的层级管理功能，支持多级分类结构。

#### 1.2 核心功能
- 分类树形展示
- 添加分类
- 编辑分类
- 删除分类
- 添加子分类
- 启用/禁用分类
- 分类详情查看

#### 1.3 分类数据结构
```typescript
interface MenuCategory {
  id: number
  name: string
  parentId: number | null
  icon: string
  sortOrder: number
  available: boolean
  description?: string
  itemCount: number
  children?: MenuCategory[]
}
```

### 2. MenuPermissionManager组件

#### 2.1 组件说明
菜单权限管理组件，提供菜单访问权限的精细化控制，支持基于角色的权限分配。

#### 2.2 核心功能
- 角色列表展示
- 权限分组管理
- 权限勾选配置
- 权限级别设置
- 权限规则添加
- 权限配置保存

#### 2.3 权限数据结构
```typescript
interface Role {
  id: number
  name: string
  type: 'admin' | 'normal'
  description?: string
}

interface PermissionGroup {
  key: string
  label: string
  checked: boolean
  indeterminate: boolean
  expanded: boolean
  permissions: Permission[]
}

interface Permission {
  key: string
  label: string
  level: 'read' | 'write'
  description?: string
}
```

### 3. MenuBatchOperations组件

#### 3.1 组件说明
菜单批量操作组件，提供对多个菜品的同时操作功能，提高管理效率。

#### 3.2 核心功能
- 批量状态更新
- 批量价格调整
- 批量分类调整
- 批量导出
- 批量打印
- 批量删除

#### 3.3 批量操作数据结构
```typescript
interface MenuItem {
  id: number
  name: string
  price: number
  category: string
  available: boolean
}

interface PreviewData {
  name: string
  currentPrice: number
  newPrice: number
  change: number
}
```

## API接口

### 1. 菜品管理接口

#### 1.1 获取菜品列表
```typescript
interface GetMenuItemsParams {
  page: number
  limit: number
  category?: string
  available?: boolean
  search?: string
}

interface GetMenuItemsResponse {
  success: boolean
  data: {
    items: MenuItem[]
    pagination: {
      page: number
      limit: number
      total: number
      totalPages: number
    }
  }
}

export function getMenuItems(params: GetMenuItemsParams): Promise<GetMenuItemsResponse>
```

#### 1.2 获取菜品详情
```typescript
export function getMenuItem(itemId: number): Promise<{
  success: boolean
  data: MenuItem
}>
```

#### 1.3 创建菜品
```typescript
interface CreateMenuItemRequest {
  name: string
  category: string
  price: number
  imageUrl?: string
  description?: string
  preparationTime?: number
  available: boolean
}

export function createMenuItem(data: CreateMenuItemRequest): Promise<{
  success: boolean
  data: MenuItem
}>
```

#### 1.4 更新菜品
```typescript
export function updateMenuItem(itemId: number, data: Partial<CreateMenuItemRequest>): Promise<{
  success: boolean
  data: MenuItem
}>
```

#### 1.5 删除菜品
```typescript
export function deleteMenuItem(itemId: number): Promise<{
  success: boolean
  message: string
}>
```

#### 1.6 批量更新状态
```typescript
interface BatchUpdateStatusRequest {
  itemIds: number[]
  available: boolean
}

export function batchUpdateStatus(data: BatchUpdateStatusRequest): Promise<{
  success: boolean
  message: string
}>
```

#### 1.7 批量调整价格
```typescript
interface BatchAdjustPriceRequest {
  items: Array<{
    itemId: number
    newPrice: number
  }>
}

export function batchAdjustPrice(data: BatchAdjustPriceRequest): Promise<{
  success: boolean
  message: string
}>
```

#### 1.8 批量更新分类
```typescript
interface BatchUpdateCategoryRequest {
  itemIds: number[]
  categoryId: number
}

export function batchUpdateCategory(data: BatchUpdateCategoryRequest): Promise<{
  success: boolean
  message: string
}>
```

#### 1.9 批量删除
```typescript
interface BatchDeleteRequest {
  itemIds: number[]
}

export function batchDeleteItems(data: BatchDeleteRequest): Promise<{
  success: boolean
  message: string
}>
```

### 2. 分类管理接口

#### 2.1 获取分类列表
```typescript
export function getCategories(): Promise<{
  success: boolean
  data: MenuCategory[]
}>
```

#### 2.2 创建分类
```typescript
interface CreateCategoryRequest {
  name: string
  parentId: number | null
  icon: string
  sortOrder: number
  description?: string
  available: boolean
}

export function createCategory(data: CreateCategoryRequest): Promise<{
  success: boolean
  data: MenuCategory
}>
```

#### 2.3 更新分类
```typescript
export function updateCategory(categoryId: number, data: Partial<CreateCategoryRequest>): Promise<{
  success: boolean
  data: MenuCategory
}>
```

#### 2.4 删除分类
```typescript
export function deleteCategory(categoryId: number): Promise<{
  success: boolean
  message: string
}>
```

#### 2.5 更新分类状态
```typescript
interface UpdateCategoryStatusRequest {
  available: boolean
}

export function updateCategoryStatus(categoryId: number, data: UpdateCategoryStatusRequest): Promise<{
  success: boolean
  message: string
}>
```

### 3. 权限管理接口

#### 3.1 获取角色列表
```typescript
export function getRoles(): Promise<{
  success: boolean
  data: Role[]
}>
```

#### 3.2 获取角色权限
```typescript
export function getRolePermissions(roleId: number): Promise<{
  success: boolean
  data: {
    permissions: string[]
  }
}>
```

#### 3.3 更新角色权限
```typescript
interface UpdateRolePermissionsRequest {
  permissions: string[]
}

export function updateRolePermissions(roleId: number, data: UpdateRolePermissionsRequest): Promise<{
  success: boolean
  message: string
}>
```

#### 3.4 创建权限规则
```typescript
interface CreatePermissionRuleRequest {
  roleId: number
  categoryId: number
  permissionLevel: 'read' | 'write' | 'full'
  actions: string[]
  description?: string
}

export function createPermissionRule(data: CreatePermissionRuleRequest): Promise<{
  success: boolean
  data: PermissionRule
}>
```

### 4. 导出接口

#### 4.1 导出Excel
```typescript
export function exportToExcel(itemIds: number[]): Promise<Blob>
```

#### 4.2 导出PDF
```typescript
export function exportToPDF(itemIds: number[]): Promise<Blob>
```

#### 4.3 导出CSV
```typescript
export function exportToCSV(itemIds: number[]): Promise<Blob>
```

### 5. 打印接口

#### 5.1 打印菜单
```typescript
export function printMenu(itemIds: number[]): Promise<{
  success: boolean
  data: {
    printUrl: string
  }
}>
```

#### 5.2 生成二维码
```typescript
export function generateQRCode(itemIds: number[]): Promise<{
  success: boolean
  data: {
    qrCodeUrl: string
  }
}>
```

## 类型定义

### 1. 菜品类型
```typescript
export interface MenuItem {
  id: number
  name: string
  category: string
  price: number
  imageUrl?: string
  description?: string
  preparationTime?: number
  available: boolean
  createdAt: string
  updatedAt: string
}
```

### 2. 分类类型
```typescript
export interface MenuCategory {
  id: number
  name: string
  parentId: number | null
  icon: string
  sortOrder: number
  available: boolean
  description?: string
  itemCount: number
  children?: MenuCategory[]
}
```

### 3. 角色类型
```typescript
export interface Role {
  id: number
  name: string
  type: 'admin' | 'normal'
  description?: string
}
```

### 4. 权限类型
```typescript
export interface Permission {
  key: string
  label: string
  level: 'read' | 'write'
  description?: string
}

export interface PermissionGroup {
  key: string
  label: string
  checked: boolean
  indeterminate: boolean
  expanded: boolean
  permissions: Permission[]
}
```

### 5. 权限规则类型
```typescript
export interface PermissionRule {
  id: number
  roleId: number
  categoryId: number
  permissionLevel: 'read' | 'write' | 'full'
  actions: string[]
  description?: string
  createdAt: string
}
```

## 状态管理

### 1. Menu Store

```typescript
export const useMenuStore = defineStore('menu', () => {
  const loading = ref(false)
  const error = ref<string | null>(null)
  const menuItems = ref<MenuItem[]>([])
  const categories = ref<MenuCategory[]>([])
  const selectedCategory = ref<MenuCategory | null>(null)
  const selectedItems = ref<MenuItem[]>([])

  async function fetchMenuItems(params: GetMenuItemsParams) {
    loading.value = true
    try {
      const response = await getMenuItems(params)
      if (response.success) {
        menuItems.value = response.data.items
      }
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
    } finally {
      loading.value = false
    }
  }

  async function fetchCategories() {
    loading.value = true
    try {
      const response = await getCategories()
      if (response.success) {
        categories.value = response.data
      }
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
    } finally {
      loading.value = false
    }
  }

  async function createMenuItem(data: CreateMenuItemRequest) {
    loading.value = true
    try {
      const response = await createMenuItem(data)
      if (response.success) {
        menuItems.value.unshift(response.data)
      }
      return response
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
      throw err
    } finally {
      loading.value = false
    }
  }

  async function updateMenuItem(itemId: number, data: Partial<CreateMenuItemRequest>) {
    loading.value = true
    try {
      const response = await updateMenuItem(itemId, data)
      if (response.success) {
        const index = menuItems.value.findIndex(item => item.id === itemId)
        if (index !== -1) {
          menuItems.value[index] = response.data
        }
      }
      return response
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
      throw err
    } finally {
      loading.value = false
    }
  }

  async function deleteMenuItem(itemId: number) {
    loading.value = true
    try {
      const response = await deleteMenuItem(itemId)
      if (response.success) {
        menuItems.value = menuItems.value.filter(item => item.id !== itemId)
      }
      return response
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
      throw err
    } finally {
      loading.value = false
    }
  }

  return {
    loading,
    error,
    menuItems,
    categories,
    selectedCategory,
    selectedItems,
    fetchMenuItems,
    fetchCategories,
    createMenuItem,
    updateMenuItem,
    deleteMenuItem
  }
})
```

## 测试

### 1. 单元测试

#### 1.1 MenuCategoryManager组件测试
```typescript
describe('MenuCategoryManager组件', () => {
  it('应该正确渲染分类树', () => {
    const wrapper = mount(MenuCategoryManager)
    expect(wrapper.find('.category-tree').exists()).toBe(true)
  })

  it('应该能够添加分类', async () => {
    const wrapper = mount(MenuCategoryManager)
    await wrapper.vm.showCreateDialog = true
    wrapper.vm.formData.name = '新分类'
    await wrapper.vm.handleSubmit()
    expect(wrapper.vm.showCreateDialog).toBe(false)
  })

  it('应该能够编辑分类', async () => {
    const wrapper = mount(MenuCategoryManager)
    const mockCategory = {
      id: 1,
      name: '主食',
      parentId: null,
      icon: 'Dish',
      sortOrder: 1,
      available: true,
      itemCount: 15
    }
    await wrapper.vm.handleEdit(mockCategory)
    expect(wrapper.vm.editingCategory).toEqual(mockCategory)
  })
})
```

#### 1.2 MenuPermissionManager组件测试
```typescript
describe('MenuPermissionManager组件', () => {
  it('应该正确渲染角色列表', () => {
    const wrapper = mount(MenuPermissionManager)
    expect(wrapper.find('.role-section').exists()).toBe(true)
  })

  it('应该能够选择角色', async () => {
    const wrapper = mount(MenuPermissionManager)
    await wrapper.vm.handleRoleChange(1)
    expect(wrapper.vm.selectedRole).toBe(1)
  })

  it('应该能够保存权限配置', async () => {
    const wrapper = mount(MenuPermissionManager)
    wrapper.vm.selectedPermissions = ['menu.view', 'menu.create']
    await wrapper.vm.savePermissions()
    expect(wrapper.vm.saving).toBe(false)
  })
})
```

#### 1.3 MenuBatchOperations组件测试
```typescript
describe('MenuBatchOperations组件', () => {
  it('应该正确显示选择信息', () => {
    const mockItems = [
      { id: 1, name: '宫保鸡丁', price: 38, category: '主食', available: true }
    ]
    const wrapper = mount(MenuBatchOperations, {
      props: {
        selectedItems: mockItems
      }
    })
    expect(wrapper.find('.selection-info').exists()).toBe(true)
  })

  it('应该能够批量更新状态', async () => {
    const mockItems = [
      { id: 1, name: '宫保鸡丁', price: 38, category: '主食', available: true }
    ]
    const wrapper = mount(MenuBatchOperations, {
      props: {
        selectedItems: mockItems
      }
    })
    await wrapper.vm.batchUpdateStatus(false)
    expect(wrapper.vm.loading).toBe(false)
  })
})
```

## 性能优化

### 1. 组件优化
- 使用Vue 3 Composition API减少不必要的重渲染
- 使用computed缓存计算结果
- 使用v-memo优化列表渲染
- 使用虚拟滚动优化大数据量列表

### 2. 数据优化
- 使用请求缓存减少重复请求
- 使用分页加载减少数据传输量
- 使用数据预加载提升用户体验
- 使用WebSocket实现实时数据更新

### 3. 图片优化
- 使用懒加载减少初始加载时间
- 使用WebP格式减少图片大小
- 使用CDN加速图片加载
- 使用图片压缩工具优化图片质量

## 部署说明

### 1. 环境要求
- Node.js >= 18.0.0
- npm >= 9.0.0

### 2. 安装依赖
```bash
npm install
```

### 3. 开发环境
```bash
npm run dev
```

### 4. 生产构建
```bash
npm run build
```

### 5. 运行测试
```bash
npm run test
```

### 6. 代码检查
```bash
npm run lint
npm run type-check
```

## 开发规范

### 1. 代码风格
- 使用TypeScript进行类型检查
- 遵循ESLint代码规范
- 使用Prettier进行代码格式化
- 遵循Vue 3 Composition API最佳实践

### 2. 命名规范
- 组件名使用PascalCase
- 文件名使用PascalCase
- 变量名使用camelCase
- 常量名使用UPPER_SNAKE_CASE

### 3. 注释规范
- 使用JSDoc注释函数和类
- 使用单行注释解释复杂逻辑
- 使用TODO标记待完成功能

### 4. Git提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建/工具相关
```

## 版本历史

### v1.0.0 (2025-01-20)
- 初始版本发布
- 实现菜品管理功能
- 实现分类管理功能
- 实现权限管理功能
- 实现批量操作功能
- 完成单元测试覆盖
- 完成用户手册和开发文档

## 联系方式

如有任何问题或建议，请联系开发团队：
- 邮箱: dev@yyc3.com
- 项目地址: https://github.com/yyc3/catering-platform
