# 数据分析功能模块开发文档

## 模块概述

数据分析模块是YYC³餐饮行业智能化平台的核心分析模块，提供全方位的业务数据洞察与分析功能。该模块采用Vue 3 + TypeScript + Element Plus技术栈，使用ECharts进行数据可视化。

## 技术架构

### 1. 技术栈
- **前端框架**: Vue 3.4+ (Composition API)
- **UI组件库**: Element Plus 2.4+
- **图表库**: ECharts 5.4+
- **状态管理**: Pinia 2.1+
- **路由管理**: Vue Router 4.2+
- **HTTP客户端**: Axios 1.7+
- **类型检查**: TypeScript 5.3+
- **构建工具**: Vite 5.4+

### 2. 目录结构
```
src/
├── components/
│   └── analytics/
│       ├── AlertSystem.vue          # 异常预警组件
│       ├── CustomDashboard.vue      # 自定义仪表板组件
│       └── __tests__/
│           ├── AlertSystem.test.ts  # 异常预警组件测试
│           └── CustomDashboard.test.ts  # 自定义仪表板组件测试
├── views/
│   └── DataAnalytics.vue            # 数据分析主页面
├── api/
│   └── analytics.ts                 # 数据分析API接口
├── stores/
│   └── analytics.ts                 # 数据分析状态管理
└── types/
    └── analytics.ts                 # 数据分析类型定义
```

## 核心组件

### 1. AlertSystem组件

#### 1.1 组件说明
异常预警组件，提供实时监控、预警管理、阈值配置等功能。

#### 1.2 组件接口
```typescript
interface Alert {
  id: number
  severity: 'critical' | 'warning' | 'info'
  type: 'revenue' | 'orders' | 'customers' | 'satisfaction'
  title: string
  description: string
  currentValue: number
  threshold: number
  unit: string
  deviation: number
  createdAt: string
  status: 'pending' | 'processing' | 'resolved'
}

interface AlertThreshold {
  type: string
  enabled: boolean
  condition: 'above' | 'below' | 'equal'
  value: number
  unit: string
}

interface AlertNotification {
  type: string
  enabled: boolean
  email?: string
  phone?: string
  webhook?: string
}
```

#### 1.3 核心功能
- 预警概览展示
- 预警列表管理
- 预警详情查看
- 预警处理操作
- 阈值配置
- 通知设置
- 预警历史记录
- 预警趋势图表

#### 1.4 使用示例
```vue
<template>
  <AlertSystem />
</template>

<script setup lang="ts">
import AlertSystem from '@/components/analytics/AlertSystem.vue'
</script>
```

### 2. CustomDashboard组件

#### 2.1 组件说明
自定义仪表板组件，提供仪表板管理、组件配置、拖拽布局等功能。

#### 2.2 组件接口
```typescript
interface Dashboard {
  id: number
  name: string
  description: string
  widgets: Widget[]
  layout: {
    columns: number
    gap: number
  }
  sharing: {
    isPublic: boolean
    allowedUsers: string[]
    permissions: ('view' | 'edit')[]
  }
  createdAt: string
}

interface Widget {
  id: string
  type: 'metric' | 'chart' | 'table' | 'gauge' | 'progress'
  title: string
  analytics: string
  metrics: string[]
  dimensions: string[]
  filters: Record<string, any>
  visualization: {
    showLegend: boolean
    showGrid: boolean
    showLabels: boolean
  }
  layout: {
    x: number
    y: number
    width: number
    height: number
  }
  refreshInterval: number
}
```

#### 2.3 核心功能
- 仪表板创建、编辑、删除、复制
- 仪表板导入导出
- 仪表板分享
- 组件添加、编辑、删除
- 拖拽布局
- 编辑模式切换
- 自动刷新
- 日期范围筛选

#### 2.4 使用示例
```vue
<template>
  <CustomDashboard />
</template>

<script setup lang="ts">
import CustomDashboard from '@/components/analytics/CustomDashboard.vue'
</script>
```

## API接口

### 1. 数据分析API

#### 1.1 销售分析
```typescript
interface SalesAnalytics {
  totalRevenue: number
  orderCount: number
  averageOrderValue: number
  conversionRate: number
  revenueTrend: { date: string; value: number }[]
  orderDistribution: { time: string; count: number }[]
  topProducts: { name: string; count: number; revenue: number }[]
}

export function getSalesAnalytics(params: {
  dateRange: DateRange
}): Promise<SalesAnalytics>
```

#### 1.2 客户分析
```typescript
interface CustomerAnalytics {
  newCustomers: number
  activeCustomers: number
  retentionRate: number
  satisfaction: number
  customerGrowth: { date: string; count: number }[]
  customerDistribution: { range: string; count: number }[]
  retentionCurve: { period: string; rate: number }[]
}

export function getCustomerAnalytics(params: {
  dateRange: DateRange
}): Promise<CustomerAnalytics>
```

#### 1.3 菜单分析
```typescript
interface MenuAnalytics {
  dishSales: { name: string; count: number }[]
  dishRevenue: { name: string; revenue: number }[]
  dishRatings: { name: string; rating: number }[]
  repurchaseRate: { name: string; rate: number }[]
}

export function getMenuAnalytics(params: {
  dateRange: DateRange
}): Promise<MenuAnalytics>
```

#### 1.4 运营分析
```typescript
interface OperationalAnalytics {
  completionRate: number
  averageProcessingTime: number
  kitchenEfficiency: number
  costControl: number
  processingTimeDistribution: { range: string; count: number }[]
  efficiencyTrend: { date: string; value: number }[]
  costAnalysis: { category: string; amount: number }[]
}

export function getOperationalAnalytics(params: {
  dateRange: DateRange
}): Promise<OperationalAnalytics>
```

#### 1.5 预测分析
```typescript
interface PredictiveAnalytics {
  salesPrediction: { date: string; value: number }[]
  customerPrediction: { date: string; count: number }[]
  demandForecast: { dish: string; demand: number; recommendation: string }[]
}

export function getPredictiveAnalytics(params: {
  dateRange: DateRange
}): Promise<PredictiveAnalytics>
```

#### 1.6 仪表板数据
```typescript
interface DashboardData {
  revenue: number
  orders: number
  customers: number
  conversion: number
  satisfaction: number
  efficiency: number
}

export function getDashboardData(params: {
  dateRange: DateRange
}): Promise<DashboardData>
```

#### 1.7 数据导出
```typescript
export function exportData(params: {
  type: 'sales' | 'customer' | 'menu' | 'operational'
  format: 'excel' | 'pdf' | 'csv'
  dateRange: DateRange
}): Promise<Blob>
```

### 2. 异常预警API

#### 2.1 获取预警列表
```typescript
export function getAlerts(params: {
  page: number
  pageSize: number
  severity?: string
}): Promise<{ list: Alert[]; total: number }>
```

#### 2.2 获取预警详情
```typescript
export function getAlertDetail(id: number): Promise<Alert>
```

#### 2.3 处理预警
```typescript
export function resolveAlert(id: number, note: string): Promise<void>
```

#### 2.4 获取预警设置
```typescript
export function getAlertSettings(): Promise<{
  thresholds: AlertThreshold[]
  notifications: AlertNotification[]
}>
```

#### 2.5 保存预警设置
```typescript
export function saveAlertSettings(settings: {
  thresholds: AlertThreshold[]
  notifications: AlertNotification[]
}): Promise<void>
```

#### 2.6 获取预警历史
```typescript
export function getAlertHistory(params: {
  page: number
  pageSize: number
}): Promise<{ list: Alert[]; total: number }>
```

### 3. 自定义仪表板API

#### 3.1 获取仪表板列表
```typescript
export function getDashboardList(): Promise<Dashboard[]>
```

#### 3.2 获取仪表板详情
```typescript
export function getDashboardDetail(id: number): Promise<Dashboard>
```

#### 3.3 创建仪表板
```typescript
export function createDashboard(data: {
  name: string
  description: string
  layout: { columns: number; gap: number }
}): Promise<Dashboard>
```

#### 3.4 更新仪表板
```typescript
export function updateDashboard(id: number, data: Partial<Dashboard>): Promise<void>
```

#### 3.5 删除仪表板
```typescript
export function deleteDashboard(id: number): Promise<void>
```

#### 3.6 复制仪表板
```typescript
export function duplicateDashboard(id: number): Promise<Dashboard>
```

#### 3.7 导出仪表板
```typescript
export function exportDashboard(id: number): Promise<string>
```

#### 3.8 导入仪表板
```typescript
export function importDashboard(config: string): Promise<Dashboard>
```

#### 3.9 生成分享链接
```typescript
export function generateShareLink(params: {
  dashboardId: number
  permission: 'view' | 'edit'
  expiresIn?: number
}): Promise<{ url: string; expiresAt: string }>
```

## 状态管理

### 1. Analytics Store

```typescript
export const useAnalyticsStore = defineStore('analytics', () => {
  const loading = ref(false)
  const error = ref<string | null>(null)
  const dashboardData = ref<DashboardData | null>(null)
  const salesAnalytics = ref<SalesAnalytics | null>(null)
  const customerAnalytics = ref<CustomerAnalytics | null>(null)
  const menuAnalytics = ref<MenuAnalytics | null>(null)
  const operationalAnalytics = ref<OperationalAnalytics | null>(null)
  const predictiveAnalytics = ref<PredictiveAnalytics | null>(null)

  async function fetchDashboardData(dateRange: DateRange) {
    loading.value = true
    try {
      dashboardData.value = await getDashboardData({ dateRange })
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
    } finally {
      loading.value = false
    }
  }

  async function fetchSalesAnalytics(dateRange: DateRange) {
    loading.value = true
    try {
      salesAnalytics.value = await getSalesAnalytics({ dateRange })
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Unknown error'
    } finally {
      loading.value = false
    }
  }

  return {
    loading,
    error,
    dashboardData,
    salesAnalytics,
    customerAnalytics,
    menuAnalytics,
    operationalAnalytics,
    predictiveAnalytics,
    fetchDashboardData,
    fetchSalesAnalytics
  }
})
```

## 图表配置

### 1. ECharts配置示例

#### 1.1 收入趋势图
```typescript
const revenueTrendOption = {
  tooltip: {
    trigger: 'axis',
    formatter: (params: any) => {
      return `${params[0].axisValue}<br/>收入: ¥${params[0].value.toLocaleString()}`
    }
  },
  xAxis: {
    type: 'category',
    data: dates
  },
  yAxis: {
    type: 'value',
    axisLabel: {
      formatter: (value: number) => `¥${value.toLocaleString()}`
    }
  },
  series: [{
    data: values,
    type: 'line',
    smooth: true,
    areaStyle: {
      opacity: 0.3
    }
  }]
}
```

#### 1.2 产品销售排行图
```typescript
const topProductsOption = {
  tooltip: {
    trigger: 'axis',
    axisPointer: {
      type: 'shadow'
    }
  },
  xAxis: {
    type: 'value'
  },
  yAxis: {
    type: 'category',
    data: productNames
  },
  series: [{
    type: 'bar',
    data: salesCounts,
    label: {
      show: true,
      position: 'right'
    }
  }]
}
```

## 测试

### 1. 单元测试

#### 1.1 AlertSystem组件测试
```typescript
describe('AlertSystem组件', () => {
  it('应该正确渲染预警概览卡片', () => {
    const wrapper = mount(AlertSystem)
    expect(wrapper.find('.alert-overview').exists()).toBe(true)
  })

  it('应该能够查看预警详情', async () => {
    const wrapper = mount(AlertSystem)
    await wrapper.vm.$nextTick()
    const viewButton = wrapper.findAll('.el-button').find(btn => btn.text() === '查看')
    if (viewButton) {
      await viewButton.trigger('click')
      expect(wrapper.vm.showAlertDetail).toBe(true)
    }
  })
})
```

#### 1.2 CustomDashboard组件测试
```typescript
describe('CustomDashboard组件', () => {
  it('应该正确渲染仪表板头部', () => {
    const wrapper = mount(CustomDashboard)
    expect(wrapper.find('.dashboard-header').exists()).toBe(true)
  })

  it('应该能够创建新仪表板', async () => {
    const wrapper = mount(CustomDashboard)
    await wrapper.setData({
      showCreateDialog: true,
      newDashboard: {
        name: '新仪表板',
        description: '新仪表板描述',
        layout: { columns: 6, gap: 16 }
      }
    })
    await wrapper.vm.createDashboard()
    expect(wrapper.vm.dashboardList.length).toBeGreaterThan(0)
  })
})
```

## 性能优化

### 1. 组件优化
- 使用Vue 3 Composition API减少不必要的重渲染
- 使用computed缓存计算结果
- 使用v-memo优化列表渲染
- 使用虚拟滚动优化大数据量列表

### 2. 图表优化
- 使用ECharts的按需加载
- 合理设置图表刷新间隔
- 使用数据采样减少渲染负担
- 使用Web Worker处理大数据计算

### 3. 网络优化
- 使用请求缓存减少重复请求
- 使用请求合并减少请求次数
- 使用数据预加载提升用户体验
- 使用WebSocket实现实时数据更新

## 部署说明

### 1. 环境要求
- Node.js >= 18.0.0
- npm >= 9.0.0

### 2. 安装依赖
```bash
npm install
```

### 3. 开发环境
```bash
npm run dev
```

### 4. 生产构建
```bash
npm run build
```

### 5. 运行测试
```bash
npm run test
```

### 6. 代码检查
```bash
npm run lint
npm run type-check
```

## 开发规范

### 1. 代码风格
- 使用TypeScript进行类型检查
- 遵循ESLint代码规范
- 使用Prettier进行代码格式化
- 遵循Vue 3 Composition API最佳实践

### 2. 命名规范
- 组件名使用PascalCase
- 文件名使用PascalCase
- 变量名使用camelCase
- 常量名使用UPPER_SNAKE_CASE

### 3. 注释规范
- 使用JSDoc注释函数和类
- 使用单行注释解释复杂逻辑
- 使用TODO标记待完成功能

### 4. Git提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建/工具相关
```

## 版本历史

### v1.0.0 (2025-01-20)
- 初始版本发布
- 实现销售分析、客户分析、菜单分析、运营分析、预测分析功能
- 实现异常预警系统
- 实现自定义仪表板功能
- 完成单元测试覆盖
- 完成用户手册和开发文档

## 联系方式

如有任何问题或建议，请联系开发团队：
- 邮箱: dev@yyc3.com
- 项目地址: https://github.com/yyc3/catering-platform
