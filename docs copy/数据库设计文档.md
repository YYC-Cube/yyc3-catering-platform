# YYCÂ³é¤é¥®è¡Œä¸šæ™ºèƒ½åŒ–å¹³å° - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> ***YanYuCloudCube***
> **æ ‡è¯­**ï¼šè¨€å¯è±¡é™ | è¯­æ¢æœªæ¥
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **æ ‡è¯­**ï¼šä¸‡è±¡å½’å…ƒäºäº‘æ¢ | æ·±æ ˆæ™ºå¯æ–°çºªå…ƒ
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| å±æ€§ | å†…å®¹ |
|------|------|
| **æ–‡æ¡£æ ‡é¢˜** | YYCÂ³é¤é¥®è¡Œä¸šæ™ºèƒ½åŒ–å¹³å°æ•°æ®åº“è®¾è®¡æ–‡æ¡£ |
| **æ–‡æ¡£ç‰ˆæœ¬** | v1.0.0 |
| **åˆ›å»ºæ—¶é—´** | 2025-12-28 |
| **æ•°æ®åº“ç±»å‹** | PostgreSQL 14+ |
| **æ•°æ®åº“ç‰ˆæœ¬** | v1.0.0 |
| **ä½œè€…** | YYCÂ³ Team |

---

## ğŸ“– ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. æ•°æ®åº“æ¶æ„](#2-æ•°æ®åº“æ¶æ„)
- [3. æ•°æ®å­—å…¸](#3-æ•°æ®å­—å…¸)
- [4. è¡¨ç»“æ„è¯¦è§£](#4-è¡¨ç»“æ„è¯¦è§£)
  - [4.1 ç”¨æˆ·ç›¸å…³è¡¨](#41-ç”¨æˆ·ç›¸å…³è¡¨)
  - [4.2 é—¨åº—ç›¸å…³è¡¨](#42-é—¨åº—ç›¸å…³è¡¨)
  - [4.3 èœå•ç›¸å…³è¡¨](#43-èœå•ç›¸å…³è¡¨)
  - [4.4 ä¼šå‘˜ç›¸å…³è¡¨](#44-ä¼šå‘˜ç›¸å…³è¡¨)
  - [4.5 è®¢å•ç›¸å…³è¡¨](#45-è®¢å•ç›¸å…³è¡¨)
  - [4.6 è¥é”€ç›¸å…³è¡¨](#46-è¥é”€ç›¸å…³è¡¨)
  - [4.7 æ”¯ä»˜ç›¸å…³è¡¨](#47-æ”¯ä»˜ç›¸å…³è¡¨)
  - [4.8 ç³»ç»Ÿç›¸å…³è¡¨](#48-ç³»ç»Ÿç›¸å…³è¡¨)
- [5. ERå…³ç³»å›¾](#5-erå…³ç³»å›¾)
- [6. ç´¢å¼•è®¾è®¡](#6-ç´¢å¼•è®¾è®¡)
- [7. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–](#7-æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–)
- [8. æ•°æ®åº“å®‰å…¨](#8-æ•°æ®åº“å®‰å…¨)
- [9. è¿ç§»ç®¡ç†](#9-è¿ç§»ç®¡ç†)

---

## 1. æ¦‚è¿°

### 1.1 é¡¹ç›®ç®€ä»‹

YYCÂ³é¤é¥®è¡Œä¸šæ™ºèƒ½åŒ–å¹³å°æ˜¯ä¸€ä¸ªåŸºäºPostgreSQLçš„å…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿï¼Œä¸ºé¤é¥®è¡Œä¸šæä¾›å…¨é¢çš„æ™ºèƒ½åŒ–ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚æ•°æ®åº“é‡‡ç”¨å››å±‚ä¸€ä½“åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œç¡®ä¿æ•°æ®çš„é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€é«˜å®‰å…¨ã€é«˜æ‰©å±•å’Œé«˜å¯ç»´æŠ¤æ€§ã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§

- **é«˜å¯ç”¨æ€§**ï¼šæ”¯æŒä¸»ä»å¤åˆ¶ã€è¯»å†™åˆ†ç¦»
- **é«˜æ€§èƒ½**ï¼šä¼˜åŒ–çš„ç´¢å¼•è®¾è®¡ã€æŸ¥è¯¢ä¼˜åŒ–
- **é«˜å®‰å…¨æ€§**ï¼šæ•°æ®åŠ å¯†ã€è®¿é—®æ§åˆ¶ã€å®¡è®¡æ—¥å¿—
- **é«˜æ‰©å±•æ€§**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•ã€åˆ†åº“åˆ†è¡¨
- **é«˜å¯ç»´æŠ¤æ€§**ï¼šå®Œå–„çš„è¿ç§»ç®¡ç†ã€æ–‡æ¡£é½å…¨

### 1.3 æŠ€æœ¯æ ˆ

- **æ•°æ®åº“å¼•æ“**ï¼šPostgreSQL 14+
- **è¿æ¥æ± **ï¼špg (Node.js)
- **ORM**ï¼šPrisma (å¯é€‰)
- **è¿ç§»å·¥å…·**ï¼šè‡ªå®šä¹‰è¿ç§»ç®¡ç†å™¨
- **ç›‘æ§**ï¼špg_stat_statements

---

## 2. æ•°æ®åº“æ¶æ„

### 2.1 æ¶æ„è®¾è®¡

æ•°æ®åº“é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œåˆ†ä¸º8å¤§æ ¸å¿ƒæ¨¡å—ï¼š

```
YYCÂ³é¤é¥®è¡Œä¸šæ™ºèƒ½åŒ–å¹³å°æ•°æ®åº“
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†æ¨¡å— (Users)
â”œâ”€â”€ é—¨åº—ç®¡ç†æ¨¡å— (Stores)
â”œâ”€â”€ èœå•ç®¡ç†æ¨¡å— (Menu)
â”œâ”€â”€ ä¼šå‘˜ç®¡ç†æ¨¡å— (Members)
â”œâ”€â”€ è®¢å•ç®¡ç†æ¨¡å— (Orders)
â”œâ”€â”€ è¥é”€ç®¡ç†æ¨¡å— (Marketing)
â”œâ”€â”€ æ”¯ä»˜ç®¡ç†æ¨¡å— (Payments)
â””â”€â”€ ç³»ç»Ÿç®¡ç†æ¨¡å— (System)
```

### 2.2 æ•°æ®åº“å‘½åè§„èŒƒ

- **è¡¨å**ï¼šä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿åˆ†éš”ï¼Œä½¿ç”¨å¤æ•°å½¢å¼ï¼ˆå¦‚ï¼šusers, ordersï¼‰
- **å­—æ®µå**ï¼šä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿åˆ†éš”ï¼ˆå¦‚ï¼šuser_id, created_atï¼‰
- **ç´¢å¼•å**ï¼šå‰ç¼€ä¸º`idx_`ï¼Œåç¼€ä¸ºå­—æ®µåï¼ˆå¦‚ï¼šidx_users_emailï¼‰
- **å¤–é”®å**ï¼šæ ¼å¼ä¸º`è¡¨å_å­—æ®µå_fkey`ï¼ˆå¦‚ï¼šorders_member_id_fkeyï¼‰
- **è§¦å‘å™¨å**ï¼šæ ¼å¼ä¸º`update_è¡¨å_updated_at`ï¼ˆå¦‚ï¼šupdate_users_updated_atï¼‰

### 2.3 æ•°æ®ç±»å‹è§„èŒƒ

| æ•°æ®ç±»å‹ | ç”¨é€” | ç¤ºä¾‹ |
|---------|------|------|
| BIGSERIAL | è‡ªå¢ä¸»é”® | id BIGSERIAL PRIMARY KEY |
| BIGINT | å¤§æ•´æ•° | user_id BIGINT |
| INTEGER | æ•´æ•° | quantity INTEGER |
| DECIMAL(10,2) | é‡‘é¢ | price DECIMAL(10,2) |
| VARCHAR(n) | å¯å˜é•¿åº¦å­—ç¬¦ä¸² | name VARCHAR(100) |
| TEXT | é•¿æ–‡æœ¬ | description TEXT |
| TIMESTAMP | æ—¶é—´æˆ³ | created_at TIMESTAMP |
| BOOLEAN | å¸ƒå°”å€¼ | is_active BOOLEAN |
| JSONB | JSONæ•°æ® | config JSONB |
| ENUM | æšä¸¾ç±»å‹ | status order_status_enum |

---

## 3. æ•°æ®å­—å…¸

### 3.1 æšä¸¾ç±»å‹

#### ç”¨æˆ·ç›¸å…³æšä¸¾

```sql
-- ç”¨æˆ·è§’è‰²
user_role_enum: super_admin, admin, manager, staff

-- ç”¨æˆ·çŠ¶æ€
user_status_enum: active, inactive, locked
```

#### é—¨åº—ç›¸å…³æšä¸¾

```sql
-- é—¨åº—çŠ¶æ€
store_status_enum: active, inactive, maintenance

-- å‘˜å·¥èŒä½
staff_position_enum: manager, cashier, waiter, kitchen, cleaner, security

-- å‘˜å·¥çŠ¶æ€
staff_status_enum: active, resigned, suspended
```

#### è®¢å•ç›¸å…³æšä¸¾

```sql
-- è®¢å•ç±»å‹
order_type_enum: dine_in, takeaway, delivery

-- ç”¨é¤æ¨¡å¼
dining_mode_enum: single, group, buffet

-- è®¢å•çŠ¶æ€
order_status_enum: pending, confirmed, preparing, ready, serving, completed, cancelled, refunded

-- æ”¯ä»˜çŠ¶æ€
payment_status_enum: unpaid, paid, refunded, partial_refunded

-- æ”¯ä»˜æ–¹å¼
payment_method_enum: cash, alipay, wechat, unionpay, credit_card, member_balance, mixed

-- è®¢å•æ¥æº
order_source_enum: pos, mobile, web, weapp, phone

-- è®¢å•ä¼˜å…ˆçº§
order_priority_enum: low, normal, high, urgent

-- å¨æˆ¿çŠ¶æ€
kitchen_status_enum: pending, preparing, ready, served, cancelled
```

#### ä¼šå‘˜ç›¸å…³æšä¸¾

```sql
-- ä¼šå‘˜æ€§åˆ«
member_gender_enum: male, female, unknown

-- ä¼šå‘˜æ¥æº
member_source_enum: register, import, staff_add

-- ä¼šå‘˜çŠ¶æ€
member_status_enum: active, inactive, blacklisted

-- ç§¯åˆ†äº¤æ˜“ç±»å‹
points_transaction_type_enum: earn, redeem, expire, adjust, gift

-- ç§¯åˆ†æ¥æº
points_source_enum: order, refund, activity, manual, system
```

#### è¥é”€ç›¸å…³æšä¸¾

```sql
-- è¥é”€æ´»åŠ¨ç±»å‹
activity_type_enum: coupon, discount, points_exchange, flash_sale, group_buy, lucky_draw, recommend_reward

-- è¥é”€æ´»åŠ¨çŠ¶æ€
activity_status_enum: draft, published, active, paused, expired, cancelled

-- ä¼˜æƒ åˆ¸ç±»å‹
coupon_type_enum: fixed_amount, percentage, free_shipping, gift

-- ä¼˜æƒ åˆ¸çŠ¶æ€
coupon_status_enum: active, used, expired
```

#### æ”¯ä»˜ç›¸å…³æšä¸¾

```sql
-- æ”¯ä»˜é…ç½®æ–¹æ³•
payment_config_method_enum: alipay, wechat, unionpay, cash, credit_card, debit_card, digital_wallet, member_balance

-- æ”¯ä»˜äº¤æ˜“çŠ¶æ€
payment_transaction_status_enum: pending, processing, success, failed, cancelled, refunded, partially_refunded

-- é€€æ¬¾çŠ¶æ€
refund_status_enum: pending, processing, success, failed, cancelled
```

#### ç³»ç»Ÿç›¸å…³æšä¸¾

```sql
-- ç³»ç»Ÿé…ç½®ç±»å‹
config_type_enum: string, number, boolean, json, array

-- HTTPæ–¹æ³•
http_method_enum: GET, POST, PUT, DELETE, PATCH
```

---

## 4. è¡¨ç»“æ„è¯¦è§£

### 4.1 ç”¨æˆ·ç›¸å…³è¡¨

#### 4.1.1 usersï¼ˆç”¨æˆ·è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ç³»ç»Ÿç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯å’Œè®¤è¯ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | ç”¨æˆ·ID |
| username | VARCHAR(50) | NOT NULL, UNIQUE | - | ç”¨æˆ·å |
| email | VARCHAR(100) | NOT NULL, UNIQUE | - | é‚®ç®± |
| password_hash | VARCHAR(255) | NOT NULL | - | å¯†ç å“ˆå¸Œ |
| salt | VARCHAR(32) | NOT NULL | - | å¯†ç ç›å€¼ |
| full_name | VARCHAR(100) | NULL | - | å…¨å |
| phone | VARCHAR(20) | NULL | - | æ‰‹æœºå· |
| avatar | VARCHAR(255) | NULL | - | å¤´åƒURL |
| role | user_role_enum | NOT NULL | staff | è§’è‰² |
| status | user_status_enum | NOT NULL | active | çŠ¶æ€ |
| last_login_at | TIMESTAMP | NULL | - | æœ€åç™»å½•æ—¶é—´ |
| last_login_ip | VARCHAR(45) | NULL | - | æœ€åç™»å½•IP |
| login_count | INTEGER | NOT NULL | 0 | ç™»å½•æ¬¡æ•° |
| password_changed_at | TIMESTAMP | NULL | - | å¯†ç ä¿®æ”¹æ—¶é—´ |
| two_factor_enabled | BOOLEAN | NOT NULL | FALSE | æ˜¯å¦å¯ç”¨åŒå› å­è®¤è¯ |
| two_factor_secret | VARCHAR(32) | NULL | - | åŒå› å­è®¤è¯å¯†é’¥ |
| email_verified_at | TIMESTAMP | NULL | - | é‚®ç®±éªŒè¯æ—¶é—´ |
| phone_verified_at | TIMESTAMP | NULL | - | æ‰‹æœºéªŒè¯æ—¶é—´ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: username, email
- INDEX: role, status, created_at

**è§¦å‘å™¨**ï¼š
- update_users_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.1.2 rolesï¼ˆè§’è‰²æƒé™è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ç³»ç»Ÿè§’è‰²åŠå…¶æƒé™é…ç½®

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | SERIAL | PRIMARY KEY | AUTO | è§’è‰²ID |
| name | VARCHAR(50) | NOT NULL, UNIQUE | - | è§’è‰²åç§° |
| display_name | VARCHAR(100) | NOT NULL | - | æ˜¾ç¤ºåç§° |
| description | TEXT | NULL | - | æè¿° |
| permissions | JSONB | NOT NULL | - | æƒé™åˆ—è¡¨ |
| is_system | BOOLEAN | NOT NULL | FALSE | æ˜¯å¦ç³»ç»Ÿè§’è‰² |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: name
- INDEX: is_system

**è§¦å‘å™¨**ï¼š
- update_roles_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.1.3 user_rolesï¼ˆç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·ä¸è§’è‰²çš„å¤šå¯¹å¤šå…³ç³»

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | å…³è”ID |
| user_id | BIGINT | NOT NULL, FK(users) | - | ç”¨æˆ·ID |
| role_id | INTEGER | NOT NULL, FK(roles) | - | è§’è‰²ID |
| assigned_by | BIGINT | FK(users) | - | åˆ†é…äººID |
| assigned_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ†é…æ—¶é—´ |
| expires_at | TIMESTAMP | NULL | - | è¿‡æœŸæ—¶é—´ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: (user_id, role_id)
- INDEX: user_id, role_id

#### 4.1.4 user_sessionsï¼ˆç”¨æˆ·ä¼šè¯è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ç”¨æˆ·ç™»å½•ä¼šè¯ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | ä¼šè¯ID |
| user_id | BIGINT | NOT NULL, FK(users) | - | ç”¨æˆ·ID |
| session_token | VARCHAR(255) | NOT NULL, UNIQUE | - | ä¼šè¯ä»¤ç‰Œ |
| refresh_token | VARCHAR(255) | NULL | - | åˆ·æ–°ä»¤ç‰Œ |
| ip_address | VARCHAR(45) | NOT NULL | - | IPåœ°å€ |
| user_agent | TEXT | NULL | - | ç”¨æˆ·ä»£ç† |
| device_info | JSONB | NULL | - | è®¾å¤‡ä¿¡æ¯ |
| is_active | BOOLEAN | NOT NULL | TRUE | æ˜¯å¦æ´»è·ƒ |
| expires_at | TIMESTAMP | NOT NULL | - | è¿‡æœŸæ—¶é—´ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: session_token
- INDEX: user_id, expires_at

**è§¦å‘å™¨**ï¼š
- update_user_sessions_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

---

### 4.2 é—¨åº—ç›¸å…³è¡¨

#### 4.2.1 storesï¼ˆé—¨åº—è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨é—¨åº—çš„åŸºæœ¬ä¿¡æ¯å’Œé…ç½®

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | é—¨åº—ID |
| store_code | VARCHAR(20) | NOT NULL, UNIQUE | - | é—¨åº—ç¼–ç  |
| name | VARCHAR(100) | NOT NULL | - | é—¨åº—åç§° |
| description | TEXT | NULL | - | æè¿° |
| address | VARCHAR(255) | NOT NULL | - | åœ°å€ |
| longitude | DECIMAL(10,7) | NULL | - | ç»åº¦ |
| latitude | DECIMAL(10,7) | NULL | - | çº¬åº¦ |
| phone | VARCHAR(20) | NOT NULL | - | ç”µè¯ |
| email | VARCHAR(100) | NULL | - | é‚®ç®± |
| business_hours | JSONB | NULL | - | è¥ä¸šæ—¶é—´ |
| area | DECIMAL(8,2) | NULL | - | é¢ç§¯(å¹³æ–¹ç±³) |
| capacity | INTEGER | NULL | - | å®¹çº³äººæ•° |
| manager_id | BIGINT | FK(users) | - | åº—é•¿ID |
| status | store_status_enum | NOT NULL | active | çŠ¶æ€ |
| opening_date | DATE | NULL | - | å¼€ä¸šæ—¥æœŸ |
| logo | VARCHAR(255) | NULL | - | é—¨åº—Logo |
| images | JSONB | NULL | - | é—¨åº—å›¾ç‰‡ |
| features | JSONB | NULL | - | ç‰¹è‰²æœåŠ¡ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: store_code
- INDEX: name, manager_id, status

**è§¦å‘å™¨**ï¼š
- update_stores_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.2.2 store_staffï¼ˆé—¨åº—å‘˜å·¥è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨é—¨åº—å‘˜å·¥ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | ID |
| store_id | BIGINT | NOT NULL, FK(stores) | - | é—¨åº—ID |
| user_id | BIGINT | NOT NULL, FK(users) | - | ç”¨æˆ·ID |
| position | staff_position_enum | NOT NULL | - | èŒä½ |
| salary | DECIMAL(10,2) | NULL | - | è–ªèµ„ |
| hire_date | DATE | NOT NULL | - | å…¥èŒæ—¥æœŸ |
| status | staff_status_enum | NOT NULL | active | çŠ¶æ€ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: (store_id, user_id)
- INDEX: user_id, position

**è§¦å‘å™¨**ï¼š
- update_store_staff_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

---

### 4.3 èœå•ç›¸å…³è¡¨

#### 4.3.1 menu_categoriesï¼ˆèœå“åˆ†ç±»è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨èœå“åˆ†ç±»ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | åˆ†ç±»ID |
| name | VARCHAR(50) | NOT NULL | - | åˆ†ç±»åç§° |
| description | TEXT | NULL | - | æè¿° |
| image | VARCHAR(255) | NULL | - | åˆ†ç±»å›¾ç‰‡ |
| sort_order | INTEGER | NOT NULL | 0 | æ’åº |
| is_active | BOOLEAN | NOT NULL | TRUE | æ˜¯å¦å¯ç”¨ |
| store_id | BIGINT | FK(stores) | - | é—¨åº—ID |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- INDEX: store_id, sort_order

**è§¦å‘å™¨**ï¼š
- update_menu_categories_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.3.2 menu_itemsï¼ˆèœå“è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨èœå“è¯¦ç»†ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | èœå“ID |
| item_code | VARCHAR(20) | NOT NULL, UNIQUE | - | èœå“ç¼–ç  |
| name | VARCHAR(100) | NOT NULL | - | èœå“åç§° |
| description | TEXT | NULL | - | æè¿° |
| category_id | BIGINT | NOT NULL, FK(menu_categories) | - | åˆ†ç±»ID |
| price | DECIMAL(10,2) | NOT NULL | - | ä»·æ ¼ |
| original_price | DECIMAL(10,2) | NULL | - | åŸä»· |
| cost | DECIMAL(10,2) | NULL | - | æˆæœ¬ |
| unit | VARCHAR(20) | NOT NULL | ä»½ | å•ä½ |
| image | VARCHAR(255) | NULL | - | å›¾ç‰‡ |
| images | JSONB | NULL | - | å¤šå¼ å›¾ç‰‡ |
| nutrition_info | JSONB | NULL | - | è¥å…»ä¿¡æ¯ |
| allergen_info | JSONB | NULL | - | è¿‡æ•åŸä¿¡æ¯ |
| preparation_time | INTEGER | NULL | - | åˆ¶ä½œæ—¶é—´(åˆ†é’Ÿ) |
| spicy_level | SMALLINT | NOT NULL | 0 | è¾£åº¦ç­‰çº§(0-5) |
| is_recommended | BOOLEAN | NOT NULL | FALSE | æ˜¯å¦æ¨è |
| is_signature | BOOLEAN | NOT NULL | FALSE | æ˜¯å¦æ‹›ç‰Œèœ |
| is_available | BOOLEAN | NOT NULL | TRUE | æ˜¯å¦å¯å”® |
| sort_order | INTEGER | NOT NULL | 0 | æ’åº |
| daily_limit | INTEGER | NULL | - | æ¯æ—¥é™é‡ |
| tags | JSONB | NULL | - | æ ‡ç­¾ |
| store_id | BIGINT | FK(stores) | - | é—¨åº—ID |
| created_by | BIGINT | NOT NULL, FK(users) | - | åˆ›å»ºäººID |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: item_code
- INDEX: category_id, price, is_available, is_recommended, store_id, created_by

**è§¦å‘å™¨**ï¼š
- update_menu_items_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.3.3 menu_item_specsï¼ˆèœå“è§„æ ¼è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨èœå“è§„æ ¼ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | è§„æ ¼ID |
| item_id | BIGINT | NOT NULL, FK(menu_items) | - | èœå“ID |
| name | VARCHAR(50) | NOT NULL | - | è§„æ ¼åç§° |
| price | DECIMAL(10,2) | NOT NULL | - | ä»·æ ¼ |
| cost | DECIMAL(10,2) | NULL | - | æˆæœ¬ |
| description | TEXT | NULL | - | æè¿° |
| sort_order | INTEGER | NOT NULL | 0 | æ’åº |
| is_available | BOOLEAN | NOT NULL | TRUE | æ˜¯å¦å¯å”® |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- INDEX: item_id

**è§¦å‘å™¨**ï¼š
- update_menu_item_specs_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.3.4 menu_option_groupsï¼ˆèœå“é€‰é¡¹ç»„è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨èœå“é€‰é¡¹ç»„ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | é€‰é¡¹ç»„ID |
| name | VARCHAR(50) | NOT NULL | - | é€‰é¡¹ç»„åç§° |
| description | TEXT | NULL | - | æè¿° |
| min_selections | INTEGER | NOT NULL | 0 | æœ€å°‘é€‰æ‹©æ•° |
| max_selections | INTEGER | NOT NULL | 1 | æœ€å¤šé€‰æ‹©æ•° |
| is_required | BOOLEAN | NOT NULL | FALSE | æ˜¯å¦å¿…é€‰ |
| sort_order | INTEGER | NOT NULL | 0 | æ’åº |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- INDEX: sort_order

**è§¦å‘å™¨**ï¼š
- update_menu_option_groups_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.3.5 menu_optionsï¼ˆèœå“é€‰é¡¹è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨èœå“é€‰é¡¹ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | é€‰é¡¹ID |
| group_id | BIGINT | NOT NULL, FK(menu_option_groups) | - | é€‰é¡¹ç»„ID |
| name | VARCHAR(50) | NOT NULL | - | é€‰é¡¹åç§° |
| price | DECIMAL(10,2) | NOT NULL | 0.00 | ä»·æ ¼ |
| description | TEXT | NULL | - | æè¿° |
| sort_order | INTEGER | NOT NULL | 0 | æ’åº |
| is_available | BOOLEAN | NOT NULL | TRUE | æ˜¯å¦å¯å”® |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- INDEX: group_id

**è§¦å‘å™¨**ï¼š
- update_menu_options_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.3.6 menu_item_option_relationsï¼ˆèœå“é€‰é¡¹å…³è”è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨èœå“ä¸é€‰é¡¹ç»„çš„å¤šå¯¹å¤šå…³ç³»

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | å…³è”ID |
| item_id | BIGINT | NOT NULL, FK(menu_items) | - | èœå“ID |
| group_id | BIGINT | NOT NULL, FK(menu_option_groups) | - | é€‰é¡¹ç»„ID |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: (item_id, group_id)
- INDEX: item_id, group_id

---

### 4.4 ä¼šå‘˜ç›¸å…³è¡¨

#### 4.4.1 member_levelsï¼ˆä¼šå‘˜ç­‰çº§è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ä¼šå‘˜ç­‰çº§ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | ç­‰çº§ID |
| name | VARCHAR(50) | NOT NULL, UNIQUE | - | ç­‰çº§åç§° |
| description | TEXT | NULL | - | æè¿° |
| icon | VARCHAR(255) | NULL | - | ç­‰çº§å›¾æ ‡ |
| color | VARCHAR(7) | NULL | - | ç­‰çº§é¢œè‰² |
| min_points | INTEGER | NOT NULL | 0 | æœ€ä½ç§¯åˆ†è¦æ±‚ |
| max_points | INTEGER | NULL | - | æœ€é«˜ç§¯åˆ†è¦æ±‚ |
| discount_rate | DECIMAL(5,4) | NOT NULL | 1.0000 | æŠ˜æ‰£ç‡ |
| points_rate | DECIMAL(5,4) | NOT NULL | 1.0000 | ç§¯åˆ†å€ç‡ |
| birthday_points | INTEGER | NOT NULL | 0 | ç”Ÿæ—¥é¢å¤–ç§¯åˆ† |
| benefits | JSONB | NULL | - | æƒç›Š |
| sort_order | INTEGER | NOT NULL | 0 | æ’åº |
| is_active | BOOLEAN | NOT NULL | TRUE | æ˜¯å¦å¯ç”¨ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: name
- INDEX: min_points, sort_order

**è§¦å‘å™¨**ï¼š
- update_member_levels_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.4.2 membersï¼ˆä¼šå‘˜è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ä¼šå‘˜åŸºæœ¬ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | ä¼šå‘˜ID |
| member_no | VARCHAR(20) | NOT NULL, UNIQUE | - | ä¼šå‘˜å· |
| user_id | BIGINT | FK(users) | - | å…³è”ç”¨æˆ·ID |
| phone | VARCHAR(20) | NOT NULL | - | æ‰‹æœºå· |
| email | VARCHAR(100) | NULL | - | é‚®ç®± |
| nickname | VARCHAR(50) | NULL | - | æ˜µç§° |
| real_name | VARCHAR(50) | NULL | - | çœŸå®å§“å |
| gender | member_gender_enum | NOT NULL | unknown | æ€§åˆ« |
| birthday | DATE | NULL | - | ç”Ÿæ—¥ |
| avatar | VARCHAR(255) | NULL | - | å¤´åƒ |
| level_id | BIGINT | NOT NULL, FK(member_levels) | - | ç­‰çº§ID |
| points | INTEGER | NOT NULL | 0 | ç§¯åˆ† |
| total_points | INTEGER | NOT NULL | 0 | æ€»ç§¯åˆ† |
| balance | DECIMAL(10,2) | NOT NULL | 0.00 | è´¦æˆ·ä½™é¢ |
| total_spent | DECIMAL(12,2) | NOT NULL | 0.00 | ç´¯è®¡æ¶ˆè´¹ |
| order_count | INTEGER | NOT NULL | 0 | è®¢å•æ•°é‡ |
| last_order_at | TIMESTAMP | NULL | - | æœ€åä¸‹å•æ—¶é—´ |
| last_visit_at | TIMESTAMP | NULL | - | æœ€åè®¿é—®æ—¶é—´ |
| preferences | JSONB | NULL | - | åå¥½è®¾ç½® |
| tags | JSONB | NULL | - | æ ‡ç­¾ |
| source | member_source_enum | NOT NULL | register | æ¥æº |
| status | member_status_enum | NOT NULL | active | çŠ¶æ€ |
| remark | TEXT | NULL | - | å¤‡æ³¨ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: member_no
- INDEX: user_id, phone, level_id, points, total_spent, status

**è§¦å‘å™¨**ï¼š
- update_members_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.4.3 member_points_transactionsï¼ˆä¼šå‘˜ç§¯åˆ†è®°å½•è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ä¼šå‘˜ç§¯åˆ†äº¤æ˜“è®°å½•

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | è®°å½•ID |
| member_id | BIGINT | NOT NULL, FK(members) | - | ä¼šå‘˜ID |
| transaction_id | VARCHAR(50) | NOT NULL, UNIQUE | - | äº¤æ˜“ç¼–å· |
| type | points_transaction_type_enum | NOT NULL | - | ç±»å‹ |
| points | INTEGER | NOT NULL | - | ç§¯åˆ†æ•° |
| balance | INTEGER | NOT NULL | - | å˜åŠ¨åä½™é¢ |
| source | points_source_enum | NOT NULL | - | æ¥æº |
| source_id | BIGINT | NULL | - | æ¥æºID |
| description | VARCHAR(255) | NULL | - | æè¿° |
| expires_at | TIMESTAMP | NULL | - | è¿‡æœŸæ—¶é—´ |
| created_by | BIGINT | FK(users) | - | æ“ä½œäººID |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: transaction_id
- INDEX: member_id, type, source, created_at

---

### 4.5 è®¢å•ç›¸å…³è¡¨

#### 4.5.1 ordersï¼ˆè®¢å•è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨è®¢å•ä¸»ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | è®¢å•ID |
| order_no | VARCHAR(32) | NOT NULL, UNIQUE | - | è®¢å•å· |
| store_id | BIGINT | NOT NULL, FK(stores) | - | é—¨åº—ID |
| member_id | BIGINT | FK(members) | - | ä¼šå‘˜ID |
| table_number | VARCHAR(20) | NULL | - | æ¡Œå· |
| order_type | order_type_enum | NOT NULL | dine_in | è®¢å•ç±»å‹ |
| dining_mode | dining_mode_enum | NOT NULL | single | ç”¨é¤æ¨¡å¼ |
| people_count | INTEGER | NULL | - | ç”¨é¤äººæ•° |
| subtotal | DECIMAL(10,2) | NOT NULL | - | å°è®¡ |
| discount_amount | DECIMAL(10,2) | NOT NULL | 0.00 | æŠ˜æ‰£é‡‘é¢ |
| service_fee | DECIMAL(10,2) | NOT NULL | 0.00 | æœåŠ¡è´¹ |
| delivery_fee | DECIMAL(10,2) | NOT NULL | 0.00 | é…é€è´¹ |
| tax_amount | DECIMAL(10,2) | NOT NULL | 0.00 | ç¨è´¹ |
| total_amount | DECIMAL(10,2) | NOT NULL | - | æ€»é‡‘é¢ |
| paid_amount | DECIMAL(10,2) | NOT NULL | 0.00 | å·²ä»˜é‡‘é¢ |
| points_used | INTEGER | NOT NULL | 0 | ä½¿ç”¨çš„ç§¯åˆ† |
| points_earned | INTEGER | NOT NULL | 0 | è·å¾—çš„ç§¯åˆ† |
| coupon_amount | DECIMAL(10,2) | NOT NULL | 0.00 | ä¼˜æƒ åˆ¸é‡‘é¢ |
| member_discount | DECIMAL(10,2) | NOT NULL | 0.00 | ä¼šå‘˜æŠ˜æ‰£ |
| status | order_status_enum | NOT NULL | pending | çŠ¶æ€ |
| payment_status | payment_status_enum | NOT NULL | unpaid | æ”¯ä»˜çŠ¶æ€ |
| payment_method | payment_method_enum | NULL | - | æ”¯ä»˜æ–¹å¼ |
| contact_name | VARCHAR(50) | NULL | - | è”ç³»äººå§“å |
| contact_phone | VARCHAR(20) | NULL | - | è”ç³»ç”µè¯ |
| delivery_address | TEXT | NULL | - | é…é€åœ°å€ |
| estimated_time | INTEGER | NULL | - | é¢„è®¡æ—¶é—´(åˆ†é’Ÿ) |
| actual_time | INTEGER | NULL | - | å®é™…æ—¶é—´(åˆ†é’Ÿ) |
| special_requests | TEXT | NULL | - | ç‰¹æ®Šè¦æ±‚ |
| cancellation_reason | TEXT | NULL | - | å–æ¶ˆåŸå›  |
| refund_reason | TEXT | NULL | - | é€€æ¬¾åŸå›  |
| staff_notes | TEXT | NULL | - | å‘˜å·¥å¤‡æ³¨ |
| rating | SMALLINT | NULL | - | è¯„åˆ†(1-5) |
| review | TEXT | NULL | - | è¯„ä»·å†…å®¹ |
| source | order_source_enum | NOT NULL | pos | è®¢å•æ¥æº |
| channel | VARCHAR(50) | NULL | - | æ¸ é“ |
| priority | order_priority_enum | NOT NULL | normal | ä¼˜å…ˆçº§ |
| kitchen_notes | TEXT | NULL | - | å¨æˆ¿å¤‡æ³¨ |
| is_takeaway | BOOLEAN | NOT NULL | FALSE | æ˜¯å¦å¤–å– |
| is_express | BOOLEAN | NOT NULL | FALSE | æ˜¯å¦åŠ æ€¥ |
| ordered_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | ä¸‹å•æ—¶é—´ |
| confirmed_at | TIMESTAMP | NULL | - | ç¡®è®¤æ—¶é—´ |
| ready_at | TIMESTAMP | NULL | - | å‡†å¤‡å¥½æ—¶é—´ |
| served_at | TIMESTAMP | NULL | - | ä¸Šèœæ—¶é—´ |
| completed_at | TIMESTAMP | NULL | - | å®Œæˆæ—¶é—´ |
| cancelled_at | TIMESTAMP | NULL | - | å–æ¶ˆæ—¶é—´ |
| refunded_at | TIMESTAMP | NULL | - | é€€æ¬¾æ—¶é—´ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: order_no
- INDEX: store_id, member_id, table_number, status, payment_status, order_type, ordered_at, total_amount

**è§¦å‘å™¨**ï¼š
- update_orders_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.5.2 order_itemsï¼ˆè®¢å•æ˜ç»†è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨è®¢å•æ˜ç»†ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | æ˜ç»†ID |
| order_id | BIGINT | NOT NULL, FK(orders) | - | è®¢å•ID |
| item_id | BIGINT | NOT NULL, FK(menu_items) | - | èœå“ID |
| item_name | VARCHAR(100) | NOT NULL | - | èœå“åç§° |
| spec_id | BIGINT | FK(menu_item_specs) | - | è§„æ ¼ID |
| spec_name | VARCHAR(50) | NULL | - | è§„æ ¼åç§° |
| quantity | INTEGER | NOT NULL | - | æ•°é‡ |
| unit_price | DECIMAL(10,2) | NOT NULL | - | å•ä»· |
| total_price | DECIMAL(10,2) | NOT NULL | - | å°è®¡ |
| cost_price | DECIMAL(10,2) | NULL | - | æˆæœ¬ä»· |
| kitchen_status | kitchen_status_enum | NOT NULL | pending | å¨æˆ¿çŠ¶æ€ |
| special_requests | TEXT | NULL | - | ç‰¹æ®Šè¦æ±‚ |
| sort_order | INTEGER | NOT NULL | 0 | æ’åº |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- INDEX: order_id, item_id, kitchen_status

**è§¦å‘å™¨**ï¼š
- update_order_items_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.5.3 order_item_optionsï¼ˆè®¢å•é€‰é¡¹è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨è®¢å•æ˜ç»†çš„é€‰é¡¹ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | é€‰é¡¹ID |
| order_item_id | BIGINT | NOT NULL, FK(order_items) | - | è®¢å•æ˜ç»†ID |
| option_id | BIGINT | NOT NULL, FK(menu_options) | - | é€‰é¡¹ID |
| option_name | VARCHAR(50) | NOT NULL | - | é€‰é¡¹åç§° |
| option_price | DECIMAL(10,2) | NOT NULL | 0.00 | é€‰é¡¹ä»·æ ¼ |
| quantity | INTEGER | NOT NULL | 1 | æ•°é‡ |
| total_price | DECIMAL(10,2) | NOT NULL | 0.00 | å°è®¡ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- INDEX: order_item_id, option_id

#### 4.5.4 order_status_historyï¼ˆè®¢å•çŠ¶æ€å†å²è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨è®¢å•çŠ¶æ€å˜æ›´å†å²

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | å†å²ID |
| order_id | BIGINT | NOT NULL, FK(orders) | - | è®¢å•ID |
| from_status | VARCHAR(20) | NULL | - | åŸçŠ¶æ€ |
| to_status | VARCHAR(20) | NOT NULL | - | æ–°çŠ¶æ€ |
| reason | VARCHAR(255) | NULL | - | å˜æ›´åŸå›  |
| operator_id | BIGINT | FK(users) | - | æ“ä½œäººID |
| operator_name | VARCHAR(50) | NULL | - | æ“ä½œäººå§“å |
| notes | TEXT | NULL | - | å¤‡æ³¨ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- INDEX: order_id, operator_id

---

### 4.6 è¥é”€ç›¸å…³è¡¨

#### 4.6.1 marketing_activitiesï¼ˆè¥é”€æ´»åŠ¨è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨è¥é”€æ´»åŠ¨ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | æ´»åŠ¨ID |
| activity_id | VARCHAR(32) | NOT NULL, UNIQUE | - | æ´»åŠ¨ç¼–å· |
| name | VARCHAR(100) | NOT NULL | - | æ´»åŠ¨åç§° |
| description | TEXT | NULL | - | æ´»åŠ¨æè¿° |
| type | activity_type_enum | NOT NULL | - | æ´»åŠ¨ç±»å‹ |
| status | activity_status_enum | NOT NULL | draft | çŠ¶æ€ |
| banner | VARCHAR(255) | NULL | - | æ´»åŠ¨æ¨ªå¹… |
| start_time | TIMESTAMP | NOT NULL | - | å¼€å§‹æ—¶é—´ |
| end_time | TIMESTAMP | NOT NULL | - | ç»“æŸæ—¶é—´ |
| max_participants | INTEGER | NULL | - | æœ€å¤§å‚ä¸äººæ•° |
| current_participants | INTEGER | NOT NULL | 0 | å½“å‰å‚ä¸äººæ•° |
| target_audience | JSONB | NULL | - | ç›®æ ‡äººç¾¤ |
| conditions | JSONB | NULL | - | å‚ä¸æ¡ä»¶ |
| rewards | JSONB | NULL | - | å¥–åŠ±è®¾ç½® |
| statistics | JSONB | NULL | - | ç»Ÿè®¡æ•°æ® |
| created_by | BIGINT | NOT NULL, FK(users) | - | åˆ›å»ºäººID |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: activity_id
- INDEX: type, status, start_time, end_time, created_by

**è§¦å‘å™¨**ï¼š
- update_marketing_activities_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.6.2 couponsï¼ˆä¼˜æƒ åˆ¸è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ä¼˜æƒ åˆ¸ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | ä¼˜æƒ åˆ¸ID |
| coupon_id | VARCHAR(32) | NOT NULL, UNIQUE | - | ä¼˜æƒ åˆ¸ç¼–å· |
| code | VARCHAR(20) | NOT NULL, UNIQUE | - | ä¼˜æƒ åˆ¸ç  |
| name | VARCHAR(100) | NOT NULL | - | ä¼˜æƒ åˆ¸åç§° |
| description | TEXT | NULL | - | æè¿° |
| type | coupon_type_enum | NOT NULL | - | ç±»å‹ |
| value | DECIMAL(10,2) | NOT NULL | - | é¢å€¼ |
| min_order_amount | DECIMAL(10,2) | NULL | - | æœ€ä½æ¶ˆè´¹é‡‘é¢ |
| max_discount_amount | DECIMAL(10,2) | NULL | - | æœ€å¤§ä¼˜æƒ é‡‘é¢ |
| usage_limit | INTEGER | NULL | - | ä½¿ç”¨æ¬¡æ•°é™åˆ¶ |
| usage_count | INTEGER | NOT NULL | 0 | å·²ä½¿ç”¨æ¬¡æ•° |
| user_limit | INTEGER | NULL | - | æ¯äººé™ç”¨æ¬¡æ•° |
| valid_from | TIMESTAMP | NOT NULL | - | æœ‰æ•ˆå¼€å§‹æ—¶é—´ |
| valid_until | TIMESTAMP | NOT NULL | - | æœ‰æ•ˆç»“æŸæ—¶é—´ |
| status | coupon_status_enum | NOT NULL | active | çŠ¶æ€ |
| target_audience | JSONB | NULL | - | ç›®æ ‡äººç¾¤ |
| applicable_items | JSONB | NULL | - | é€‚ç”¨å•†å“ |
| excluded_items | JSONB | NULL | - | æ’é™¤å•†å“ |
| activity_id | BIGINT | FK(marketing_activities) | - | å…³è”æ´»åŠ¨ID |
| member_id | BIGINT | FK(members) | - | é¢†å–ä¼šå‘˜ID |
| used_at | TIMESTAMP | NULL | - | ä½¿ç”¨æ—¶é—´ |
| used_order_id | VARCHAR(32) | NULL | - | ä½¿ç”¨çš„è®¢å•ID |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: coupon_id, code
- INDEX: type, status, valid_from, valid_until, activity_id, member_id

**è§¦å‘å™¨**ï¼š
- update_coupons_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

---

### 4.7 æ”¯ä»˜ç›¸å…³è¡¨

#### 4.7.1 payment_configsï¼ˆæ”¯ä»˜é…ç½®è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨æ”¯ä»˜æ–¹å¼é…ç½®

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | é…ç½®ID |
| method | payment_config_method_enum | NOT NULL, UNIQUE | - | æ”¯ä»˜æ–¹å¼ |
| name | VARCHAR(100) | NOT NULL | - | é…ç½®åç§° |
| display_name | VARCHAR(100) | NOT NULL | - | æ˜¾ç¤ºåç§° |
| description | TEXT | NULL | - | æè¿° |
| enabled | BOOLEAN | NOT NULL | TRUE | æ˜¯å¦å¯ç”¨ |
| config | JSONB | NOT NULL | - | é…ç½®ä¿¡æ¯ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: method
- INDEX: enabled

**è§¦å‘å™¨**ï¼š
- update_payment_configs_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.7.2 payment_transactionsï¼ˆæ”¯ä»˜äº¤æ˜“è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨æ”¯ä»˜äº¤æ˜“è®°å½•

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | äº¤æ˜“ID |
| transaction_id | VARCHAR(64) | NOT NULL, UNIQUE | - | äº¤æ˜“å· |
| order_id | VARCHAR(32) | NULL | - | å…³è”è®¢å•å· |
| payment_method | payment_method_enum | NOT NULL | - | æ”¯ä»˜æ–¹å¼ |
| amount | DECIMAL(10,2) | NOT NULL | - | é‡‘é¢ |
| currency | VARCHAR(3) | NOT NULL | CNY | è´§å¸ |
| status | payment_transaction_status_enum | NOT NULL | pending | çŠ¶æ€ |
| payment_time | TIMESTAMP | NULL | - | æ”¯ä»˜æ—¶é—´ |
| failure_reason | TEXT | NULL | - | å¤±è´¥åŸå›  |
| external_transaction_id | VARCHAR(128) | NULL | - | å¤–éƒ¨äº¤æ˜“å· |
| gateway_response | JSONB | NULL | - | ç½‘å…³å“åº” |
| refund_amount | DECIMAL(10,2) | NULL | - | é€€æ¬¾é‡‘é¢ |
| refunded_at | TIMESTAMP | NULL | - | é€€æ¬¾æ—¶é—´ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: transaction_id
- INDEX: order_id, payment_method, status, payment_time

**è§¦å‘å™¨**ï¼š
- update_payment_transactions_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.7.3 refund_recordsï¼ˆé€€æ¬¾è®°å½•è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨é€€æ¬¾è®°å½•

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | é€€æ¬¾ID |
| refund_id | VARCHAR(64) | NOT NULL, UNIQUE | - | é€€æ¬¾å· |
| transaction_id | VARCHAR(64) | NOT NULL | - | åŸäº¤æ˜“å· |
| order_id | VARCHAR(32) | NULL | - | è®¢å•å· |
| amount | DECIMAL(10,2) | NOT NULL | - | é€€æ¬¾é‡‘é¢ |
| reason | VARCHAR(255) | NOT NULL | - | é€€æ¬¾åŸå›  |
| status | refund_status_enum | NOT NULL | pending | çŠ¶æ€ |
| processed_at | TIMESTAMP | NULL | - | å¤„ç†æ—¶é—´ |
| failure_reason | TEXT | NULL | - | å¤±è´¥åŸå›  |
| external_refund_id | VARCHAR(128) | NULL | - | å¤–éƒ¨é€€æ¬¾å· |
| gateway_response | JSONB | NULL | - | ç½‘å…³å“åº” |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: refund_id
- INDEX: transaction_id, order_id, status, processed_at

**è§¦å‘å™¨**ï¼š
- update_refund_records_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

---

### 4.8 ç³»ç»Ÿç›¸å…³è¡¨

#### 4.8.1 system_configsï¼ˆç³»ç»Ÿé…ç½®è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ç³»ç»Ÿé…ç½®ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | é…ç½®ID |
| key | VARCHAR(100) | NOT NULL, UNIQUE | - | é…ç½®é”® |
| value | TEXT | NOT NULL | - | é…ç½®å€¼ |
| description | VARCHAR(255) | NULL | - | æè¿° |
| type | config_type_enum | NOT NULL | string | æ•°æ®ç±»å‹ |
| category | VARCHAR(50) | NULL | - | é…ç½®åˆ†ç±» |
| is_public | BOOLEAN | NOT NULL | FALSE | æ˜¯å¦å…¬å¼€ |
| sort_order | INTEGER | NOT NULL | 0 | æ’åº |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: key
- INDEX: category, is_public

**è§¦å‘å™¨**ï¼š
- update_system_configs_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

#### 4.8.2 operation_logsï¼ˆæ“ä½œæ—¥å¿—è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨ç³»ç»Ÿæ“ä½œæ—¥å¿—

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | æ—¥å¿—ID |
| user_id | BIGINT | FK(users) | - | ç”¨æˆ·ID |
| username | VARCHAR(50) | NULL | - | ç”¨æˆ·å |
| action | VARCHAR(100) | NOT NULL | - | æ“ä½œåŠ¨ä½œ |
| resource_type | VARCHAR(50) | NULL | - | èµ„æºç±»å‹ |
| resource_id | BIGINT | NULL | - | èµ„æºID |
| resource_name | VARCHAR(255) | NULL | - | èµ„æºåç§° |
| method | http_method_enum | NULL | - | HTTPæ–¹æ³• |
| path | VARCHAR(255) | NULL | - | è¯·æ±‚è·¯å¾„ |
| ip_address | VARCHAR(45) | NULL | - | IPåœ°å€ |
| user_agent | TEXT | NULL | - | ç”¨æˆ·ä»£ç† |
| request_data | JSONB | NULL | - | è¯·æ±‚æ•°æ® |
| response_data | JSONB | NULL | - | å“åº”æ•°æ® |
| status_code | INTEGER | NULL | - | çŠ¶æ€ç  |
| duration | INTEGER | NULL | - | è€—æ—¶(æ¯«ç§’) |
| error_message | TEXT | NULL | - | é”™è¯¯ä¿¡æ¯ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- INDEX: user_id, action, resource_type, created_at

#### 4.8.3 data_dictionariesï¼ˆæ•°æ®å­—å…¸è¡¨ï¼‰

**è¡¨æè¿°**ï¼šå­˜å‚¨æ•°æ®å­—å…¸ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | AUTO | å­—å…¸ID |
| group_code | VARCHAR(50) | NOT NULL | - | åˆ†ç»„ç¼–ç  |
| group_name | VARCHAR(100) | NOT NULL | - | åˆ†ç»„åç§° |
| item_code | VARCHAR(50) | NOT NULL | - | é¡¹ç›®ç¼–ç  |
| item_name | VARCHAR(100) | NOT NULL | - | é¡¹ç›®åç§° |
| item_value | VARCHAR(255) | NULL | - | é¡¹ç›®å€¼ |
| description | VARCHAR(255) | NULL | - | æè¿° |
| sort_order | INTEGER | NOT NULL | 0 | æ’åº |
| is_active | BOOLEAN | NOT NULL | TRUE | æ˜¯å¦å¯ç”¨ |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: id
- UNIQUE: (group_code, item_code)
- INDEX: group_code, sort_order

**è§¦å‘å™¨**ï¼š
- update_data_dictionaries_updated_at: è‡ªåŠ¨æ›´æ–°updated_atå­—æ®µ

---

## 5. ERå…³ç³»å›¾

### 5.1 æ ¸å¿ƒå…³ç³»å›¾

```
users (ç”¨æˆ·)
  â”œâ”€â”€ user_roles (ç”¨æˆ·è§’è‰²) â”€â”€> roles (è§’è‰²)
  â”œâ”€â”€ user_sessions (ç”¨æˆ·ä¼šè¯)
  â”œâ”€â”€ store_staff (é—¨åº—å‘˜å·¥) <â”€â”€ stores (é—¨åº—)
  â”œâ”€â”€ menu_items (èœå“) <â”€â”€ menu_categories (èœå“åˆ†ç±»)
  â”‚   â”œâ”€â”€ menu_item_specs (èœå“è§„æ ¼)
  â”‚   â””â”€â”€ menu_item_option_relations (èœå“é€‰é¡¹å…³è”) <â”€â”€ menu_option_groups (é€‰é¡¹ç»„)
  â”‚       â””â”€â”€ menu_options (é€‰é¡¹)
  â”œâ”€â”€ members (ä¼šå‘˜) <â”€â”€ member_levels (ä¼šå‘˜ç­‰çº§)
  â”‚   â””â”€â”€ member_points_transactions (ç§¯åˆ†è®°å½•)
  â”œâ”€â”€ orders (è®¢å•)
  â”‚   â”œâ”€â”€ order_items (è®¢å•æ˜ç»†) <â”€â”€ menu_items
  â”‚   â”‚   â””â”€â”€ order_item_options (è®¢å•é€‰é¡¹)
  â”‚   â””â”€â”€ order_status_history (è®¢å•çŠ¶æ€å†å²)
  â”œâ”€â”€ marketing_activities (è¥é”€æ´»åŠ¨)
  â”‚   â””â”€â”€ coupons (ä¼˜æƒ åˆ¸)
  â”œâ”€â”€ payment_transactions (æ”¯ä»˜äº¤æ˜“)
  â”œâ”€â”€ refund_records (é€€æ¬¾è®°å½•)
  â”œâ”€â”€ operation_logs (æ“ä½œæ—¥å¿—)
  â””â”€â”€ member_points_transactions (ç§¯åˆ†è®°å½•)

stores (é—¨åº—)
  â”œâ”€â”€ store_staff (é—¨åº—å‘˜å·¥) â”€â”€> users
  â””â”€â”€ orders (è®¢å•)

members (ä¼šå‘˜)
  â”œâ”€â”€ member_points_transactions (ç§¯åˆ†è®°å½•)
  â””â”€â”€ coupons (ä¼˜æƒ åˆ¸)

orders (è®¢å•)
  â”œâ”€â”€ order_items (è®¢å•æ˜ç»†)
  â”œâ”€â”€ order_status_history (è®¢å•çŠ¶æ€å†å²)
  â””â”€â”€ payment_transactions (æ”¯ä»˜äº¤æ˜“)
      â””â”€â”€ refund_records (é€€æ¬¾è®°å½•)
```

### 5.2 ä¸»è¦å¤–é”®å…³ç³»

| è¡¨å | å¤–é”®å­—æ®µ | å¼•ç”¨è¡¨ | å¼•ç”¨å­—æ®µ | çº§è”è§„åˆ™ |
|------|---------|--------|---------|---------|
| user_roles | user_id | users | id | CASCADE |
| user_roles | role_id | roles | id | CASCADE |
| user_sessions | user_id | users | id | CASCADE |
| store_staff | store_id | stores | id | CASCADE |
| store_staff | user_id | users | id | CASCADE |
| stores | manager_id | users | id | - |
| menu_categories | store_id | stores | id | CASCADE |
| menu_items | category_id | menu_categories | id | - |
| menu_items | store_id | stores | id | CASCADE |
| menu_items | created_by | users | id | - |
| menu_item_specs | item_id | menu_items | id | CASCADE |
| menu_options | group_id | menu_option_groups | id | CASCADE |
| menu_item_option_relations | item_id | menu_items | id | CASCADE |
| menu_item_option_relations | group_id | menu_option_groups | id | CASCADE |
| members | user_id | users | id | CASCADE |
| members | level_id | member_levels | id | - |
| member_points_transactions | member_id | members | id | CASCADE |
| member_points_transactions | created_by | users | id | - |
| orders | store_id | stores | id | - |
| orders | member_id | members | id | - |
| order_items | order_id | orders | id | CASCADE |
| order_items | item_id | menu_items | id | - |
| order_items | spec_id | menu_item_specs | id | - |
| order_item_options | order_item_id | order_items | id | CASCADE |
| order_item_options | option_id | menu_options | id | - |
| order_status_history | order_id | orders | id | CASCADE |
| order_status_history | operator_id | users | id | - |
| marketing_activities | created_by | users | id | - |
| coupons | activity_id | marketing_activities | id | - |
| coupons | member_id | members | id | - |
| payment_transactions | - | orders | order_no | - |
| refund_records | - | payment_transactions | transaction_id | - |
| operation_logs | user_id | users | id | - |

---

## 6. ç´¢å¼•è®¾è®¡

### 6.1 ç´¢å¼•ç­–ç•¥

æ•°æ®åº“é‡‡ç”¨ä»¥ä¸‹ç´¢å¼•ç­–ç•¥ï¼š

1. **ä¸»é”®ç´¢å¼•**ï¼šæ‰€æœ‰è¡¨éƒ½æœ‰ä¸»é”®ç´¢å¼•
2. **å”¯ä¸€ç´¢å¼•**ï¼šç¡®ä¿æ•°æ®å”¯ä¸€æ€§
3. **å¤–é”®ç´¢å¼•**ï¼šä¼˜åŒ–å…³è”æŸ¥è¯¢
4. **æŸ¥è¯¢ç´¢å¼•**ï¼šä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢
5. **å¤åˆç´¢å¼•**ï¼šä¼˜åŒ–å¤šå­—æ®µæŸ¥è¯¢

### 6.2 ç´¢å¼•åˆ—è¡¨

#### ç”¨æˆ·ç›¸å…³è¡¨ç´¢å¼•

```sql
-- users
CREATE UNIQUE INDEX users_username_key ON users(username);
CREATE UNIQUE INDEX users_email_key ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_created_at ON users(created_at);

-- roles
CREATE UNIQUE INDEX roles_name_key ON roles(name);
CREATE INDEX idx_roles_is_system ON roles(is_system);

-- user_roles
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);

-- user_sessions
CREATE UNIQUE INDEX user_sessions_session_token_key ON user_sessions(session_token);
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
```

#### é—¨åº—ç›¸å…³è¡¨ç´¢å¼•

```sql
-- stores
CREATE UNIQUE INDEX stores_store_code_key ON stores(store_code);
CREATE INDEX idx_stores_name ON stores(name);
CREATE INDEX idx_stores_manager_id ON stores(manager_id);
CREATE INDEX idx_stores_status ON stores(status);

-- store_staff
CREATE INDEX idx_store_staff_user_id ON store_staff(user_id);
CREATE INDEX idx_store_staff_position ON store_staff(position);
```

#### èœå•ç›¸å…³è¡¨ç´¢å¼•

```sql
-- menu_categories
CREATE INDEX idx_menu_categories_store_id ON menu_categories(store_id);
CREATE INDEX idx_menu_categories_sort_order ON menu_categories(sort_order);

-- menu_items
CREATE UNIQUE INDEX menu_items_item_code_key ON menu_items(item_code);
CREATE INDEX idx_menu_items_category_id ON menu_items(category_id);
CREATE INDEX idx_menu_items_price ON menu_items(price);
CREATE INDEX idx_menu_items_is_available ON menu_items(is_available);
CREATE INDEX idx_menu_items_is_recommended ON menu_items(is_recommended);
CREATE INDEX idx_menu_items_store_id ON menu_items(store_id);
CREATE INDEX idx_menu_items_created_by ON menu_items(created_by);

-- menu_item_specs
CREATE INDEX idx_menu_item_specs_item_id ON menu_item_specs(item_id);

-- menu_option_groups
CREATE INDEX idx_menu_option_groups_sort_order ON menu_option_groups(sort_order);

-- menu_options
CREATE INDEX idx_menu_options_group_id ON menu_options(group_id);

-- menu_item_option_relations
CREATE INDEX idx_menu_item_option_relations_item_id ON menu_item_option_relations(item_id);
CREATE INDEX idx_menu_item_option_relations_group_id ON menu_item_option_relations(group_id);
```

#### ä¼šå‘˜ç›¸å…³è¡¨ç´¢å¼•

```sql
-- member_levels
CREATE UNIQUE INDEX member_levels_name_key ON member_levels(name);
CREATE INDEX idx_member_levels_min_points ON member_levels(min_points);
CREATE INDEX idx_member_levels_sort_order ON member_levels(sort_order);

-- members
CREATE UNIQUE INDEX members_member_no_key ON members(member_no);
CREATE INDEX idx_members_user_id ON members(user_id);
CREATE INDEX idx_members_phone ON members(phone);
CREATE INDEX idx_members_level_id ON members(level_id);
CREATE INDEX idx_members_points ON members(points);
CREATE INDEX idx_members_total_spent ON members(total_spent);
CREATE INDEX idx_members_status ON members(status);

-- member_points_transactions
CREATE UNIQUE INDEX member_points_transactions_transaction_id_key ON member_points_transactions(transaction_id);
CREATE INDEX idx_member_points_transactions_member_id ON member_points_transactions(member_id);
CREATE INDEX idx_member_points_transactions_type ON member_points_transactions(type);
CREATE INDEX idx_member_points_transactions_source ON member_points_transactions(source);
CREATE INDEX idx_member_points_transactions_created_at ON member_points_transactions(created_at);
```

#### è®¢å•ç›¸å…³è¡¨ç´¢å¼•

```sql
-- orders
CREATE UNIQUE INDEX orders_order_no_key ON orders(order_no);
CREATE INDEX idx_orders_store_id ON orders(store_id);
CREATE INDEX idx_orders_member_id ON orders(member_id);
CREATE INDEX idx_orders_table_number ON orders(table_number);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_payment_status ON orders(payment_status);
CREATE INDEX idx_orders_order_type ON orders(order_type);
CREATE INDEX idx_orders_ordered_at ON orders(ordered_at);
CREATE INDEX idx_orders_total_amount ON orders(total_amount);

-- order_items
CREATE INDEX idx_order_items_order_id ON order_items(order_id);
CREATE INDEX idx_order_items_item_id ON order_items(item_id);
CREATE INDEX idx_order_items_kitchen_status ON order_items(kitchen_status);

-- order_item_options
CREATE INDEX idx_order_item_options_order_item_id ON order_item_options(order_item_id);
CREATE INDEX idx_order_item_options_option_id ON order_item_options(option_id);

-- order_status_history
CREATE INDEX idx_order_status_history_order_id ON order_status_history(order_id);
CREATE INDEX idx_order_status_history_operator_id ON order_status_history(operator_id);
```

#### è¥é”€ç›¸å…³è¡¨ç´¢å¼•

```sql
-- marketing_activities
CREATE UNIQUE INDEX marketing_activities_activity_id_key ON marketing_activities(activity_id);
CREATE INDEX idx_marketing_activities_type ON marketing_activities(type);
CREATE INDEX idx_marketing_activities_status ON marketing_activities(status);
CREATE INDEX idx_marketing_activities_start_time ON marketing_activities(start_time);
CREATE INDEX idx_marketing_activities_end_time ON marketing_activities(end_time);
CREATE INDEX idx_marketing_activities_created_by ON marketing_activities(created_by);

-- coupons
CREATE UNIQUE INDEX coupons_coupon_id_key ON coupons(coupon_id);
CREATE UNIQUE INDEX coupons_code_key ON coupons(code);
CREATE INDEX idx_coupons_type ON coupons(type);
CREATE INDEX idx_coupons_status ON coupons(status);
CREATE INDEX idx_coupons_valid_from ON coupons(valid_from);
CREATE INDEX idx_coupons_valid_until ON coupons(valid_until);
CREATE INDEX idx_coupons_activity_id ON coupons(activity_id);
CREATE INDEX idx_coupons_member_id ON coupons(member_id);
```

#### æ”¯ä»˜ç›¸å…³è¡¨ç´¢å¼•

```sql
-- payment_configs
CREATE UNIQUE INDEX payment_configs_method_key ON payment_configs(method);
CREATE INDEX idx_payment_configs_enabled ON payment_configs(enabled);

-- payment_transactions
CREATE UNIQUE INDEX payment_transactions_transaction_id_key ON payment_transactions(transaction_id);
CREATE INDEX idx_payment_transactions_order_id ON payment_transactions(order_id);
CREATE INDEX idx_payment_transactions_payment_method ON payment_transactions(payment_method);
CREATE INDEX idx_payment_transactions_status ON payment_transactions(status);
CREATE INDEX idx_payment_transactions_payment_time ON payment_transactions(payment_time);

-- refund_records
CREATE UNIQUE INDEX refund_records_refund_id_key ON refund_records(refund_id);
CREATE INDEX idx_refund_records_transaction_id ON refund_records(transaction_id);
CREATE INDEX idx_refund_records_order_id ON refund_records(order_id);
CREATE INDEX idx_refund_records_status ON refund_records(status);
CREATE INDEX idx_refund_records_processed_at ON refund_records(processed_at);
```

#### ç³»ç»Ÿç›¸å…³è¡¨ç´¢å¼•

```sql
-- system_configs
CREATE UNIQUE INDEX system_configs_key_key ON system_configs(key);
CREATE INDEX idx_system_configs_category ON system_configs(category);
CREATE INDEX idx_system_configs_is_public ON system_configs(is_public);

-- operation_logs
CREATE INDEX idx_operation_logs_user_id ON operation_logs(user_id);
CREATE INDEX idx_operation_logs_action ON operation_logs(action);
CREATE INDEX idx_operation_logs_resource_type ON operation_logs(resource_type);
CREATE INDEX idx_operation_logs_created_at ON operation_logs(created_at);

-- data_dictionaries
CREATE INDEX idx_data_dictionaries_group_code ON data_dictionaries(group_code);
CREATE INDEX idx_data_dictionaries_sort_order ON data_dictionaries(sort_order);
```

---

## 7. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### 7.1 æŸ¥è¯¢ä¼˜åŒ–

1. **ä½¿ç”¨EXPLAIN ANALYZE**ï¼šåˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
2. **é¿å…SELECT ***ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
3. **ä½¿ç”¨ç´¢å¼•**ï¼šç¡®ä¿æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•
4. **åˆ†é¡µæŸ¥è¯¢**ï¼šä½¿ç”¨LIMITå’ŒOFFSET
5. **æ‰¹é‡æ“ä½œ**ï¼šä½¿ç”¨æ‰¹é‡æ’å…¥å’Œæ›´æ–°

### 7.2 è¿æ¥æ± é…ç½®

```javascript
const pool = new Pool({
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  max: 20,              // æœ€å¤§è¿æ¥æ•°
  idleTimeoutMillis: 30000,  // ç©ºé—²è¿æ¥è¶…æ—¶
  connectionTimeoutMillis: 2000,  // è¿æ¥è¶…æ—¶
});
```

### 7.3 å®šæœŸç»´æŠ¤

1. **VACUUM**ï¼šæ¸…ç†æ­»å…ƒç»„
2. **ANALYZE**ï¼šæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
3. **REINDEX**ï¼šé‡å»ºç´¢å¼•
4. **CLUSTER**ï¼šèšç°‡è¡¨

```sql
-- æ¯å‘¨æ‰§è¡Œ
VACUUM ANALYZE;

-- æ¯æœˆæ‰§è¡Œ
REINDEX DATABASE yyc3_catering;
```

### 7.4 åˆ†åŒºè¡¨

å¯¹äºå¤§è¡¨ï¼ˆå¦‚ordersã€operation_logsï¼‰ï¼Œè€ƒè™‘ä½¿ç”¨åˆ†åŒºè¡¨ï¼š

```sql
-- æŒ‰æœˆåˆ†åŒºè®¢å•è¡¨
CREATE TABLE orders_2025_01 PARTITION OF orders
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

---

## 8. æ•°æ®åº“å®‰å…¨

### 8.1 è®¿é—®æ§åˆ¶

1. **æœ€å°æƒé™åŸåˆ™**ï¼šç”¨æˆ·åªæ‹¥æœ‰å¿…è¦çš„æƒé™
2. **è§’è‰²åˆ†ç¦»**ï¼šè¯»å†™åˆ†ç¦»ã€ç®¡ç†åˆ†ç¦»
3. **IPç™½åå•**ï¼šé™åˆ¶è®¿é—®IP
4. **SSLè¿æ¥**ï¼šä½¿ç”¨åŠ å¯†è¿æ¥

### 8.2 æ•°æ®åŠ å¯†

1. **å¯†ç åŠ å¯†**ï¼šä½¿ç”¨bcryptåŠ å¯†å¯†ç 
2. **æ•æ„Ÿæ•°æ®åŠ å¯†**ï¼šä½¿ç”¨pgcryptoåŠ å¯†æ•æ„Ÿå­—æ®µ
3. **ä¼ è¾“åŠ å¯†**ï¼šä½¿ç”¨SSL/TLSåŠ å¯†ä¼ è¾“

```sql
-- å¯ç”¨pgcryptoæ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†æ•æ„Ÿæ•°æ®
SELECT encrypt('sensitive_data', 'encryption_key', 'aes');
```

### 8.3 å®¡è®¡æ—¥å¿—

æ‰€æœ‰é‡è¦æ“ä½œéƒ½è®°å½•åœ¨operation_logsè¡¨ä¸­ï¼š

- ç”¨æˆ·ç™»å½•/ç™»å‡º
- æ•°æ®åˆ›å»º/ä¿®æ”¹/åˆ é™¤
- æƒé™å˜æ›´
- æ•æ„Ÿæ“ä½œ

### 8.4 å¤‡ä»½ç­–ç•¥

1. **æ¯æ—¥å¤‡ä»½**ï¼šå…¨é‡å¤‡ä»½
2. **å®æ—¶å¤‡ä»½**ï¼šWALå½’æ¡£
3. **å¼‚åœ°å¤‡ä»½**ï¼šäº‘å­˜å‚¨å¤‡ä»½
4. **å®šæœŸæ¢å¤æµ‹è¯•**ï¼šç¡®ä¿å¤‡ä»½å¯ç”¨

```bash
# æ¯æ—¥å…¨é‡å¤‡ä»½
pg_dump -h localhost -U yanyu yyc3_catering > backup_$(date +%Y%m%d).sql

# WALå½’æ¡£é…ç½®
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'
```

---

## 9. è¿ç§»ç®¡ç†

### 9.1 è¿ç§»æ–‡ä»¶å‘½å

è¿ç§»æ–‡ä»¶å‘½åæ ¼å¼ï¼š`{version}_{name}.sql`

ç¤ºä¾‹ï¼š
- `001_init_postgresql.sql`
- `002_add_user_preferences.sql`
- `003_update_order_status.sql`

### 9.2 è¿ç§»ç®¡ç†å·¥å…·ä½¿ç”¨

```bash
# æ‰§è¡Œæ‰€æœ‰å¾…æ‰§è¡Œçš„è¿ç§»
npx tsx backend/database/migration-manager.ts migrate

# å›æ»šæœ€åä¸€ä¸ªè¿ç§»
npx tsx backend/database/migration-manager.ts rollback

# å›æ»šæŒ‡å®šç‰ˆæœ¬çš„è¿ç§»
npx tsx backend/database/migration-manager.ts rollback 001

# æ˜¾ç¤ºè¿ç§»çŠ¶æ€
npx tsx backend/database/migration-manager.ts status

# åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶
npx tsx backend/database/migration-manager.ts create add_new_feature
```

### 9.3 è¿ç§»æœ€ä½³å®è·µ

1. **å¹‚ç­‰æ€§**ï¼šè¿ç§»è„šæœ¬å¯ä»¥é‡å¤æ‰§è¡Œ
2. **äº‹åŠ¡æ€§**ï¼šä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
3. **å¯å›æ»š**ï¼šæä¾›å›æ»šè„šæœ¬
4. **æµ‹è¯•**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå…ˆæ‰§è¡Œ
5. **æ–‡æ¡£**ï¼šè®°å½•è¿ç§»å†…å®¹å’Œå½±å“

---

## ğŸ“„ æ–‡æ¡£æ ‡å°¾ (Footer)

> ã€Œ***YanYuCloudCube***ã€
> ã€Œ***<admin@0379.email>***ã€
> ã€Œ***Words Initiate Quadrants, Language Serves as Core for the Future***ã€
> ã€Œ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***ã€
