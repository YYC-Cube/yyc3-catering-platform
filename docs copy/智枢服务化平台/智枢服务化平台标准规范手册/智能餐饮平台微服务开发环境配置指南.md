# 智能餐饮平台微服务开发环境配置指南

## 1. 环境概述

本文档详细介绍了智能餐饮平台微服务架构的开发环境搭建和配置步骤，包括基础设施服务（服务注册与发现、配置中心、消息队列等）的部署与使用。

### 1.1 技术栈

| 服务类型 | 技术选型 | 版本 | 端口 |
|---------|---------|-----|-----|
| 服务注册与发现 | Consul | 1.15.4 | 8500 |
| 配置中心 | Nacos | 2.2.3 | 8848 |
| 消息队列 | RabbitMQ | 3.12.10 | 5672/15672 |
| 分布式流处理 | Kafka | 7.5.3 | 9092/29092 |
| 缓存 | Redis | 7.2.3 | 6379 |
| 数据库 | MySQL | 8.0.35 | 3306 |
| 日志收集 | ELK Stack | 8.11.3 | 9200/5601/5044 |
| 监控系统 | Prometheus+Grafana | 2.47.2/10.2.2 | 9090/3000 |
| API网关 | Express.js | - | 3200 |

## 2. 环境搭建

### 2.1 依赖安装

1. **Docker**：确保已安装Docker 20.10+和Docker Compose 2.0+
2. **Node.js**：推荐使用Node.js 18.18+，使用nvm管理版本
3. **npm/pnpm**：包管理工具，推荐使用pnpm
4. **Git**：版本控制工具
5. **IDE**：推荐使用VS Code，安装相关插件

### 2.2 快速启动

使用Docker Compose一键启动所有基础设施服务：

```bash
# 在项目根目录执行
docker-compose up -d
```

### 2.3 服务访问

启动完成后，可以通过以下地址访问各服务：

| 服务名称 | 访问地址 | 用户名 | 密码 |
|---------|---------|------|------|
| Consul | http://localhost:8500 | - | - |
| Nacos | http://localhost:8848 | nacos | nacos |
| RabbitMQ | http://localhost:15672 | admin | 123456 |
| MySQL | localhost:3306 | root | 123456 |
| Redis | localhost:6379 | - | 123456 |
| Elasticsearch | http://localhost:9200 | - | - |
| Kibana | http://localhost:5601 | - | - |
| Prometheus | http://localhost:9090 | - | - |
| Grafana | http://localhost:3000 | admin | admin |
| API网关 | http://localhost:3200 | - | - |

## 3. 基础设施配置

### 3.1 服务注册与发现 (Consul)

**配置文件**：`docker-compose.yaml` 中的 `consul` 服务配置

**主要功能**：
- 服务注册与发现
- 健康检查
- 分布式锁
- 配置管理

**使用示例**：

```javascript
// 服务注册示例（Node.js）
const { Consul } = require('consul');

const consul = new Consul({
  host: 'localhost',
  port: 8500
});

// 注册服务
const service = {
  name: 'user-service',
  id: 'user-service-1',
  address: 'localhost',
  port: 3201,
  tags: ['user', 'api'],
  check: {
    http: 'http://localhost:3201/health',
    interval: '10s',
    timeout: '5s'
  }
};

consul.agent.service.register(service, (err) => {
  if (err) throw err;
  console.log('Service registered with Consul');
});
```

### 3.2 配置中心 (Nacos)

**配置文件**：`docker-compose.yaml` 中的 `nacos` 服务配置

**主要功能**：
- 动态配置管理
- 服务配置隔离
- 配置版本控制
- 配置监听与推送

**使用示例**：

1. 访问Nacos控制台：http://localhost:8848
2. 创建命名空间：`yyc3-catering`
3. 创建配置：
   - Data ID: `user-service-dev.yaml`
   - Group: `DEFAULT_GROUP`
   - 配置内容：
     ```yaml
     server:
       port: 3201
     database:
       host: mysql
       port: 3306
       username: root
       password: 123456
       database: yyc3_catering
     ```

### 3.3 消息队列 (RabbitMQ)

**配置文件**：`docker-compose.yaml` 中的 `rabbitmq` 服务配置

**主要功能**：
- 异步通信
- 消息持久化
- 发布/订阅模式
- 消息确认机制

**使用示例**：

```javascript
// 消息生产者示例
const amqp = require('amqplib');

async function produce() {
  const connection = await amqp.connect('amqp://admin:123456@localhost:5672/yyc3');
  const channel = await connection.createChannel();
  
  const queue = 'order.created';
  await channel.assertQueue(queue, { durable: true });
  
  const message = { orderId: '123456', total: 100.5 };
  channel.sendToQueue(queue, Buffer.from(JSON.stringify(message)), { persistent: true });
  
  console.log('Message sent:', message);
  
  setTimeout(() => {
    connection.close();
  }, 500);
}

produce().catch(console.error);
```

### 3.4 缓存 (Redis)

**配置文件**：`docker-compose.yaml` 中的 `redis` 服务配置

**主要功能**：
- 数据缓存
- 分布式锁
- 会话管理
- 消息队列

**使用示例**：

```javascript
// Redis客户端示例
const Redis = require('ioredis');

const redis = new Redis({
  host: 'localhost',
  port: 6379,
  password: '123456'
});

// 设置缓存
await redis.set('user:123', JSON.stringify({ id: 123, name: '张三' }), 'EX', 3600);

// 获取缓存
const user = await redis.get('user:123');
console.log(JSON.parse(user));
```

### 3.5 数据库 (MySQL)

**配置文件**：`docker-compose.yaml` 中的 `mysql` 服务配置

**主要功能**：
- 关系型数据存储
- 事务支持
- 高可用配置

**使用示例**：

```javascript
// MySQL连接示例
const mysql = require('mysql2/promise');

const connection = await mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: '123456',
  database: 'yyc3_catering'
});

const [rows] = await connection.execute('SELECT * FROM users WHERE id = ?', [123]);
console.log(rows);
```

## 4. 微服务开发规范

### 4.1 项目结构

```
backend/
├── services/
│   ├── user-service/          # 用户服务
│   │   ├── src/
│   │   │   ├── controllers/    # 控制器
│   │   │   ├── models/         # 数据模型
│   │   │   ├── services/       # 业务逻辑
│   │   │   ├── routes/         # 路由
│   │   │   ├── config/         # 配置
│   │   │   ├── middleware/     # 中间件
│   │   │   └── index.js        # 入口文件
│   │   ├── package.json
│   │   ├── Dockerfile
│   │   └── README.md
│   ├── menu-service/          # 菜单服务
│   └── ...
├── gateway/                   # API网关
├── common/                    # 公共服务
├── shared/                    # 共享类型
└── database/                  # 数据库相关
```

### 4.2 环境变量

每个微服务应使用统一的环境变量命名规范：

```
# 服务基本配置
NODE_ENV=development
PORT=3201

# 服务注册与发现
CONSUL_HOST=localhost
CONSUL_PORT=8500

# 配置中心
NACOS_HOST=localhost
NACOS_PORT=8848
NACOS_NAMESPACE=yyc3-catering

# 数据库
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_USER=root
DATABASE_PASSWORD=123456
DATABASE_NAME=yyc3_catering

# 缓存
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=123456

# 消息队列
RABBITMQ_HOST=localhost
RABBITMQ_PORT=5672
RABBITMQ_USER=admin
RABBITMQ_PASSWORD=123456
RABBITMQ_VHOST=/yyc3
```

### 4.3 启动脚本

每个微服务应提供统一的启动脚本：

```json
// package.json
{
  "scripts": {
    "dev": "nodemon src/index.js",
    "start": "node src/index.js",
    "build": "tsc",
    "test": "jest",
    "lint": "eslint .",
    "health": "curl http://localhost:3201/health"
  }
}
```

## 5. 开发工作流

### 5.1 新服务创建流程

1. **创建服务目录**：在 `backend/services/` 下创建服务目录
2. **初始化项目**：使用模板初始化项目结构
3. **配置文件**：创建 `package.json`、`Dockerfile` 等配置文件
4. **服务注册**：在 `docker-compose.yaml` 中添加服务配置
5. **启动服务**：使用 `docker-compose up -d <service-name>` 启动服务
6. **健康检查**：访问 `/health` 端点检查服务状态

### 5.2 开发调试

1. **本地调试**：使用 `npm run dev` 在本地启动服务
2. **容器调试**：使用 Docker 挂载本地目录进行调试
3. **日志查看**：使用 `docker logs -f <container-name>` 查看服务日志
4. **监控**：使用 Prometheus 和 Grafana 监控服务状态

## 6. 常见问题

### 6.1 端口冲突

如果遇到端口冲突问题，可以在 `docker-compose.yaml` 中修改端口映射：

```yaml
# 原配置
ports:
  - "3200:3200"

# 修改后的配置
ports:
  - "3201:3200"
```

### 6.2 服务启动失败

1. 检查服务依赖是否正常启动
2. 查看服务日志定位问题：`docker logs -f <container-name>`
3. 检查环境变量配置是否正确
4. 检查数据库连接是否正常

### 6.3 数据持久化

所有需要持久化的数据都应该存储在挂载的卷中，避免容器重启数据丢失：

```yaml
volumes:
  - mysql-data:/var/lib/mysql
```

## 7. 环境清理

停止所有服务：

```bash
docker-compose down
```

清理所有数据（谨慎使用）：

```bash
docker-compose down -v
```

## 8. 扩展阅读

- [Docker官方文档](https://docs.docker.com/)
- [Consul官方文档](https://www.consul.io/docs)
- [Nacos官方文档](https://nacos.io/zh-cn/docs/)
- [RabbitMQ官方文档](https://www.rabbitmq.com/documentation.html)
- [Redis官方文档](https://redis.io/documentation)
- [MySQL官方文档](https://dev.mysql.com/doc/)
